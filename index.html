from pathlib import Path
import textwrap

symbols = [
"H","He","Li","Be","B","C","N","O","F","Ne","Na","Mg","Al","Si","P","S","Cl","Ar",
"K","Ca","Sc","Ti","V","Cr","Mn","Fe","Co","Ni","Cu","Zn","Ga","Ge","As","Se","Br","Kr",
"Rb","Sr","Y","Zr","Nb","Mo","Tc","Ru","Rh","Pd","Ag","Cd","In","Sn","Sb","Te","I","Xe",
"Cs","Ba","La","Ce","Pr","Nd","Pm","Sm","Eu","Gd","Tb","Dy","Ho","Er","Tm","Yb","Lu",
"Hf","Ta","W","Re","Os","Ir","Pt","Au","Hg","Tl","Pb","Bi","Po","At","Rn",
"Fr","Ra","Ac","Th","Pa","U","Np","Pu","Am","Cm","Bk","Cf","Es","Fm","Md","No","Lr",
"Rf","Db","Sg","Bh","Hs","Mt","Ds","Rg","Cn","Nh","Fl","Mc","Lv","Ts","Og"
]

names = [
"Hydrogen","Helium","Lithium","Beryllium","Boron","Carbon","Nitrogen","Oxygen","Fluorine","Neon",
"Sodium","Magnesium","Aluminium","Silicon","Phosphorus","Sulfur","Chlorine","Argon",
"Potassium","Calcium","Scandium","Titanium","Vanadium","Chromium","Manganese","Iron","Cobalt","Nickel","Copper","Zinc",
"Gallium","Germanium","Arsenic","Selenium","Bromine","Krypton",
"Rubidium","Strontium","Yttrium","Zirconium","Niobium","Molybdenum","Technetium","Ruthenium","Rhodium","Palladium","Silver","Cadmium",
"Indium","Tin","Antimony","Tellurium","Iodine","Xenon",
"Cesium","Barium","Lanthanum","Cerium","Praseodymium","Neodymium","Promethium","Samarium","Europium","Gadolinium","Terbium","Dysprosium","Holmium","Erbium","Thulium","Ytterbium","Lutetium",
"Hafnium","Tantalum","Tungsten","Rhenium","Osmium","Iridium","Platinum","Gold","Mercury","Thallium","Lead","Bismuth","Polonium","Astatine","Radon",
"Francium","Radium","Actinium","Thorium","Protactinium","Uranium","Neptunium","Plutonium","Americium","Curium","Berkelium","Californium","Einsteinium","Fermium","Mendelevium","Nobelium","Lawrencium",
"Rutherfordium","Dubnium","Seaborgium","Bohrium","Hassium","Meitnerium","Darmstadtium","Roentgenium","Copernicium","Nihonium","Flerovium","Moscovium","Livermorium","Tennessine","Oganesson"
]

# Build the HTML content
html = f"""<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Electron Towers — v0.16-stable (rollback)</title>
  <style>
:root{{
  --kahoot-blue:#1368ce;--kahoot-green:#26890c;--unit-border:#5e2bb0;--tile:48px;
}}
*{{box-sizing:border-box}} html,body{{height:100%}} body{{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,'Noto Sans',sans-serif;background:linear-gradient(180deg,#46178f 0%,#2e0b5b 60%,#1f083f 100%);color:#fff}}
.hidden{{display:none!important}}
.app-header{{display:flex;align-items:center;justify-content:space-between;padding:14px 18px;border-bottom:3px solid var(--kahoot-blue);background:#350d6aee;position:sticky;top:0;z-index:30}}
.brand h1{{margin:0;font-size:22px}} .subtitle{{margin:2px 0 0;opacity:.9;font-size:12px}}
.btn{{background:var(--kahoot-blue);color:#fff;border:none;padding:10px 12px;border-radius:10px;cursor:pointer;font-weight:800}} .btn.primary{{background:var(--kahoot-green)}} .btn.ghost{{background:transparent;border:2px solid var(--unit-border)}}
.main{{display:flex;flex-direction:column;gap:16px;padding:12px 14px}}
.hero-ptable{{background:#240a49;border:2px solid var(--unit-border);border-radius:12px;padding:10px}}
.toolbar{{display:flex;align-items:center;gap:12px;flex-wrap:wrap;justify-content:space-between;margin:4px 0 10px}}
.toolbar .group{{display:flex;align-items:center;gap:8px}} .toolbar .group.grow{{flex:1;min-width:220px}} .lbl{{font-weight:800;color:#ffe882}}
.search{{width:100%;max-width:420px;padding:10px;border:2px solid var(--unit-border);border-radius:10px;background:#1c0e3a;color:#fff}}
.legend{{display:flex;align-items:center;gap:6px}} .legend .dot{{width:14px;height:14px;border-radius:4px;display:inline-block;border:2px solid #fff3}} .legend .dot.s{{background:#2c7be5}} .legend .dot.p{{background:#f2c31f;color:#231f20}} .legend .dot.d{{background:#8f5af7}} .legend .dot.f{{background:#fb6e6e}}
.seg{{display:inline-flex;background:#1a0a35;border:2px solid var(--unit-border);border-radius:12px;padding:3px}} .seg-btn{{background:transparent;color:#fff;border:none;padding:8px 12px;border-radius:10px;font-weight:800;cursor:pointer}} .seg-btn.active{{background:var(--kahoot-green)}}
.ptable-wrapper{{overflow:auto;border:2px solid var(--unit-border);border-radius:12px;background:#1a0a35;padding:8px}}
.ptable{{position:relative;display:grid;grid-template-columns:36px repeat(32,var(--tile));grid-auto-rows:calc(var(--tile)*1.15);gap:6px;padding:6px;min-width:calc(36px + 32*var(--tile))}}
.ptile{{position:relative;border-radius:10px;border:2px solid transparent;display:flex;align-items:center;justify-content:center;flex-direction:column;cursor:pointer;user-select:none;font-weight:900}} .ptile .sym{{font-size:calc(var(--tile)*.32);line-height:1}} .ptile .z{{position:absolute;top:2px;left:4px;font-size:calc(var(--tile)*.22);opacity:.9}}
.ptile.s{{background:#2c7be5}} .ptile.p{{background:#f2c31f;color:#231f20}} .ptile.d{{background:#8f5af7}} .ptile.f{{background:#fb6e6e}}
.ptile:hover{{transform:translateY(-2px);box-shadow:0 4px 0 0 rgba(0,0,0,.25)}} .ptile.selected{{border-color:#fff;box-shadow:0 0 0 3px rgba(255,255,255,.45) inset}}
.block-overlay{{border:2px dashed #ffe882;border-radius:12px;display:flex;align-items:flex-start;justify-content:flex-start;padding:4px;pointer-events:none;z-index:0}} .block-overlay label{{background:#350d6a;padding:2px 6px;border-radius:8px;font-size:calc(var(--tile)*.22);color:#ffe882}}
.toolbar.bottom{{display:flex;align-items:center;gap:12px;justify-content:space-between;margin-top:10px}}
.current-pick{{font-weight:900;color:#ffe882}} .mini{{color:#e7d7ff;font-size:12px}} .stat{{display:inline-flex;gap:6px;align-items:center}}
.below-ptable{{display:grid;grid-template-columns:360px 1fr;gap:16px;margin-top:12px}}
.sidebar{{display:flex;flex-direction:column;gap:16px}}
.panel{{background:#3a1276;border:2px solid var(--unit-border);border-radius:12px;padding:14px}} .panel h2{{margin:0 0 10px 0;font-size:16px}}
.score .score-num{{font-size:36px;font-weight:800;color:#ffe882;text-shadow:0 2px 0 #00000040}}
.game-area{{display:grid;grid-template-columns:40px 1fr;gap:12px;align-items:start}}
.energy-axis{{display:flex;align-items:flex-start;justify-content:center;padding-top:8px}} .energy-axis span{{writing-mode:vertical-rl;transform:rotate(180deg);color:#ffe882;font-weight:900;letter-spacing:.5px}}
.game-col{{display:flex;flex-direction:column;gap:14px}}
.toast{{position:fixed;top:80px;right:20px;padding:10px 12px;background:#2b0a55;border:2px solid var(--unit-border);border-radius:8px;display:none;z-index:40}} .toast.show{{display:block}}
.building{{display:flex;flex-direction:column-reverse;background:radial-gradient(1200px 400px at 50% -50px,#4b1bb3 0%,#2a0d6a 60%);border:2px solid var(--unit-border);border-radius:12px;padding:14px;min-height:420px}}
.floor{{border:2px dashed #6c33cf;border-radius:10px;padding:12px;margin:12px 0;background:#3a1276aa}} .floor-label{{font-weight:900;color:#ffe882;margin-bottom:8px}}
.wings{{display:grid;grid-template-columns:1fr;grid-auto-rows:minmax(84px,auto);gap:14px;align-items:stretch}}
.wing{{background:#240a49;border:2px solid var(--unit-border);border-radius:10px;padding:10px;position:relative}}
/* Explicit row mapping per shell (energy high→low) */
.floor[data-n="2"] .wing-p{{ grid-row: 1; }} .floor[data-n="2"] .wing-s{{ grid-row: 2; }}
.floor[data-n="3"] .wing-f, .floor[data-n="4"] .wing-f, .floor[data-n="5"] .wing-f, .floor[data-n="6"] .wing-f, .floor[data-n="7"] .wing-f{{ grid-row: 1; }}
.floor[data-n="3"] .wing-d, .floor[data-n="4"] .wing-d, .floor[data-n="5"] .wing-d, .floor[data-n="6"] .wing-d, .floor[data-n="7"] .wing-d{{ grid-row: 2; }}
.floor[data-n="3"] .wing-p, .floor[data-n="4"] .wing-p, .floor[data-n="5"] .wing-p, .floor[data-n="6"] .wing-p, .floor[data-n="7"] .wing-p{{ grid-row: 3; }}
.floor[data-n="3"] .wing-s, .floor[data-n="4"] .wing-s, .floor[data-n="5"] .wing-s, .floor[data-n="6"] .wing-s, .floor[data-n="7"] .wing-s{{ grid-row: 4; }}
.wing-title{{color:#fff;font-size:14px;margin-bottom:8px;display:flex;align-items:center;gap:8px}}
.units{{display:flex;gap:10px;flex-wrap:wrap}}
.unit{{width:140px;min-height:86px;background:#1b0a38;border:2px solid #7a46e0;border-radius:10px;padding:8px;position:relative}}
.unit.ghost{{box-shadow:0 0 0 3px rgba(242,195,31,.45) inset,0 0 12px rgba(242,195,31,.35)}}
.unit.invalid{{animation:shake .2s linear 1;border-color:#d61e2a}}
@keyframes shake{{0%{{transform:translateX(0)}}25%{{transform:translateX(-2px)}}50%{{transform:translateX(2px)}}75%{{transform:translateX(-1px)}}100%{{transform:translateX(0)}}}}
@keyframes pulse{{0%{{box-shadow:0 0 0 0 rgba(242,195,31,.8);transform:scale(1)}}70%{{box-shadow:0 0 0 8px rgba(242,195,31,0);transform:scale(1.04)}}100%{{box-shadow:0 0 0 0 rgba(242,195,31,0);transform:scale(1)}}}}
.slot.ghost-slot{{animation:pulse 1.2s ease-in-out infinite;border-color:#ffe882}}
.unit-label{{position:absolute;top:6px;right:8px;font-size:12px;color:#ffe882}}
.slots{{display:flex;gap:8px;margin-top:22px;flex-wrap:wrap}}
.slot{{width:34px;height:34px;border-radius:50%;background:#170634;border:2px solid #8c5cff;display:flex;align-items:center;justify-content:center;color:#ffffff;font-weight:900;font-size:16px;cursor:pointer}}
.lobby{{background:#3a1276;border:2px solid var(--unit-border);border-radius:12px;padding:12px}}
.lobby-title{{font-weight:900;margin-bottom:8px}}
.lobby-area{{min-height:70px;display:flex;align-items:center;gap:10px;padding:8px;border:2px dashed #8c5cff;border-radius:10px;background:#240a49}}
.electron{{width:46px;height:46px;border-radius:50%;background:#19043a;border:3px solid #8c5cff;display:flex;align-items:center;justify-content:center;color:#ffffff;font-weight:900;user-select:none}}
.electron[draggable="true"]{{cursor:grab}} .electron:active{{cursor:grabbing}} .electron.up{{border-color:#26890c}} .electron.down{{border-color:#d61e2a}}
.lobby-actions{{display:flex;align-items:center;gap:10px;margin-top:10px}} .queue-info{{margin-left:auto;color:#ffe882}}
.app-footer{{text-align:center;padding:14px;color:#ffe882;border-top:3px solid var(--kahoot-blue);background:#350d6a;margin-top:10px}}
.group-label{{align-self:end;justify-self:center;font-weight:900;font-size:calc(var(--tile)*.22);color:#ffe882;opacity:.9}}
.group-label.small{{font-size:12px;opacity:.75}} .period-label{{align-self:center;justify-self:center;font-weight:900;font-size:calc(var(--tile)*.28);color:#ffe882;opacity:.9;border:2px solid #6c33cf;border-radius:8px;padding:2px 4px;background:#1a0a35}}
@media (max-width:980px){{.below-ptable{{grid-template-columns:1fr}} .game-area{{grid-template-columns:24px 1fr}}}}
@media (max-width: 1024px){{ :root{{ --tile:44px; }} }}
@media (max-width: 820px){{ :root{{ --tile:40px; }} }}
@media (max-width: 600px){{ :root{{ --tile:36px; }} }}
@media (max-width: 430px){{ :root{{ --tile:32px; }} }}
html, body{{ -webkit-text-size-adjust: 100%; }} * {{ -webkit-tap-highlight-color: rgba(0,0,0,0); }} .ptile {{ touch-action: manipulation; }}
  </style>
</head>
<body>
  <header class="app-header">
    <div class="brand">
      <h1>🏢 Electron Towers</h1>
      <p class="subtitle">v0.16-stable rollback — no experimental patches</p>
    </div>
    <div class="right">
      <button id="helpBtn" class="btn ghost">Help</button>
    </div>
  </header>

  <main class="main">
    <section class="hero-ptable">
      <div class="toolbar top">
        <div class="group">
          <span class="lbl">Mode</span>
          <div class="seg">
            <button id="modeStudy" class="seg-btn active">Study</button>
            <button id="modeGame" class="seg-btn">Game</button>
          </div>
        </div>
        <div class="group">
          <label class="lbl">Ion</label>
          <button id="ionMinus" class="btn">−</button>
          <div id="ionCharge" class="ion-box">0</div>
          <button id="ionPlus" class="btn">+</button>
          <label class="toggle small"><input type="checkbox" id="hintToggle" checked/> Hints</label>
        </div>
        <div class="group grow">
          <label class="lbl">Search</label>
          <input id="searchBox" class="search" placeholder="Symbol / Z / name (e.g., Fe, 26, Iron)" />
        </div>
        <div class="group">
          <label class="lbl">Table zoom</label>
          <input id="zoomRange" type="range" min="34" max="72" step="2" value="48"/>
        </div>
        <div class="legend">
          <span class="dot s"></span><span>s</span>
          <span class="dot f"></span><span>f</span>
          <span class="dot d"></span><span>d</span>
          <span class="dot p"></span><span>p</span>
        </div>
      </div>

      <div class="ptable-wrapper">
        <div id="ptable" class="ptable" aria-label="Periodic Table"></div>
      </div>

      <div class="toolbar bottom">
        <div class="left">
          <div id="currentPick" class="current-pick">Selected: O (Z=8)</div>
          <div class="mini">Electrons: <span id="placedCount">0</span> / <span id="electronCount">8</span></div>
          <div class="mini" id="spectroLine">Config: <code id="spectro">—</code></div>
        </div>
        <div class="center" id="studyControls">
          <button id="prevStepBtn" class="btn">⟲ Back</button>
          <button id="nextStepBtn" class="btn primary">Next step ↠</button>
          <label class="toggle small"><input type="checkbox" id="autoPlayToggle"/> Auto-play</label>
          <label class="toggle small"><input type="checkbox" id="sandboxToggle"/> Sandbox (allow illegal)</label>
        </div>
        <div class="center hidden" id="gameControls">
          <div class="stat"><span class="lbl">Timer</span> <span id="timer">00:00</span></div>
          <div class="stat"><span class="lbl">Streak</span> <span id="streak">0</span></div>
        </div>
        <div class="actions" id="actionsBar">
          <button id="newGameBtn" class="btn primary">New Game</button>
          <button id="resetBtn" class="btn">Reset Building</button>
        </div>
      </div>
    </section>

    <section class="below-ptable">
      <aside class="sidebar">
        <section class="panel score">
          <h2>Score</h2>
          <div class="score-num" id="score">0</div>
          <div class="mini">Correct +10 • Hund single +5 • Pauli pair +15 • Wrong −5</div>
        </section>
        <section class="panel energy">
          <h2>Move-in Order (Aufbau)</h2>
          <ol id="aufbauList" class="mini" style="margin-left:18px"></ol>
        </section>
        <section class="panel info">
          <h2>ℹ️ Learn as you play</h2>
          <div id="infoNow" class="info-now"></div>
          <details open><summary>Aufbau principle</summary><p>Electrons occupy the lowest-energy available subshells first. Long-form order extends to 7p.</p></details>
          <details><summary>Hund’s rule</summary><p>In a set of degenerate orbitals (p, d, f), place one electron in each with the <b>same spin</b> before pairing.</p></details>
          <details><summary>Pauli exclusion principle</summary><p>Each orbital holds at most two electrons and they must have <b>opposite spins</b> (↑↓).</p></details>
        </section>
      </aside>

      <section class="game-area">
        <div id="toast" class="toast" role="alert" aria-live="assertive"></div>
        <div class="energy-axis"><span>Energy ↑</span></div>
        <div class="game-col">
          <div id="building" class="building"></div>
          <div class="lobby hidden" id="lobbyBox">
            <div class="lobby-title">Lobby — Incoming Tenants</div>
            <div id="lobbyArea" class="lobby-area"></div>
            <div class="lobby-actions">
              <button id="flipSpinBtn" class="btn">Flip Spin (↑/↓)</button>
              <button id="skipBtn" class="btn" title="Put this electron back in line (no score change)">Skip Electron</button>
              <div class="queue-info" id="queueInfo">Queue: 0 / 0</div>
            </div>
          </div>
        </div>
      </section>
    </section>
  </main>

  <footer class="app-footer">
    <span>© 2025 Electron Towers Prototype • Stable rollback</span>
  </footer>

  <script>
// ======== DATA ========
const symbols = {symbols};
const names = {names};
function sym(Z){{ return symbols[Z-1] || "?"; }}
function nameOf(Z){{ return names[Z-1] || ""; }}

// ======== PERIODIC TABLE RENDER ========
function buildPTGrid(container, onPick, currentZ){{
  const ROW_OFFSET = 1;
  const COL_OFFSET = 1;
  container.innerHTML = "";

  // A/B group labels
  const groupCol = {{1:2, 2:3}};
  for (let g=3, col=18; g<=12; g++, col++) groupCol[g] = col;
  groupCol[13]=28; groupCol[14]=29; groupCol[15]=30; groupCol[16]=31; groupCol[17]=32; groupCol[18]=33;
  const groupAB = {{
    1: "1A", 2: "2A",
    3: "3B", 4: "4B", 5: "5B", 6: "6B", 7: "7B",
    8: "8B", 9: "8B", 10: "8B",
    11: "1B", 12: "2B",
    13: "3A", 14: "4A", 15: "5A", 16: "6A", 17: "7A", 18: "8A"
  }};
  for (let g=1; g<=18; g++){{
    const gl = document.createElement("div");
    gl.className = "group-label";
    gl.textContent = groupAB[g];
    gl.style.gridColumn = String(groupCol[g]);
    gl.style.gridRow = "1";
    container.appendChild(gl);
  }}
  const glCap = document.createElement("div");
  glCap.className = "group-label small";
  glCap.textContent = "Group (A/B) →";
  glCap.style.gridColumn = "33";
  glCap.style.gridRow = "1";
  container.appendChild(glCap);

  // Period labels
  for (let p=1; p<=7; p++){{
    const pl = document.createElement("div");
    pl.className = "period-label";
    pl.textContent = p;
    pl.style.gridColumn = "1";
    pl.style.gridRow = String(p + ROW_OFFSET);
    container.appendChild(pl);
  }}

  function overlay(label, colStart, colSpan, rowStart, rowSpan){{
    colStart += COL_OFFSET; rowStart += ROW_OFFSET;
    const ov = document.createElement("div");
    ov.className = "block-overlay";
    ov.style.gridColumn = `${{colStart}} / span ${{colSpan}}`;
    ov.style.gridRow = `${{rowStart}} / span ${{rowSpan}}`;
    const lab = document.createElement("label"); lab.textContent = label;
    ov.appendChild(lab);
    container.appendChild(ov);
  }}
  function placeRange(period, colStart, Zstart, Zend, blockClass){{
    let c = colStart;
    for (let Z=Zstart; Z<=Zend; Z++, c++){{
      const t = document.createElement("div");
      t.className = `ptile ${{blockClass}}`;
      t.style.gridColumn = `${{c + COL_OFFSET}}`;
      t.style.gridRow = `${{period + ROW_OFFSET}}`;
      t.dataset.z = Z;
      t.title = `${{sym(Z)}} — ${{nameOf(Z)}} (Z=${{Z}})`;
      t.innerHTML = `<div class="z">${{Z}}</div><div class="sym">${{sym(Z)}}</div>`;
      t.addEventListener("click", ()=> onPick(Z, t));
      if (Z === currentZ) t.classList.add("selected");
      container.appendChild(t);
    }}
  }}
  placeRange(1, 1, 1, 2, "s");
  placeRange(2, 1, 3, 4, "s"); placeRange(2, 27, 5, 10, "p");
  placeRange(3, 1, 11, 12, "s"); placeRange(3, 27, 13, 18, "p");
  placeRange(4, 1, 19, 20, "s"); placeRange(4, 17, 21, 30, "d"); placeRange(4, 27, 31, 36, "p");
  placeRange(5, 1, 37, 38, "s"); placeRange(5, 17, 39, 48, "d"); placeRange(5, 27, 49, 54, "p");
  placeRange(6, 1, 55, 56, "s"); placeRange(6, 3, 57, 70, "f"); placeRange(6, 17, 71, 80, "d"); placeRange(6, 27, 81, 86, "p");
  placeRange(7, 1, 87, 88, "s"); placeRange(7, 3, 89, 102, "f"); placeRange(7, 17, 103, 112, "d"); placeRange(7, 27, 113, 118, "p");
  overlay("s-block", 1, 2, 1, 7); overlay("f-block", 3, 14, 6, 2); overlay("d-block", 17, 10, 4, 4); overlay("p-block", 27, 6, 2, 6);
}}

// ======== GAME/STUDY LOGIC ========
const ORDER = ["1s","2s","2p","3s","3p","4s","3d","4p","5s","4d","5p","6s","4f","5d","6p","7s","5f","6d","7p"];
const subshellOrbitals = {{ s:1, p:3, d:5, f:7 }};
const state = {{ mode:"study", targetZ:8, ionCharge:0, queue:[], nextId:1, score:0, building:{{}}, autoTimer:null, timerId:null, startTime:null, streak:0, showHints:true }};

function on(el, type, handler){{ if (el) el.addEventListener(type, handler); }}
function byId(id){{ return document.getElementById(id); }}
function toast(msg){{ const t = byId("toast"); if (!t) return; t.textContent = msg; t.className = "toast show"; setTimeout(()=> t.className = "toast", 1500); }}

function orbitalLabel(sub, i){{
  const l = sub.slice(-1);
  if (l === 's') return `${{sub}} orbital`;
  if (l === 'p') return `${{sub}}_${{['x','y','z'][i]}} orbital`;
  if (l === 'd') return `${{sub}}_${{['xy','yz','zx','x^2−y^2','z^2'][i]}} orbital`;
  if (l === 'f') return `${{sub}} (mℓ=${{[-3,-2,-1,0,1,2,3][i]}}) orbital`;
  return `${{sub}} orbital`;
}}

function subInfo(sub){{
  const n = parseInt(sub[0],10), letter=sub[1];
  const orbitals = subshellOrbitals[letter] || 1;
  const capacity = orbitals * 2;
  const l = {{ s:0, p:1, d:2, f:3 }}[letter];
  return {{ n, letter, orbitals, capacity, l }};
}}

function buildAufbauList(){{
  const list = byId("aufbauList"); list.innerHTML = "";
  ORDER.forEach(sub => {{ const info=subInfo(sub); const li=document.createElement("li"); li.dataset.sub=sub; li.innerHTML = `${{sub}} — n=${{info.n}}, ℓ=${{info.l}} (${{info.letter}}), cap ${{info.capacity}}`; list.appendChild(li); }});
}}

function buildFloors(){{
  const elBuilding = byId("building"); elBuilding.innerHTML = "";
  const byN = {{}}; ORDER.forEach(sub => {{ const n=subInfo(sub).n; (byN[n]=byN[n]||[]).push(sub); }});
  Object.keys(byN).sort((a,b)=>a-b).forEach(nStr => {{
    const n = parseInt(nStr,10);
    const floor = document.createElement("div");
    floor.className = "floor"; floor.setAttribute("data-n", String(n));
    floor.innerHTML = `<div class="floor-label">Shell n=${{n}}</div><div class="wings" id="floor-${{n}}"></div>`;
    elBuilding.appendChild(floor);
    const wings = floor.querySelector(".wings");
    const orderLetters = ["s","p","d","f"];
    byN[n].sort((a,b)=>orderLetters.indexOf(a[1]) - orderLetters.indexOf(b[1])).forEach(sub => {{
      const info=subInfo(sub);
      const wing=document.createElement("div");
      wing.className = `wing wing-${{info.letter}}`; wing.dataset.sub=sub;
      wing.innerHTML = `<div class="wing-title">${{sub}} wing — <span class="mini">ℓ=${{info.l}} (${{info.letter}})</span></div><div class="units" id="wing-${{sub}}"></div>`;
      wings.appendChild(wing);
      const units=wing.querySelector(".units");
      for (let i=0;i<info.orbitals;i++){{
        const unit=document.createElement("div");
        unit.className="unit"; unit.dataset.wing=sub; unit.dataset.index=i;
        unit.innerHTML = `<div class="unit-label">${{orbitalLabel(sub,i)}}</div><div class="slots"><div class="slot" data-slot="0"></div><div class="slot" data-slot="1"></div></div>`;
        on(unit, "click", (e)=> onUnitClick(e, unit));
        on(unit, "dragover", e=>e.preventDefault());
        on(unit, "drop", onDropToUnit);
        units.appendChild(unit);
      }}
    }});
  }});
}}

function resetBuilding(){{
  state.building = {{}};
  ORDER.forEach(sub => {{ const info=subInfo(sub); state.building[sub] = Array.from({{length:info.orbitals}}, ()=>[]); }});
  document.querySelectorAll(".unit .slots").forEach(n => n.innerHTML = `<div class="slot" data-slot="0"></div><div class="slot" data-slot="1"></div>`);
  clearGhost(); refreshAufbauFocus(); refreshInfo(); renderSpectro();
}}

function electronsNeeded(){{ return Math.max(0, (state.targetZ||1) - (state.ionCharge||0)); }}
function placedCount(){{ let c=0; for (const sub of ORDER){{ const arr=state.building[sub]||[]; for (const u of arr) c+=u.length; }} return c; }}
function overCap(){{ return placedCount() >= electronsNeeded(); }}
function addScore(n){{ state.score += n; const sc = byId("score"); if (sc) sc.textContent = state.score; }}
function findUnitEl(wing,index){{ return document.querySelector(`.unit[data-wing="${{wing}}"][data-index="${{index}}"]`); }}

function placeElectronInto(wing, index, spin){{
  state.building[wing][index].push(spin);
  const unit = findUnitEl(wing,index);
  if (unit){{
    const slots = unit.querySelectorAll(".slot");
    for (let i=0;i<2;i++){{ const s = state.building[wing][index][i]; slots[i].textContent = s ? (s==="up"?"↑":"↓") : ""; }}
  }}
  refreshInfo(); renderSpectro();
}}
function removeElectronFrom(wing, index){{
  const popped = state.building[wing][index].pop();
  const unit = findUnitEl(wing,index);
  if (unit){{
    const slots = unit.querySelectorAll(".slot");
    for (let i=0;i<2;i++){{ const s = state.building[wing][index][i]; slots[i].textContent = s ? (s==="up"?"↑":"↓") : ""; }}
  }}
  refreshInfo(); renderSpectro(); return popped;
}}

function hasVacancy(sub){{ return (state.building[sub]||[]).some(u => u.length < 2); }}
function subshellRank(sub){{ return ORDER.indexOf(sub); }}
function firstVacantSubshell(){{ for (const s of ORDER) if (hasVacancy(s)) return s; return null; }}
function refreshAufbauFocus(){{
  const list = byId("aufbauList"); if (!list) return;
  const focus = firstVacantSubshell();
  list.querySelectorAll("li").forEach(li => li.classList.toggle("active", li.dataset.sub === focus));
}}

function legalPlacement(wing, index, spin){{
  const firstVacant = firstVacantSubshell();
  if (firstVacant && subshellRank(wing) > subshellRank(firstVacant)) return {{ ok:false, rule:"Aufbau", msg:`Fill ${{firstVacant}} before ${{wing}}.` }};
  const occ = state.building[wing][index];
  if (occ.length >= 2) return {{ ok:false, rule:"Pauli", msg:`Max 2 per orbital.` }};
  if (occ.length === 1 && occ[0] === spin) return {{ ok:false, rule:"Pauli", msg:`Pair must be opposite spins.` }};
  const info = subInfo(wing);
  if (info.orbitals > 1){{
    const units = state.building[wing];
    const emptyUnits = units.map((u,i)=>({{u,i}})).filter(x => x.u.length === 0);
    const singleUnits = units.map((u,i)=>({{u,i}})).filter(x => x.u.length === 1);
    if (emptyUnits.length > 0){{
      const isEmptyTarget = units[index].length === 0;
      if (!isEmptyTarget) return {{ ok:false, rule:"Hund", msg:`Spread out: single-occupy all ${{wing}} orbitals first.` }};
      if (singleUnits.length > 0){{
        const expected = singleUnits[0].u[0];
        if (spin !== expected) return {{ ok:false, rule:"Hund", msg:`Use same spin (${{expected === 'up' ? '↑' : '↓'}}) for singles.` }};
      }}
    }}
  }}
  return {{ ok:true }};
}}

function recommendedSpinFor(wing, index){{
  const info = subInfo(wing);
  if (info.orbitals === 1){{
    const occ = state.building[wing][0];
    if (occ.length === 0) return {{ spin:"up", slotIndex:0 }};
    if (occ.length === 1) return {{ spin:(occ[0]==="up"?"down":"up"), slotIndex:1 }};
  }} else {{
    const units = state.building[wing];
    const occ = units[index];
    if (occ.length === 0){{
      const singles = units.filter(u => u.length === 1);
      return {{ spin: singles.length ? singles[0][0] : "up", slotIndex:0 }};
    }} else if (occ.length === 1){{
      return {{ spin:occ[0]==="up"?"down":"up", slotIndex:1 }};
    }}
  }}
  return {{ spin:"up", slotIndex:0 }};
}}

function onUnitClick(e, unit){{
  if (state.mode !== "study") return;
  if (overCap()){{ toast("Configuration complete — no more electrons."); clearGhost(); return; }}
  const wing = unit.dataset.wing; const index = parseInt(unit.dataset.index,10);
  const rec = recommendedSpinFor(wing, index);
  const res = legalPlacement(wing, index, rec.spin);
  if (!res.ok){{
    const sandbox = byId("sandboxToggle")?.checked;
    if (sandbox){{ placeElectronInto(wing, index, rec.spin); toast(`Sandbox: would violate ${{res.rule}} — ${{res.msg}}`); }}
    else {{ unit.classList.add("invalid"); setTimeout(()=> unit.classList.remove("invalid"), 220); toast(`${{res.rule}} violation: ${{res.msg}}`); return; }}
  }} else {{ placeElectronInto(wing, index, rec.spin); }}
  refreshAufbauFocus(); planStudyGhost();
}}

function ghostNextMove(){{
  if (overCap()) return null;
  const focus = firstVacantSubshell(); if (!focus) return null;
  const info = subInfo(focus);
  let spin="up", index=0, slotIndex=0;
  if (info.orbitals === 1){{
    const occ = state.building[focus][0];
    if (occ.length === 1){{ spin = (occ[0]==="up"?"down":"up"); slotIndex = 1; }}
  }} else {{
    const units = state.building[focus];
    const empties = units.map((u,i)=>({{u,i}})).filter(x=>x.u.length===0);
    const singles = units.map((u,i)=>({{u,i}})).filter(x=>x.u.length===1);
    if (empties.length>0){{ index = empties[0].i; slotIndex=0; spin = singles.length>0 ? singles[0].u[0] : "up"; }}
    else if (singles.length>0){{ index = singles[0].i; slotIndex=1; spin = singles[0].u[0]==="up" ? "down" : "up"; }}
  }}
  return {{ wing:focus, index, spin, slotIndex }};
}}
function clearGhost(){{ document.querySelectorAll(".unit.ghost").forEach(u=>u.classList.remove("ghost")); document.querySelectorAll(".slot.ghost-slot").forEach(s=>s.classList.remove("ghost-slot")); }}
function renderGhost(move){{ clearGhost(); if (!move) return; const unit = findUnitEl(move.wing, move.index); if (!unit) return; unit.classList.add("ghost"); const slot = unit.querySelectorAll(".slot")[move.slotIndex||0]; if (slot) slot.classList.add("ghost-slot"); }}
function planStudyGhost(){{ renderGhost(ghostNextMove()); refreshInfo(); }}

// Game (drag)
function newGame(){{
  clearAutoPlay(); byId("score").textContent = "0"; state.score = 0;
  stopTimer(); state.streak = 0; byId("streak").textContent = "0";
  resetBuilding(); state.queue = []; state.nextId = 1;
  const total = electronsNeeded();
  for (let i=0;i<total;i++){{ const spin = (i%2===0) ? "up" : "down"; state.queue.push({{ id: state.nextId++, spin }}); }}
  spawnNextElectron(); startTimer();
}}
function spawnNextElectron(){{
  const elLobby = byId("lobbyArea"); if (!elLobby) return; elLobby.innerHTML = "";
  if (state.queue.length === 0){{ toast("All tenants placed! 🎉"); stopTimer(); return; }}
  const e = state.queue[0];
  const el = document.createElement("div");
  el.className = `electron ${{e.spin}}`; el.setAttribute("draggable","true"); el.id = `electron-${{e.id}}`; el.dataset.spin = e.spin;
  el.title = "Drag me into a unit."; el.textContent = e.spin === "up" ? "↑" : "↓";
  on(el, "dragstart", (ev)=>{{ ev.dataTransfer.setData("text/plain", JSON.stringify({{ id:e.id }})); }});
  elLobby.appendChild(el);
  updateQueueInfo();
}}
function updateQueueInfo(){{
  const total = electronsNeeded(); const placed = total - state.queue.length;
  const qi = byId("queueInfo"); if (qi) qi.textContent = `Queue: ${{placed}} / ${{total}}`;
}}
function onDropToUnit(ev){{
  ev.preventDefault(); if (state.mode !== "game") return;
  const unitEl = ev.currentTarget; const wing = unitEl.dataset.wing; const idx = parseInt(unitEl.dataset.index,10);
  const lobbyElectron = state.queue[0]; if (!lobbyElectron) return;
  const res = legalPlacement(wing, idx, lobbyElectron.spin);
  if (!res.ok){{ unitEl.classList.add("invalid"); setTimeout(()=>unitEl.classList.remove("invalid"), 220); addScore(-5); toast(`${{res.rule}} violation: ${{res.msg}}`); state.streak = 0; byId("streak").textContent = "0"; return; }}
  state.queue.shift(); placeElectronInto(wing, idx, lobbyElectron.spin); addScore(10);
  const info = subInfo(wing);
  if (info.orbitals > 1){{ const singles = state.building[wing].filter(u => u.length === 1).length; if (singles <= info.orbitals) addScore(5); }}
  if (state.building[wing][idx].length === 2) addScore(15);
  state.streak += 1; byId("streak").textContent = String(state.streak);
  spawnNextElectron(); refreshAufbauFocus();
}}

// Info & utils
function refreshInfo(){{
  const focus = firstVacantSubshell() || ORDER[ORDER.length-1];
  const info = subInfo(focus);
  const electrons = electronsNeeded(); const placed = placedCount();
  const Z = state.targetZ || 1;
  const hundNote = (info.orbitals > 1) ? `<li><b>Hund:</b> single-occupy ${{info.orbitals}} orbitals with the <b>same spin</b> before pairing.</li>` : "";
  const crossover = (focus === "4s") ? `<li>Cross-over: in early transition metals, <b>4s</b> fills slightly before <b>3d</b>.</li>` :
                    (focus === "3d") ? `<li>Now filling <b>3d</b> after <b>4s</b>.</li>` : "";
  const modeText = state.mode==="study" ? "Study Mode: click the glowing slot to place." : "Game Mode: drag from lobby to apartments.";
  const infoNow = byId("infoNow"); if (!infoNow) return;
  infoNow.innerHTML = `
    <div><b>Now filling:</b> <code>${{focus}}</code> — n=${{info.n}}, ℓ=${{info.l}} (${{info.letter}}), Orbitals: ${{info.orbitals}}, Capacity: ${{info.capacity}} e⁻.</div>
    <ul class="mini">
      <li><b>Element:</b> ${{sym(Z)}} (Z=${{Z}}) • <b>Electrons:</b> ${{placed}} / ${{electrons}}${{state.ionCharge!==0 ? ` (charge ${{state.ionCharge>0?"+":""}}${{state.ionCharge}})`:""}}</li>
      <li><b>Aufbau:</b> lowest-energy subshell first.</li>
      ${{hundNote}}
      <li><b>Pauli:</b> pairs must be opposite spin.</li>
      ${{crossover}}
      <li>${{modeText}}</li>
    </ul>`;
  const ec = byId("electronCount"); if (ec) ec.textContent = electrons;
  const pc = byId("placedCount"); if (pc) pc.textContent = placed;
}}

function renderSpectro(){{
  const el = document.getElementById("spectro"); if (!el) return;
  const parts = [];
  for (const sub of ORDER){{ const units=(state.building[sub]||[]); let n=0; for (const u of units) n+=u.length; if (n>0) parts.push(sub + '<sup>'+n+'</sup>'); }}
  el.innerHTML = parts.join(' ');
}}

function clearAutoPlay(){{ if (state.autoTimer){{ clearInterval(state.autoTimer); state.autoTimer=null; }} const ap = byId("autoPlayToggle"); if (ap) ap.checked = false; }}
function startTimer(){{ stopTimer(); state.startTime = Date.now(); const t = byId("timer"); if (t) t.textContent = "00:00";
  state.timerId = setInterval(()=>{{ const s = Math.floor((Date.now()-state.startTime)/1000); const m = Math.floor(s/60); const ss = s%60; const t = byId("timer"); if (t) t.textContent = `${{String(m).padStart(2,"0")}}:${{String(ss).padStart(2,"0")}}`; }}, 1000);
}}
function stopTimer(){{ if (state.timerId){{ clearInterval(state.timerId); state.timerId = null; }} }}

function buildPT(){{
  const elPT = byId("ptable"); if (!elPT) return;
  buildPTGrid(elPT, (Z, tile)=>{{
    state.targetZ = Z;
    document.querySelectorAll(".ptile").forEach(t=>t.classList.remove("selected"));
    tile.classList.add("selected");
    byId("currentPick").textContent = `Selected: ${{sym(Z)}} — ${{nameOf(Z)}} (Z=${{Z}})`;
    byId("electronCount").textContent = electronsNeeded();
    if (state.mode === "study"){{ resetBuilding(); planStudyGhost(); }}
    if (state.mode === "game"){{ newGame(); }}
  }}, state.targetZ);
}}

function setIonCharge(delta){{
  state.ionCharge = Math.max(-10, Math.min(10, (state.ionCharge||0) + delta));
  const ic = byId("ionCharge"); if (ic) ic.textContent = state.ionCharge > 0 ? `+${{state.ionCharge}}` : `${{state.ionCharge}}`;
  const ec = byId("electronCount"); if (ec) ec.textContent = electronsNeeded();
  if (state.mode==="study"){{ resetBuilding(); planStudyGhost(); }}
  if (state.mode==="game") newGame();
}}

function searchPick(q){{
  q = (q||"").trim().toLowerCase(); if (!q) return;
  const asNum = parseInt(q,10); let Z = null;
  if (!isNaN(asNum) && asNum>=1 && asNum<=118) Z = asNum;
  if (!Z){{ Z = symbols.findIndex(s=>s.toLowerCase()===q)+1; if (!Z){{ Z = names.findIndex(n=>n.toLowerCase().startsWith(q))+1; if (Z===0) Z = null; }} }}
  if (Z){{
    const tile = Array.from(document.querySelectorAll(".ptile")).find(t=>parseInt(t.dataset.z,10)===Z);
    if (tile){{ tile.click(); tile.scrollIntoView({{block:"center", inline:"center", behavior:"smooth"}}); }}
  }}
}}

function openHelp(which="study"){{
  alert(which==="study" ? "Study: click glowing slot; Back/Next; Auto-play optional." : "Game: New Game; drag lobby electrons to units. Scoring shown on left.");
}}

function init(){{
  buildAufbauList(); buildFloors(); buildPT();
  const zr = byId("zoomRange"); if (zr){{ document.documentElement.style.setProperty("--tile", zr.value+"px"); zr.addEventListener("input", ()=> document.documentElement.style.setProperty("--tile", zr.value+"px")); }}
  const sb = byId("searchBox"); if (sb) sb.addEventListener("keydown", (e)=>{{ if (e.key === "Enter"){{ searchPick(sb.value); }} }});
  on(byId("hintToggle"), "change", e=> state.showHints = !!e.target.checked);
  on(byId("ionMinus"), "click", ()=> setIonCharge(-1));
  on(byId("ionPlus"), "click", ()=> setIonCharge(+1));
  on(byId("newGameBtn"), "click", newGame);
  on(byId("resetBtn"), "click", resetBuilding);
  on(byId("helpBtn"), "click", ()=> openHelp(state.mode));
  on(byId("prevStepBtn"), "click", ()=>{{ for (let i=ORDER.length-1;i>=0;i--){{ const sub=ORDER[i]; const units=state.building[sub]; for (let j=units.length-1;j>=0;j--){{ if (units[j].length>0){{ removeElectronFrom(sub, j); planStudyGhost(); return; }} }} }} }});
  on(byId("nextStepBtn"), "click", ()=>{{ if (overCap()){{ toast("Configuration complete."); clearGhost(); return; }} const mv=ghostNextMove(); if (!mv){{ toast("No move — complete."); return; }} const res=legalPlacement(mv.wing,mv.index,mv.spin); const sandboxOn=byId("sandboxToggle")?.checked; if (!res.ok && !sandboxOn){{ toast(`${{res.rule}} prevented this step.`); return; }} placeElectronInto(mv.wing,mv.index,mv.spin); refreshAufbauFocus(); planStudyGhost(); }});
  on(byId("autoPlayToggle"), "change", ()=>{{ const ap=byId("autoPlayToggle"); if (ap && ap.checked){{ state.autoTimer=setInterval(()=>{{ if (overCap()){{ ap.checked=false; clearAutoPlay(); toast("Auto-play: complete."); clearGhost(); return; }} const mv=ghostNextMove(); if (!mv){{ ap.checked=false; clearAutoPlay(); return; }} const res=legalPlacement(mv.wing,mv.index,mv.spin); const sandboxOn=byId("sandboxToggle")?.checked; if (!res.ok && !sandboxOn){{ ap.checked=false; clearAutoPlay(); toast(`${{res.rule}} prevented.`); return; }} placeElectronInto(mv.wing,mv.index,mv.spin); refreshAufbauFocus(); planStudyGhost(); }}, 800); }} else clearAutoPlay(); }});
  on(byId("modeStudy"), "click", ()=>{{ state.mode="study"; byId("modeStudy").classList.add("active"); byId("modeGame").classList.remove("active"); byId("studyControls").classList.remove("hidden"); byId("gameControls").classList.add("hidden"); byId("lobbyBox").classList.add("hidden"); byId("actionsBar").classList.add("hidden"); stopTimer(); clearAutoPlay(); resetBuilding(); planStudyGhost(); }});
  on(byId("modeGame"), "click", ()=>{{ state.mode="game"; byId("modeGame").classList.add("active"); byId("modeStudy").classList.remove("active"); byId("gameControls").classList.remove("hidden"); byId("studyControls").classList.add("hidden"); byId("lobbyBox").classList.remove("hidden"); byId("actionsBar").classList.remove("hidden"); clearAutoPlay(); newGame(); }});
  const initialTile = Array.from(document.querySelectorAll(".ptile")).find(t=>parseInt(t.dataset.z,10)===8); if (initialTile) initialTile.click();
  stopTimer(); clearAutoPlay(); renderSpectro();
}}
window.addEventListener("DOMContentLoaded", init);
  </script>
</body>
</html>
