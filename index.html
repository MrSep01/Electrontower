<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Electron Towers — v0.17r0 (Mobile Responsive + Testing + Diagonal Aufbau + Exceptions + Noble)</title>
  <style>
/* ===== Design (Kahoot-inspired) ===== */
:root{
  /* Beautiful study page color scheme */
  --primary: #6366f1;
  --primary-dark: #4f46e5;
  --secondary: #8b5cf6;
  --accent: #06b6d4;
  --success: #10b981;
  --warning: #f59e0b;
  --danger: #ef4444;
  --dark: #1e293b;
  --darker: #0f172a;
  --light: #f8fafc;
  --border: #e2e8f0;
  --shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1);
  --shadow-lg: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
  
  /* Legacy variables for compatibility */
  --kahoot-purple: var(--primary);
  --kahoot-blue: var(--accent);
  --kahoot-red: var(--danger);
  --kahoot-yellow: var(--warning);
  --kahoot-green: var(--success);
  --panel: var(--darker);
  --unit-border: var(--border);
  --text: var(--light);
  --unit-bg: var(--dark);
  --tile: 48px;
  
  /* Mobile-first responsive variables */
  --header-height: 80px;
  --header-height-mobile: 70px;
  --sidebar-width: 360px;
  --sidebar-width-tablet: 300px;
  --sidebar-width-mobile: 100%;
  --toolbar-gap: 12px;
  --toolbar-gap-mobile: 8px;
  --border-radius: 20px;
  --border-radius-mobile: 16px;
  --padding: 20px;
  --padding-mobile: 16px;
  --padding-small: 12px;
  --padding-small-mobile: 10px;
}

/* ===== Mobile-First Base Styles ===== */
*{box-sizing:border-box} 
html,body{height:100%}
body{
  margin:0;
  font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,'Noto Sans',sans-serif;
  background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);
  color:var(--text);
  -webkit-text-size-adjust: 100%;
  -webkit-tap-highlight-color: rgba(0,0,0,0);
  overflow-x: hidden;
}

/* Touch-friendly improvements */
* { 
  -webkit-tap-highlight-color: rgba(0,0,0,0); 
  touch-action: manipulation;
}

.hidden{display:none!important}

/* ===== Enhanced Header with Mobile Responsiveness ===== */
.app-header{
  display:flex;
  align-items:center;
  justify-content:space-between;
  padding: 14px 18px;
  border-bottom:3px solid var(--accent);
  background:rgba(99,102,241,0.9);
  position:sticky;
  top:0;
  z-index:30;
  backdrop-filter:blur(10px);
  min-height: var(--header-height-mobile);
  flex-wrap: wrap;
  gap: 10px;
}

/* Mobile header adjustments */
@media (max-width: 768px) {
  .app-header {
    padding: 10px 14px;
    min-height: var(--header-height-mobile);
    flex-direction: column;
    align-items: stretch;
    gap: 12px;
  }
  
  .app-header .brand {
    justify-content: center;
    order: 1;
  }
  
  .app-header .right {
    order: 2;
    display: flex;
    justify-content: center;
    gap: 8px;
    flex-wrap: wrap;
  }
}

@media (max-width: 480px) {
  .app-header {
    padding: 8px 12px;
    gap: 8px;
  }
  
  .app-header .right {
    gap: 6px;
  }
  
  .app-header .right .btn {
    padding: 8px 10px;
    font-size: 14px;
  }
}

.brand {
  display: flex;
  align-items: center;
  gap: 15px;
}

/* Mobile brand adjustments */
@media (max-width: 768px) {
  .brand {
    gap: 12px;
  }
  
  .brand h1 {
    font-size: 20px !important;
  }
  
  .brand .subtitle {
    font-size: 11px !important;
  }
}

@media (max-width: 480px) {
  .brand {
    gap: 10px;
  }
  
  .brand h1 {
    font-size: 18px !important;
  }
  
  .brand .subtitle {
    font-size: 10px !important;
  }
}

.header-logo {
  position: relative;
  width: 60px;
  height: 60px;
  flex-shrink: 0;
  background: linear-gradient(135deg, #87CEEB 0%, #B0E0E6 100%);
  border-radius: 15px;
  padding: 6px;
  box-shadow: 0 3px 10px rgba(0,0,0,0.15);
  overflow: hidden;
}

/* Mobile logo adjustments */
@media (max-width: 768px) {
  .header-logo {
    width: 50px;
    height: 50px;
    border-radius: 12px;
    padding: 5px;
  }
}

@media (max-width: 480px) {
  .header-logo {
    width: 45px;
    height: 45px;
    border-radius: 10px;
    padding: 4px;
  }
}

.logo-image {
  width: 100%;
  height: 100%;
  position: relative;
}

.logo-placeholder {
  width: 100%;
  height: 100%;
  position: relative;
  background: linear-gradient(135deg, #87CEEB 0%, #B0E0E6 100%);
  border-radius: 10px;
}

/* Scientist elements */
.logo-scientist {
  position: absolute;
  width: 100%;
  height: 100%;
}

.logo-hair-purple {
  position: absolute;
  top: 8px;
  left: 20px;
  width: 20px;
  height: 12px;
  background: #8b5cf6;
  border-radius: 10px 10px 8px 8px;
}

.logo-face-skin {
  position: absolute;
  top: 18px;
  left: 22px;
  width: 16px;
  height: 12px;
  background: #fbbf24;
  border-radius: 8px;
}

.logo-eyes-blue {
  position: absolute;
  top: 20px;
  left: 24px;
  width: 12px;
  height: 8px;
  display: flex;
  gap: 4px;
}

.logo-eyes-blue::before,
.logo-eyes-blue::after {
  content: '';
  width: 4px;
  height: 4px;
  background: #1e40af;
  border-radius: 50%;
}

.logo-glasses-round {
  position: absolute;
  top: 19px;
  left: 21px;
  width: 18px;
  height: 6px;
  border: 2px solid #1e293b;
  border-radius: 6px;
}

.logo-smile-friendly {
  position: absolute;
  top: 26px;
  left: 25px;
  width: 8px;
  height: 4px;
  border: 1px solid #dc2626;
  border-top: none;
  border-radius: 0 0 8px 8px;
}

.logo-labcoat-white {
  position: absolute;
  top: 30px;
  left: 18px;
  width: 24px;
  height: 14px;
  background: white;
  border-radius: 4px 4px 0 0;
}

.logo-tie-purple {
  position: absolute;
  top: 32px;
  left: 26px;
  width: 4px;
  height: 10px;
  background: #8b5cf6;
  border-radius: 2px;
}

/* Science elements */
.logo-science-elements {
  position: absolute;
  width: 100%;
  height: 100%;
}

.logo-atom-white {
  position: absolute;
  width: 8px;
  height: 8px;
  border: 1px solid white;
  border-radius: 50%;
}

.logo-atom-white:nth-child(1) {
  top: 5px;
  left: 5px;
}

.logo-atom-white:nth-child(2) {
  top: 5px;
  right: 5px;
}

.logo-beaker-purple {
  position: absolute;
  width: 6px;
  height: 8px;
  background: #8b5cf6;
  border-radius: 3px 3px 0 0;
}

.logo-beaker-purple:nth-child(3) {
  bottom: 5px;
  left: 5px;
}

.logo-beaker-purple:nth-child(4) {
  bottom: 5px;
  right: 5px;
}

.logo-syringe-white {
  position: absolute;
  width: 3px;
  height: 10px;
  background: white;
  border: 1px solid #8b5cf6;
  border-radius: 1px;
}

.logo-syringe-white:nth-child(5) {
  bottom: 8px;
  left: 15px;
}

.logo-syringe-white:nth-child(6) {
  bottom: 8px;
  right: 15px;
}

.logo-star-white {
  position: absolute;
  width: 3px;
  height: 3px;
  background: white;
  clip-path: polygon(50% 0%, 61% 35%, 98% 35%, 68% 57%, 79% 91%, 50% 70%, 21% 91%, 32% 57%, 2% 35%, 39% 35%);
}

.logo-star-white:nth-child(7) {
  top: 12px;
  left: 12px;
}

.logo-star-white:nth-child(8) {
  top: 18px;
  right: 10px;
}

.logo-star-white:nth-child(9) {
  bottom: 15px;
  left: 10px;
}

.logo-star-white:nth-child(10) {
  bottom: 22px;
  right: 8px;
}

.brand-text {
  display: flex;
  flex-direction: column;
}
.brand h1{margin:0;font-size:22px}.subtitle{margin:2px 0 0;color:#fff;font-size:12px;opacity:.85}

/* ===== Enhanced Button Styles with Mobile Optimization ===== */
.btn{
  background:var(--primary);
  color:#fff;
  border:none;
  padding:10px 12px;
  border-radius:10px;
  cursor:pointer;
  font-weight:800;
  transition:all 0.3s ease;
  min-height: 44px; /* Touch-friendly minimum height */
  min-width: 44px; /* Touch-friendly minimum width */
  display: inline-flex;
  align-items: center;
  justify-content: center;
  gap: 6px;
}

.btn:hover{background:var(--primary-dark);transform:translateY(-2px);box-shadow:var(--shadow)}
.btn.primary{background:var(--success)}.btn.ghost{background:transparent;border:2px solid var(--border);color:var(--light)}

/* Mobile button adjustments */
@media (max-width: 768px) {
  .btn {
    padding: 12px 16px;
    min-height: 48px;
    min-width: 48px;
    font-size: 16px;
    border-radius: 12px;
  }
}

@media (max-width: 480px) {
  .btn {
    padding: 10px 14px;
    min-height: 44px;
    min-width: 44px;
    font-size: 14px;
    border-radius: 10px;
  }
}

/* ===== Enhanced Main Content with Mobile Responsiveness ===== */
.main{
  display:flex;
  flex-direction:column;
  gap:16px;
  padding:12px 14px;
}

/* Mobile main adjustments */
@media (max-width: 768px) {
  .main {
    gap: 12px;
    padding: 10px 12px;
  }
}

@media (max-width: 480px) {
  .main {
    gap: 10px;
    padding: 8px 10px;
  }
}

.hero-ptable{
  background:rgba(30,41,59,0.9);
  border:2px solid var(--border);
  border-radius:20px;
  padding:10px;
  backdrop-filter:blur(10px);
  width:100%;
}

/* Mobile hero adjustments */
@media (max-width: 768px) {
  .hero-ptable {
    border-radius: var(--border-radius-mobile);
    padding: var(--padding-small-mobile);
  }
}

.toolbar{
  display:flex;
  align-items:center;
  gap:12px;
  flex-wrap:wrap;
  justify-content:space-between;
  margin:4px 0 10px;
}

/* ===== Enhanced Mobile Toolbar Adjustments ===== */
@media (max-width: 1024px) {
  .toolbar {
    gap: var(--toolbar-gap-mobile);
    flex-direction: column;
    align-items: stretch;
  }
  
  .toolbar .group {
    justify-content: center;
  }
  
  .toolbar .group.grow {
    min-width: auto;
    width: 100%;
  }
}

@media (max-width: 768px) {
  .toolbar {
    gap: 12px;
    margin: 12px 0 16px;
    padding: 16px;
    background: rgba(30, 41, 59, 0.3);
    border-radius: 16px;
    border: 1px solid var(--border);
  }
  
  .toolbar .group {
    flex-direction: column;
    align-items: center;
    gap: 8px;
    padding: 12px;
    background: rgba(15, 23, 42, 0.4);
    border-radius: 12px;
    border: 1px solid var(--border);
  }
  
  .toolbar .group .lbl {
    font-size: 14px;
    margin-bottom: 4px;
  }
  
  .toolbar .group.grow {
    order: -1; /* Move search to top on mobile */
  }
  
  /* Special handling for ion group to keep controls horizontal */
  .toolbar .group:has(.ion-controls) {
    gap: 10px;
  }
  
  .toolbar .group:has(.ion-controls) .ion-controls {
    flex-direction: row;
    gap: 8px;
  }
}

@media (max-width: 480px) {
  .toolbar {
    gap: 10px;
    margin: 10px 0 14px;
    padding: 12px;
  }
  
  .toolbar .group {
    padding: 10px;
    gap: 6px;
  }
  
  .toolbar .group .lbl {
    font-size: 13px;
  }
}
/* ===== Enhanced Toolbar Groups for Mobile ===== */
.toolbar .group{
  display:flex;
  align-items:center;
  gap:8px;
}

.toolbar .group.grow{
  flex:1;
  min-width:200px;
}

.lbl{
  font-weight:800;
  color:var(--warning);
}

/* Mobile group adjustments */
@media (max-width: 768px) {
  .toolbar .group {
    width: 100%;
    max-width: none;
  }
  
  .toolbar .group.grow {
    min-width: auto;
    width: 100%;
  }
}

/* ===== Enhanced Ion Controls for Mobile ===== */
.ion-controls {
  display: flex;
  align-items: center;
  gap: 8px;
  justify-content: center;
}

.ion-box {
  background: rgba(15, 23, 42, 0.9);
  border: 2px solid var(--secondary);
  border-radius: 10px;
  padding: 8px 12px;
  color: var(--warning);
  font-weight: 800;
  font-size: 16px;
  text-align: center;
  min-width: 40px;
  min-height: 40px;
  display: flex;
  align-items: center;
  justify-content: center;
}

.ion-info {
  background: rgba(15, 23, 42, 0.9);
  border: 1px solid var(--border);
  border-radius: 8px;
  padding: 4px 8px;
  color: var(--light);
  font-size: 12px;
  cursor: pointer;
  user-select: none;
}

/* Mobile ion controls adjustments */
@media (max-width: 768px) {
  .ion-controls {
    gap: 6px;
  }
  
  .ion-box {
    min-width: 48px;
    min-height: 48px;
    font-size: 18px;
    padding: 10px 14px;
    border-radius: 12px;
  }
  
  .ion-info {
    padding: 6px 10px;
    font-size: 13px;
    border-radius: 10px;
  }
}

@media (max-width: 480px) {
  .ion-controls {
    gap: 4px;
  }
  
  .ion-box {
    min-width: 44px;
    min-height: 44px;
    font-size: 16px;
    padding: 8px 12px;
    border-radius: 10px;
  }
  
  .ion-info {
    padding: 5px 8px;
    font-size: 12px;
    border-radius: 8px;
  }
}
/* ===== Enhanced Form Elements for Mobile ===== */
.search{
  width:100%;
  max-width:420px;
  padding:10px;
  border:2px solid var(--border);
  border-radius:15px;
  background:rgba(248,250,252,0.1);
  color:#fff;
  backdrop-filter:blur(10px);
  font-size: 16px; /* Prevents zoom on iOS */
  min-height: 44px; /* Touch-friendly */
}

/* Mobile search adjustments */
@media (max-width: 768px) {
  .search {
    max-width: 100%;
    padding: 12px 16px;
    min-height: 48px;
    font-size: 16px;
    border-radius: 12px;
  }
}

@media (max-width: 480px) {
  .search {
    padding: 10px 14px;
    min-height: 44px;
    font-size: 16px;
    border-radius: 10px;
  }
}

/* ===== Enhanced Zoom Slider for Mobile ===== */
input[type="range"] {
  -webkit-appearance: none;
  appearance: none;
  background: rgba(15, 23, 42, 0.8);
  border: 2px solid var(--border);
  border-radius: 10px;
  height: 8px;
  outline: none;
  cursor: pointer;
}

input[type="range"]::-webkit-slider-thumb {
  -webkit-appearance: none;
  appearance: none;
  width: 20px;
  height: 20px;
  background: var(--accent);
  border-radius: 50%;
  cursor: pointer;
  border: 2px solid var(--light);
}

input[type="range"]::-moz-range-thumb {
  width: 20px;
  height: 20px;
  background: var(--accent);
  border-radius: 50%;
  cursor: pointer;
  border: 2px solid var(--light);
}

/* Mobile zoom slider adjustments */
@media (max-width: 768px) {
  input[type="range"] {
    height: 10px;
    border-radius: 12px;
  }
  
  input[type="range"]::-webkit-slider-thumb {
    width: 24px;
    height: 24px;
  }
  
  input[type="range"]::-moz-range-thumb {
    width: 24px;
    height: 24px;
  }
}

@media (max-width: 480px) {
  input[type="range"] {
    height: 8px;
    border-radius: 10px;
  }
  
  input[type="range"]::-webkit-slider-thumb {
    width: 20px;
    height: 20px;
  }
  
  input[type="range"]::-moz-range-thumb {
    width: 20px;
    height: 20px;
  }
}
/* ===== Enhanced Legend for Mobile ===== */
.legend{
  display:flex;
  align-items:center;
  gap:6px;
  flex-wrap: wrap;
  justify-content: center;
}

.legend .dot{
  width:14px;
  height:14px;
  border-radius:4px;
  display:inline-block;
  border:2px solid #fff3;
}

.legend .dot.s{background:#2c7be5}
.legend .dot.p{background:#f2c31f;color:#231f20}
.legend .dot.d{background:#8f5af7}
.legend .dot.f{background:#fb6e6e}

/* Mobile legend adjustments */
@media (max-width: 768px) {
  .legend {
    gap: 8px;
    margin-top: 8px;
    width: 100%;
  }
  
  .legend .dot {
    width: 16px;
    height: 16px;
    border-radius: 6px;
  }
  
  .legend span {
    font-size: 13px;
  }
}

@media (max-width: 480px) {
  .legend {
    gap: 6px;
    margin-top: 6px;
  }
  
  .legend .dot {
    width: 14px;
    height: 14px;
    border-radius: 4px;
  }
  
  .legend span {
    font-size: 12px;
  }
}
/* ===== Enhanced Segmented Controls for Mobile ===== */
.seg{
  display:inline-flex;
  background:rgba(15,23,42,0.8);
  border:2px solid var(--border);
  border-radius:15px;
  padding:3px;
  backdrop-filter:blur(10px);
}

.seg-btn{
  background:transparent;
  color:#fff;
  border:none;
  padding:8px 12px;
  border-radius:12px;
  font-weight:800;
  cursor:pointer;
  transition:all 0.3s ease;
  min-height: 44px; /* Touch-friendly */
  min-width: 80px; /* Minimum width for touch */
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 6px;
}

.seg-btn:hover{background:rgba(255,255,255,0.1)}
.seg-btn.active{background:var(--success)}

/* Mobile segmented control adjustments */
@media (max-width: 768px) {
  .seg {
    padding: 4px;
    border-radius: 12px;
    width: 100%;
    max-width: 280px;
  }
  
  .seg-btn {
    padding: 12px 16px;
    min-height: 48px;
    min-width: 120px;
    font-size: 14px;
    border-radius: 10px;
    flex: 1;
  }
}

@media (max-width: 480px) {
  .seg {
    max-width: 240px;
    padding: 3px;
  }
  
  .seg-btn {
    padding: 10px 14px;
    min-height: 44px;
    min-width: 100px;
    font-size: 13px;
    border-radius: 8px;
  }
}
.ptable-wrapper{overflow:auto;border:2px solid var(--unit-border);border-radius:12px;background:#1a0a35;padding:8px;width:100%}
.ptable{position:relative;display:grid;grid-template-columns:36px repeat(32,var(--tile));grid-auto-rows:calc(var(--tile)*1.15);gap:6px;padding:6px;width:100%;min-width:calc(36px + 32*var(--tile))}
/* ===== Enhanced Periodic Table Tiles for Mobile ===== */
.ptile{
  position:relative;
  border-radius:10px;
  border:2px solid transparent;
  display:flex;
  align-items:center;
  justify-content:center;
  flex-direction:column;
  cursor:pointer;
  user-select:none;
  font-weight:900;
  touch-action: manipulation; /* Better touch handling */
  transition: all 0.2s ease; /* Smoother transitions */
}

.ptile .sym{
  font-size:calc(var(--tile)*.32);
  line-height:1;
  pointer-events: none; /* Prevent text selection issues */
}

.ptile .z{
  position:absolute;
  top:2px;
  left:4px;
  font-size:calc(var(--tile)*.22);
  opacity:.9;
  pointer-events: none;
}

.ptile.s{background:#2c7be5}
.ptile.p{background:#f2c31f;color:#231f20}
.ptile.d{background:#8f5af7}
.ptile.f{background:#fb6e6e}

.ptile:hover{transform:translateY(-2px);box-shadow:0 4px 0 0 rgba(0,0,0,.25)}
.ptile.selected{border-color:#fff;box-shadow:0 0 0 3px rgba(255,255,255,.45) inset}

/* Mobile tile adjustments */
@media (max-width: 768px) {
  .ptile {
    border-radius: 8px;
    min-width: 44px; /* Ensure minimum touch target */
    min-height: 44px; /* Ensure minimum touch target */
  }
  
  .ptile .sym {
    font-size: calc(var(--tile) * 0.35); /* Slightly larger text */
  }
  
  .ptile .z {
    font-size: calc(var(--tile) * 0.25); /* Slightly larger atomic number */
  }
  
  .ptile:hover {
    transform: none; /* Disable hover effects on mobile */
  }
  
  .ptile:active {
    transform: scale(0.95); /* Touch feedback */
    box-shadow: 0 2px 0 0 rgba(0,0,0,.25);
  }
}

@media (max-width: 480px) {
  .ptile {
    border-radius: 6px;
    min-width: 40px;
    min-height: 40px;
  }
  
  .ptile .sym {
    font-size: calc(var(--tile) * 0.38); /* Even larger text for small screens */
  }
  
  .ptile .z {
    font-size: calc(var(--tile) * 0.28);
  }
}
.block-overlay{border:2px dashed var(--warning);border-radius:12px;display:flex;align-items:flex-start;justify-content:flex-start;padding:4px;pointer-events:none;z-index:0;position:relative}
.block-overlay label{background:rgba(99,102,241,0.9);padding:2px 6px;border-radius:12px;font-size:calc(var(--tile)*.22);color:var(--light);backdrop-filter:blur(10px);position:absolute;top:-8px;left:8px;z-index:10}
.toolbar.bottom{display:flex;align-items:center;gap:16px;justify-content:center;margin-top:10px;flex-wrap:wrap}
.current-pick{font-weight:900;color:var(--warning)}.mini{color:var(--light);font-size:12px}.stat{display:inline-flex;gap:6px;align-items:center}
/* ===== Enhanced Layout for Mobile ===== */
.below-ptable{
  display:grid;
  grid-template-columns:360px 1fr;
  gap:16px;
  margin-top:12px;
}

/* Mobile layout adjustments */
@media (max-width: 1024px) {
  .below-ptable {
    grid-template-columns: var(--sidebar-width-tablet) 1fr;
    gap: 12px;
  }
}

@media (max-width: 768px) {
  .below-ptable {
    grid-template-columns: 1fr;
    gap: 16px;
    margin-top: 16px;
  }
}

@media (max-width: 480px) {
  .below-ptable {
    gap: 12px;
    margin-top: 12px;
  }
}

.sidebar{
  display:flex;
  flex-direction:column;
  gap:16px;
}

/* Mobile sidebar adjustments */
@media (max-width: 768px) {
  .sidebar {
    gap: 12px;
    order: 2; /* Move sidebar below main content on mobile */
  }
}

@media (max-width: 480px) {
  .sidebar {
    gap: 10px;
  }
}

.panel{
  background:rgba(30,41,59,0.9);
  border:2px solid var(--border);
  border-radius:20px;
  padding:20px;
  backdrop-filter:blur(10px);
}

/* Mobile panel adjustments */
@media (max-width: 768px) {
  .panel {
    border-radius: var(--border-radius-mobile);
    padding: var(--padding-mobile);
  }
}

@media (max-width: 480px) {
  .panel {
    padding: var(--padding-small-mobile);
  }
}

.panel h2{
  margin:0 0 10px 0;
  font-size:16px;
}

/* Mobile panel heading adjustments */
@media (max-width: 480px) {
  .panel h2 {
    font-size: 15px;
    margin-bottom: 8px;
  }
}
.score .score-num{font-size:36px;font-weight:800;color:var(--warning);text-shadow:0 2px 0 rgba(0,0,0,0.3)}
/* ===== Enhanced Game Area for Mobile ===== */
.game-area{
  display:grid;
  grid-template-columns:40px 1fr;
  gap:12px;
  align-items:start;
}

/* Mobile game area adjustments */
@media (max-width: 768px) {
  .game-area {
    grid-template-columns: 32px 1fr;
    gap: 10px;
  }
}

@media (max-width: 480px) {
  .game-area {
    grid-template-columns: 28px 1fr;
    gap: 8px;
  }
}

.energy-axis{
  display:flex;
  align-items:flex-start;
  justify-content:center;
  padding-top:8px;
  min-width: 40px; /* Ensure consistent width */
}

.energy-axis span{
  writing-mode:vertical-rl;
  transform:rotate(180deg);
  color:var(--warning);
  font-weight:900;
  letter-spacing:.5px;
  font-size: 12px; /* Slightly smaller to reduce layout impact */
}

/* Mobile energy axis adjustments */
@media (max-width: 768px) {
  .energy-axis span {
    font-size: 12px;
    letter-spacing: 0.3px;
  }
}

@media (max-width: 480px) {
  .energy-axis span {
    font-size: 11px;
    letter-spacing: 0.2px;
  }
}

.game-col{
  display:flex;
  flex-direction:column;
  gap:14px;
}

/* Mobile game column adjustments */
@media (max-width: 768px) {
  .game-col {
    gap: 12px;
  }
}

@media (max-width: 480px) {
  .game-col {
    gap: 10px;
  }
}
.toast{position:fixed;top:80px;right:20px;padding:10px 12px;background:rgba(30,41,59,0.95);border:2px solid var(--border);border-radius:15px;display:none;z-index:40;backdrop-filter:blur(10px)}
.toast.show{display:block}
/* ===== Enhanced Building Section for Mobile ===== */
.building{
  display:flex;
  flex-direction:column-reverse;
  background:radial-gradient(1200px 400px at 50% -50px,rgba(99,102,241,0.3) 0%,rgba(139,92,246,0.2) 60%);
  border:2px solid var(--border);
  border-radius:20px;
  padding:14px;
  min-height:420px;
  backdrop-filter:blur(10px);
}

/* Mobile building adjustments */
@media (max-width: 768px) {
  .building {
    border-radius: var(--border-radius-mobile);
    padding: var(--padding-small-mobile);
    min-height: 350px;
  }
}

@media (max-width: 480px) {
  .building {
    padding: var(--padding-small-mobile);
    min-height: 300px;
  }
}

.floor{
  border:2px dashed var(--secondary);
  border-radius:15px;
  padding:12px;
  margin:12px 0;
  background:rgba(139,92,246,0.1);
  backdrop-filter:blur(10px);
}

/* Mobile floor adjustments */
@media (max-width: 768px) {
  .floor {
    border-radius: 12px;
    padding: 10px;
    margin: 10px 0;
  }
}

@media (max-width: 480px) {
  .floor {
    border-radius: 10px;
    padding: 8px;
    margin: 8px 0;
  }
}

.floor-label{
  font-weight:900;
  color:var(--warning);
  margin-bottom:8px;
}

/* Mobile floor label adjustments */
@media (max-width: 480px) {
  .floor-label {
    font-size: 14px;
    margin-bottom: 6px;
  }
}
/* Shell layout: 1-column grid; rows = energy (top high → bottom low) */
/* ===== Enhanced Wings and Units for Mobile ===== */
.wings{
  display:grid;
  grid-template-columns:1fr;
  grid-auto-rows:minmax(84px,auto);
  gap:14px;
  align-items:stretch;
}

/* Mobile wings adjustments */
@media (max-width: 768px) {
  .wings {
    gap: 10px;
    grid-auto-rows: minmax(70px, auto);
  }
}

@media (max-width: 480px) {
  .wings {
    gap: 8px;
    grid-auto-rows: minmax(60px, auto);
  }
}

.wing{
  background:rgba(30,41,59,0.8);
  border:2px solid var(--border);
  border-radius:15px;
  padding:10px;
  position:relative;
  backdrop-filter:blur(10px);
}

/* Mobile wing adjustments */
@media (max-width: 768px) {
  .wing {
    border-radius: 12px;
    padding: 8px;
  }
}

@media (max-width: 480px) {
  .wing {
    border-radius: 10px;
    padding: 6px;
  }
}
/* Explicit per-shell energy ordering: f (highest) → d → p → s (lowest) */
.floor[data-n="2"] .wing-p{ grid-row: 1; } .floor[data-n="2"] .wing-s{ grid-row: 2; }
.floor[data-n="3"] .wing-f, .floor[data-n="4"] .wing-f, .floor[data-n="5"] .wing-f, .floor[data-n="6"] .wing-f, .floor[data-n="7"] .wing-f{ grid-row: 1; }
.floor[data-n="3"] .wing-d, .floor[data-n="4"] .wing-d, .floor[data-n="5"] .wing-d, .floor[data-n="6"] .wing-d, .floor[data-n="7"] .wing-d{ grid-row: 2; }
.floor[data-n="3"] .wing-p, .floor[data-n="4"] .wing-p, .floor[data-n="5"] .wing-p, .floor[data-n="6"] .wing-p, .floor[data-n="7"] .wing-p{ grid-row: 3; }
.floor[data-n="3"] .wing-s, .floor[data-n="4"] .wing-s, .floor[data-n="5"] .wing-s, .floor[data-n="6"] .wing-s, .floor[data-n="7"] .wing-s{ grid-row: 4; }

/* ===== Enhanced Units and Slots for Mobile ===== */
.wing-title{
  color:#fff;
  font-size:14px;
  margin-bottom:8px;
  display:flex;
  align-items:center;
  gap:8px;
}

/* Mobile wing title adjustments */
@media (max-width: 480px) {
  .wing-title {
    font-size: 13px;
    margin-bottom: 6px;
    gap: 6px;
  }
}

.units{
  display:flex;
  gap:10px;
  flex-wrap:wrap;
}

/* Mobile units adjustments */
@media (max-width: 768px) {
  .units {
    gap: 8px;
  }
}

@media (max-width: 480px) {
  .units {
    gap: 6px;
  }
}

.unit{
  width:140px;
  min-height:86px;
  background:rgba(30,41,59,0.9);
  border:2px solid var(--secondary);
  border-radius:15px;
  padding:8px;
  position:relative;
  backdrop-filter:blur(10px);
}

/* Mobile unit adjustments */
@media (max-width: 1024px) {
  .unit {
    width: 120px;
    min-height: 76px;
  }
}

@media (max-width: 768px) {
  .unit {
    width: 100px;
    min-height: 66px;
    border-radius: 12px;
    padding: 6px;
  }
}

@media (max-width: 480px) {
  .unit {
    width: 90px;
    min-height: 60px;
    border-radius: 10px;
    padding: 5px;
  }
}

.unit.ghost{box-shadow:0 0 0 3px rgba(245,158,11,.45) inset,0 0 12px rgba(245,158,11,.35)}
.unit.invalid{animation:shake .2s linear 1;border-color:var(--danger)}

@keyframes shake{0%{transform:translateX(0)}25%{transform:translateX(-2px)}50%{transform:translateX(2px)}75%{transform:translateX(-1px)}100%{transform:translateX(0)}}
@keyframes pulse{0%{box-shadow:0 0 0 0 rgba(245,158,11,.8);transform:scale(1)}70%{box-shadow:0 0 0 8px rgba(245,158,11,0);transform:scale(1.04)}100%{box-shadow:0 0 0 0 rgba(245,158,11,0)}}

.slot.ghost-slot{animation:pulse 1.2s ease-in-out infinite;border-color:var(--warning)}

.unit-label{
  position:absolute;
  top:6px;
  right:8px;
  font-size:12px;
  color:var(--warning);
}

/* Mobile unit label adjustments */
@media (max-width: 480px) {
  .unit-label {
    font-size: 11px;
    top: 4px;
    right: 6px;
  }
}

.slots{
  display:flex;
  gap:8px;
  margin-top:22px;
  flex-wrap:wrap;
}

/* Mobile slots adjustments */
@media (max-width: 768px) {
  .slots {
    gap: 6px;
    margin-top: 18px;
  }
}

@media (max-width: 480px) {
  .slots {
    gap: 5px;
    margin-top: 16px;
  }
}

.slot{
  width:34px;
  height:34px;
  border-radius:50%;
  background:rgba(15,23,42,0.9);
  border:2px solid var(--secondary);
  display:flex;
  align-items:center;
  justify-content:center;
  color:#ffffff;
  font-weight:900;
  font-size:16px;
  cursor:pointer;
  backdrop-filter:blur(10px);
  min-width: 44px; /* Touch-friendly */
  min-height: 44px; /* Touch-friendly */
}

/* Mobile slot adjustments */
@media (max-width: 768px) {
  .slot {
    width: 40px;
    height: 40px;
    font-size: 15px;
  }
}

@media (max-width: 480px) {
  .slot {
    width: 36px;
    height: 36px;
    font-size: 14px;
    min-width: 36px;
    min-height: 36px;
  }
}

/* ===== Enhanced Lobby and Electrons for Mobile ===== */
.lobby{
  background:rgba(30,41,59,0.9);
  border:2px solid var(--border);
  border-radius:20px;
  padding:12px;
  backdrop-filter:blur(10px);
}

/* Mobile lobby adjustments */
@media (max-width: 768px) {
  .lobby {
    border-radius: var(--border-radius-mobile);
    padding: var(--padding-small-mobile);
  }
}

@media (max-width: 480px) {
  .lobby {
    padding: var(--padding-small-mobile);
  }
}

.lobby-title{
  font-weight:900;
  margin-bottom:8px;
}

/* Mobile lobby title adjustments */
@media (max-width: 480px) {
  .lobby-title {
    font-size: 15px;
    margin-bottom: 6px;
  }
}

.lobby-area{
  min-height:70px;
  display:flex;
  align-items:center;
  gap:10px;
  padding:8px;
  border:2px dashed var(--secondary);
  border-radius:15px;
  background:rgba(30,41,59,0.8);
  backdrop-filter:blur(10px);
}

/* Mobile lobby area adjustments */
@media (max-width: 768px) {
  .lobby-area {
    min-height: 60px;
    border-radius: 12px;
    padding: 6px;
    gap: 8px;
  }
}

@media (max-width: 480px) {
  .lobby-area {
    min-height: 50px;
    border-radius: 10px;
    padding: 5px;
    gap: 6px;
  }
}

.electron{
  width:46px;
  height:46px;
  border-radius:50%;
  background:rgba(15,23,42,0.9);
  border:3px solid var(--secondary);
  display:flex;
  align-items:center;
  justify-content:center;
  color:#ffffff;
  font-weight:900;
  user-select:none;
  backdrop-filter:blur(10px);
  min-width: 44px; /* Touch-friendly */
  min-height: 44px; /* Touch-friendly */
}

.electron[draggable="true"]{cursor:grab}
.electron:active{cursor:grabbing}
.electron.up{border-color:var(--success)}
.electron.down{border-color:var(--danger)}

/* Mobile electron adjustments */
@media (max-width: 768px) {
  .electron {
    width: 50px;
    height: 50px;
    border-width: 2px;
    font-size: 15px;
  }
}

@media (max-width: 480px) {
  .electron {
    width: 44px;
    height: 44px;
    font-size: 14px;
    min-width: 44px;
    min-height: 44px;
  }
}

.lobby-actions{
  display:flex;
  align-items:center;
  gap:10px;
  margin-top:10px;
}

/* Mobile lobby actions adjustments */
@media (max-width: 768px) {
  .lobby-actions {
    gap: 8px;
    margin-top: 8px;
    flex-wrap: wrap;
    justify-content: center;
  }
}

@media (max-width: 480px) {
  .lobby-actions {
    gap: 6px;
    margin-top: 6px;
  }
}

.queue-info{
  margin-left:auto;
  color:var(--warning);
}

/* Mobile queue info adjustments */
@media (max-width: 768px) {
  .queue-info {
    margin-left: 0;
    margin-top: 8px;
    text-align: center;
    width: 100%;
  }
}

/* ===== Enhanced Footer and Modals for Mobile ===== */
.app-footer{
  text-align:center;
  padding:14px;
  color:var(--warning);
  border-top:3px solid var(--accent);
  background:rgba(99,102,241,0.9);
  backdrop-filter:blur(10px);
}

/* Mobile footer adjustments */
@media (max-width: 768px) {
  .app-footer {
    padding: 12px;
  }
}

@media (max-width: 480px) {
  .app-footer {
    padding: 10px;
    font-size: 14px;
  }
}

.badge{
  display:inline-block;
  padding:2px 6px;
  border-radius:12px;
  font-size:11px;
  background:rgba(15,23,42,0.9);
  border:2px solid var(--secondary);
  color:#fff;
  backdrop-filter:blur(10px);
}

/* Mobile badge adjustments */
@media (max-width: 480px) {
  .badge {
    padding: 3px 8px;
    font-size: 12px;
    border-radius: 10px;
  }
}

/* ===== Enhanced Modals for Mobile ===== */
.modal-backdrop{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.55);
  display:flex;
  align-items:center;
  justify-content:center;
  z-index:2000;
  padding: 20px;
}

.modal-backdrop.hidden{visibility:hidden;opacity:0}

.modal{
  width:min(720px,92vw);
  background:rgba(30,41,59,0.95);
  border:2px solid var(--border);
  border-radius:20px;
  padding:12px;
  box-shadow:0 10px 40px rgba(0,0,0,.5);
  backdrop-filter:blur(10px);
  max-height: 90vh;
  overflow-y: auto;
}

/* Mobile modal adjustments */
@media (max-width: 768px) {
  .modal-backdrop {
    padding: 16px;
    align-items: flex-start;
    padding-top: 40px;
  }
  
  .modal {
    width: 95vw;
    border-radius: var(--border-radius-mobile);
    padding: var(--padding-small-mobile);
    max-height: 85vh;
  }
}

@media (max-width: 480px) {
  .modal-backdrop {
    padding: 12px;
    padding-top: 30px;
  }
  
  .modal {
    width: 98vw;
    padding: var(--padding-small-mobile);
    max-height: 80vh;
  }
}
/* ===== Enhanced Modal Content for Mobile ===== */
.modal-header{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
}

/* Mobile modal header adjustments */
@media (max-width: 768px) {
  .modal-header {
    flex-direction: column;
    gap: 8px;
    text-align: center;
  }
}

.modal-body{
  padding:20px;
  max-height:60vh;
  overflow-y:auto;
}

/* Mobile modal body adjustments */
@media (max-width: 768px) {
  .modal-body {
    padding: var(--padding-mobile);
    max-height: 70vh;
  }
}

@media (max-width: 480px) {
  .modal-body {
    padding: var(--padding-small-mobile);
    max-height: 75vh;
  }
}

.tabbar{
  display:flex;
  gap:8px;
  margin:10px 0;
  flex-wrap: wrap;
}

.tab{
  background:rgba(15,23,42,0.8);
  color:#fff;
  border:2px solid var(--border);
  border-radius:15px;
  padding:8px 12px;
  cursor:pointer;
  transition:all 0.3s ease;
  min-height: 44px; /* Touch-friendly */
  display: flex;
  align-items: center;
  justify-content: center;
}

.tab:hover{background:rgba(255,255,255,0.1)}
.tab.active{background:var(--success)}
.tabpanel.hidden{display:none}

/* Mobile tab adjustments */
@media (max-width: 768px) {
  .tabbar {
    gap: 6px;
    margin: 8px 0;
    justify-content: center;
  }
  
  .tab {
    padding: 10px 16px;
    min-height: 48px;
    font-size: 14px;
    border-radius: 12px;
  }
}

@media (max-width: 480px) {
  .tabbar {
    gap: 4px;
    margin: 6px 0;
  }
  
  .tab {
    padding: 8px 12px;
    min-height: 44px;
    font-size: 13px;
    border-radius: 10px;
  }
}

.modal-footer{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
}

/* Mobile modal footer adjustments */
@media (max-width: 768px) {
  .modal-footer {
    flex-direction: column;
    gap: 12px;
    text-align: center;
  }
}

.modal-actions{
  display:flex;
  gap:10px;
  flex-wrap: wrap;
  justify-content: center;
}

/* Mobile modal actions adjustments */
@media (max-width: 480px) {
  .modal-actions {
    gap: 8px;
  }
}

/* ======= Custom Logo-Based Emojis ======= */
.custom-emoji {
  display: inline-block;
  width: 1.2em;
  height: 1.2em;
  vertical-align: middle;
  position: relative;
}

.emoji-scientist {
  background: linear-gradient(135deg, #87CEEB 0%, #B0E0E6 100%);
  border-radius: 50%;
  border: 2px solid #8b5cf6;
}

.emoji-scientist::before {
  content: '';
  position: absolute;
  top: 2px;
  left: 50%;
  transform: translateX(-50%);
  width: 8px;
  height: 6px;
  background: #8b5cf6;
  border-radius: 4px 4px 2px 2px;
}

.emoji-scientist::after {
  content: '';
  position: absolute;
  top: 8px;
  left: 50%;
  transform: translateX(-50%);
  width: 6px;
  height: 4px;
  background: #fbbf24;
  border-radius: 3px;
}

.emoji-atom {
  background: white;
  border: 2px solid #8b5cf6;
  border-radius: 50%;
}

.emoji-atom::before {
  content: '';
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  width: 3px;
  height: 3px;
  background: #8b5cf6;
  border-radius: 50%;
}

.emoji-beaker {
  background: #8b5cf6;
  border: 1px solid white;
  border-radius: 2px 2px 0 0;
  width: 8px;
  height: 10px;
}

.emoji-beaker::after {
  content: '';
  position: absolute;
  top: -1px;
  right: 1px;
  width: 2px;
  height: 2px;
  background: white;
  border-radius: 50%;
}

.emoji-syringe {
  background: white;
  border: 1px solid #8b5cf6;
  border-radius: 1px;
  width: 4px;
  height: 12px;
}

.emoji-syringe::before {
  content: '';
  position: absolute;
  top: -2px;
  left: 1px;
  width: 2px;
  height: 2px;
  background: #8b5cf6;
  border-radius: 50%;
}

.emoji-star {
  background: white;
  clip-path: polygon(50% 0%, 61% 35%, 98% 35%, 68% 57%, 79% 91%, 50% 70%, 21% 91%, 32% 57%, 2% 35%, 39% 35%);
  width: 10px;
  height: 10px;
}

.emoji-electron {
  background: #06b6d4;
  border-radius: 50%;
  width: 8px;
  height: 8px;
  box-shadow: 0 0 4px #06b6d4;
}

.emoji-nucleus {
  background: #ef4444;
  border-radius: 50%;
  width: 10px;
  height: 10px;
  box-shadow: 0 0 4px #ef4444;
}

.emoji-energy {
  background: #f59e0b;
  border-radius: 50%;
  width: 8px;
  height: 8px;
  box-shadow: 0 0 4px #f59e0b;
}

.emoji-study {
  background: #10b981;
  border-radius: 50%;
  width: 10px;
  height: 10px;
  box-shadow: 0 0 4px #10b981;
}

.emoji-game {
  background: #8b5cf6;
  border-radius: 50%;
  width: 10px;
  height: 10px;
  box-shadow: 0 0 4px #8b5cf6;
}

/* ======= Version Modal Styles ======= */
.version-header {
  display: flex;
  align-items: center;
  gap: 20px;
  flex: 1;
}

.app-logo {
  position: relative;
  width: 100px;
  height: 100px;
  flex-shrink: 0;
  background: linear-gradient(135deg, #87CEEB 0%, #B0E0E6 100%);
  border-radius: 20px;
  padding: 10px;
  box-shadow: 0 4px 15px rgba(0,0,0,0.1);
}

.logo-boy {
  position: relative;
  width: 100%;
  height: 100%;
}

.logo-hair {
  position: absolute;
  top: 8px;
  left: 25px;
  width: 50px;
  height: 30px;
  background: linear-gradient(135deg, #8b5cf6 0%, #a855f7 100%);
  border-radius: 25px 25px 20px 20px;
  box-shadow: 0 3px 8px rgba(139, 92, 246, 0.4);
}

.logo-hair::before {
  content: '';
  position: absolute;
  top: -2px;
  left: 8px;
  width: 12px;
  height: 12px;
  background: #8b5cf6;
  border-radius: 50%;
}

.logo-hair::after {
  content: '';
  position: absolute;
  top: 2px;
  right: 5px;
  width: 12px;
  height: 12px;
  background: #8b5cf6;
  border-radius: 50%;
}

.logo-face {
  position: absolute;
  top: 32px;
  left: 30px;
  width: 40px;
  height: 32px;
  background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
  border-radius: 20px;
  box-shadow: 0 3px 8px rgba(0,0,0,0.2);
}

.logo-face::before {
  content: '';
  position: absolute;
  width: 8px;
  height: 6px;
  background: #fca5a5;
  border-radius: 50%;
  top: 8px;
  left: 4px;
}

.logo-face::after {
  content: '';
  position: absolute;
  width: 8px;
  height: 6px;
  background: #fca5a5;
  border-radius: 50%;
  top: 8px;
  right: 4px;
}

.logo-eyes {
  position: absolute;
  top: 10px;
  left: 8px;
  display: flex;
  gap: 12px;
}

.logo-eye {
  width: 8px;
  height: 8px;
  background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%);
  border-radius: 50%;
  position: relative;
  box-shadow: 0 2px 4px rgba(0,0,0,0.3);
}

.logo-eye::after {
  content: '';
  position: absolute;
  top: 1px;
  right: 1px;
  width: 3px;
  height: 3px;
  background: white;
  border-radius: 50%;
  box-shadow: 0 1px 2px rgba(0,0,0,0.2);
}

.logo-glasses {
  position: absolute;
  top: 8px;
  left: 4px;
  width: 32px;
  height: 14px;
  border: 3px solid #1e293b;
  border-radius: 16px;
  background: transparent;
  box-shadow: 0 2px 4px rgba(0,0,0,0.3);
}

.logo-smile {
  position: absolute;
  bottom: 6px;
  left: 12px;
  width: 16px;
  height: 10px;
  border: 2px solid #dc2626;
  border-top: none;
  border-radius: 0 0 16px 16px;
  box-shadow: 0 1px 3px rgba(0,0,0,0.2);
}

.logo-labcoat {
  position: absolute;
  top: 58px;
  left: 20px;
  width: 60px;
  height: 35px;
  background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
  border-radius: 10px 10px 0 0;
  border: 2px solid #e5e7eb;
  box-shadow: 0 3px 8px rgba(0,0,0,0.1);
}

.logo-tie {
  position: absolute;
  top: 65px;
  left: 42px;
  width: 12px;
  height: 25px;
  background: linear-gradient(135deg, #8b5cf6 0%, #a855f7 100%);
  border-radius: 6px;
  box-shadow: 0 2px 4px rgba(0,0,0,0.2);
}

.logo-atoms {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  pointer-events: none;
}

.logo-atom {
  position: absolute;
  width: 24px;
  height: 24px;
  border: 3px solid white;
  border-radius: 50%;
  background: transparent;
  box-shadow: 0 2px 6px rgba(255,255,255,0.3);
}

.logo-atom::before {
  content: '';
  position: absolute;
  top: 50%;
  left: 50%;
  width: 6px;
  height: 6px;
  background: white;
  border-radius: 50%;
  transform: translate(-50%, -50%);
  box-shadow: 0 1px 3px rgba(0,0,0,0.2);
}

/* Add electron orbits */
.logo-atom::after {
  content: '';
  position: absolute;
  top: -4px;
  left: -4px;
  width: 32px;
  height: 32px;
  border: 1px solid rgba(255,255,255,0.6);
  border-radius: 50%;
}

.logo-atom.top-left {
  top: 5px;
  left: 5px;
}

.logo-atom.top-right {
  top: 5px;
  right: 5px;
}

.logo-beakers {
  position: absolute;
  bottom: 0;
  left: 0;
  width: 100%;
  height: 100%;
  pointer-events: none;
}

.logo-beaker {
  position: absolute;
  width: 18px;
  height: 24px;
  background: linear-gradient(135deg, #8b5cf6 0%, #a855f7 100%);
  border-radius: 10px 10px 0 0;
  border: 2px solid white;
  box-shadow: 0 2px 6px rgba(139, 92, 246, 0.3);
}

/* Add liquid and bubbles */
.logo-beaker::before {
  content: '';
  position: absolute;
  bottom: 2px;
  left: 2px;
  width: 14px;
  height: 18px;
  background: linear-gradient(135deg, #a855f7 0%, #8b5cf6 100%);
  border-radius: 8px 8px 0 0;
}

.logo-beaker::after {
  content: '';
  position: absolute;
  top: -2px;
  right: 2px;
  width: 4px;
  height: 4px;
  background: white;
  border-radius: 50%;
  box-shadow: 0 1px 2px rgba(0,0,0,0.2);
}

.logo-beaker.left {
  bottom: 5px;
  left: 5px;
}

.logo-beaker.right {
  bottom: 5px;
  right: 5px;
}

.logo-syringes {
  position: absolute;
  bottom: 0;
  left: 0;
  width: 100%;
  height: 100%;
  pointer-events: none;
}

.logo-syringe {
  position: absolute;
  width: 10px;
  height: 28px;
  background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
  border: 2px solid #8b5cf6;
  border-radius: 5px;
  box-shadow: 0 2px 6px rgba(0,0,0,0.1);
}

/* Add syringe details */
.logo-syringe::before {
  content: '';
  position: absolute;
  top: -3px;
  left: 2px;
  width: 6px;
  height: 6px;
  background: #8b5cf6;
  border-radius: 50%;
}

.logo-syringe::after {
  content: '';
  position: absolute;
  bottom: 2px;
  left: 2px;
  width: 6px;
  height: 12px;
  background: linear-gradient(135deg, #a855f7 0%, #8b5cf6 100%);
  border-radius: 3px;
}

.logo-syringe.left {
  bottom: 5px;
  left: 25px;
}

.logo-syringe.right {
  bottom: 5px;
  right: 25px;
}

/* Add additional scientific elements */
.logo-stars {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  pointer-events: none;
}

.logo-star {
  position: absolute;
  width: 6px;
  height: 6px;
  background: white;
  clip-path: polygon(50% 0%, 61% 35%, 98% 35%, 68% 57%, 79% 91%, 50% 70%, 21% 91%, 32% 57%, 2% 35%, 39% 35%);
}

.logo-star:nth-child(1) {
  top: 15px;
  left: 15px;
}

.logo-star:nth-child(2) {
  top: 25px;
  right: 20px;
}

.logo-star:nth-child(3) {
  bottom: 20px;
  left: 20px;
}

.logo-star:nth-child(4) {
  bottom: 30px;
  right: 15px;
}

.version-info {
  flex: 1;
}

.version-info h3 {
  margin: 0 0 8px 0;
  color: var(--light);
  font-size: 24px;
}

.current-version {
  margin: 0 0 4px 0;
  color: var(--warning);
  font-size: 16px;
}

.version-tagline {
  margin: 0;
  color: var(--light);
  opacity: 0.8;
  font-size: 14px;
}

.version-timeline {
  display: flex;
  flex-direction: column;
  gap: 20px;
}

.version-entry {
  display: flex;
  gap: 20px;
  padding: 20px;
  background: rgba(30, 41, 59, 0.5);
  border: 2px solid var(--border);
  border-radius: 15px;
  transition: all 0.3s ease;
}

.version-entry:hover {
  border-color: var(--accent);
  transform: translateY(-2px);
  box-shadow: var(--shadow);
}

.version-entry.current {
  border-color: var(--success);
  background: rgba(16, 185, 129, 0.1);
}

.version-badge {
  background: var(--primary);
  color: white;
  padding: 8px 12px;
  border-radius: 20px;
  font-weight: 800;
  font-size: 14px;
  white-space: nowrap;
  flex-shrink: 0;
  height: fit-content;
}

.version-entry.current .version-badge {
  background: var(--success);
}

.version-content {
  flex: 1;
}

.version-content h4 {
  margin: 0 0 8px 0;
  color: var(--light);
  font-size: 18px;
}

.version-date {
  margin: 0 0 16px 0;
  color: var(--accent);
  font-size: 14px;
  font-weight: 600;
}

.version-features h5 {
  margin: 16px 0 8px 0;
  color: var(--warning);
  font-size: 14px;
}

.version-features ul {
  margin: 0 0 16px 0;
  padding-left: 20px;
}

.version-features li {
  margin: 4px 0;
  color: var(--light);
  font-size: 14px;
  line-height: 1.4;
}

.version-features strong {
  color: var(--accent);
}

/* Game Welcome Modal Styles */
.welcome-section{margin-bottom:20px}
.welcome-section h4{color:var(--success);margin-bottom:8px;font-size:16px}
.welcome-section p{margin-bottom:12px;line-height:1.5}
.welcome-section ul{margin:8px 0;padding-left:20px}
.welcome-section li{margin-bottom:6px;line-height:1.4}

.scoring-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin:15px 0}
.score-item{padding:10px;border-radius:8px;text-align:center;font-weight:600}
.score-item.correct{background:rgba(72,187,120,0.2);border:2px solid #48bb78;color:#48bb78}
.score-item.hund{background:rgba(66,153,225,0.2);border:2px solid #4299e1;color:#4299e1}
.score-item.pauli{background:rgba(237,137,54,0.2);border:2px solid #ed8936;color:#ed8936}
.score-item.wrong{background:rgba(245,101,101,0.2);border:2px solid #f56565;color:#f56565}

/* Element Reveal Animation */
.element-reveal{animation:elementReveal 1.5s ease-out}
@keyframes elementReveal{
  0%{transform:scale(0.5);opacity:0}
  50%{transform:scale(1.2);opacity:0.8}
  100%{transform:scale(1);opacity:1}
}

/* Configuration Display Area */
.config-section{
  margin:16px 0;
  width:100%;
}

.config-display{
  background:rgba(30,41,59,0.9);
  border:2px solid var(--border);
  border-radius:20px;
  padding:20px;
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:16px;
  backdrop-filter:blur(10px);
  width:100%;
}

.config-item{
  display:flex;
  flex-direction:column;
  gap:4px;
}

.config-item.config-full-width{
  grid-column:span 2;
}

.config-label{
  color:var(--warning);
  font-weight:700;
  font-size:14px;
  text-transform:uppercase;
  letter-spacing:0.5px;
}

.config-value{
  color:#fff;
  font-weight:600;
  font-size:18px;
  line-height:1.3;
  word-break:break-word;
}

.config-value#newCurrentConfig,
.config-value#newShorthandConfig{
  font-family:monospace;
  font-size:16px;
  background:rgba(15,23,42,0.5);
  padding:8px 12px;
  border-radius:8px;
  border:1px solid var(--secondary);
  min-height:40px;
  display:flex;
  align-items:center;
  word-break:break-word;
  overflow-wrap:break-word;
}

/* Ensure superscript formatting is properly displayed */
.config-value#newCurrentConfig,
.config-value#newShorthandConfig {
  color: #e2e8f0; /* Light text color */
}

/* Color coding for energy levels - Full Configuration */
.config-value#newCurrentConfig .energy-level-1s { color: #3b82f6; } /* Blue for 1s */
.config-value#newCurrentConfig .energy-level-2s { color: #10b981; } /* Green for 2s */
.config-value#newCurrentConfig .energy-level-2p { color: #f59e0b; } /* Orange for 2p */
.config-value#newCurrentConfig .energy-level-3s { color: #8b5cf6; } /* Purple for 3s */
.config-value#newCurrentConfig .energy-level-3p { color: #ef4444; } /* Red for 3p */
.config-value#newCurrentConfig .energy-level-3d { color: #06b6d4; } /* Cyan for 3d */
.config-value#newCurrentConfig .energy-level-4s { color: #84cc16; } /* Lime for 4s */
.config-value#newCurrentConfig .energy-level-4p { color: #f97316; } /* Orange-red for 4p */
.config-value#newCurrentConfig .energy-level-4d { color: #ec4899; } /* Pink for 4d */
.config-value#newCurrentConfig .energy-level-4f { color: #a855f7; } /* Violet for 4f */
.config-value#newCurrentConfig .energy-level-5s { color: #22c55e; } /* Green for 5s */
.config-value#newCurrentConfig .energy-level-5p { color: #f43f5e; } /* Rose for 5p */
.config-value#newCurrentConfig .energy-level-5d { color: #14b8a6; } /* Teal for 5d */
.config-value#newCurrentConfig .energy-level-5f { color: #a855f7; } /* Violet for 5f */
.config-value#newCurrentConfig .energy-level-6s { color: #65a30d; } /* Lime for 6s */
.config-value#newCurrentConfig .energy-level-6p { color: #ea580c; } /* Orange for 6p */
.config-value#newCurrentConfig .energy-level-6d { color: #db2777; } /* Pink for 6d */
.config-value#newCurrentConfig .energy-level-6f { color: #9333ea; } /* Purple for 6f */
.config-value#newCurrentConfig .energy-level-7s { color: #4ade80; } /* Green for 7s */
.config-value#newCurrentConfig .energy-level-7p { color: #fb923c; } /* Orange for 7p */
.config-value#newCurrentConfig .energy-level-7d { color: #06b6d4; } /* Cyan for 7d */
.config-value#newCurrentConfig .energy-level-7f { color: #c084fc; } /* Purple for 7f */

/* Color coding for energy levels - Shorthand (same colors) */
.config-value#newShorthandConfig .energy-level-1s { color: #3b82f6; } /* Blue for 1s */
.config-value#newShorthandConfig .energy-level-2s { color: #10b981; } /* Green for 2s */
.config-value#newCurrentConfig .energy-level-2p { color: #f59e0b; } /* Orange for 2p */
.config-value#newShorthandConfig .energy-level-2p { color: #f59e0b; } /* Orange for 2p */
.config-value#newShorthandConfig .energy-level-3s { color: #8b5cf6; } /* Purple for 3s */
.config-value#newShorthandConfig .energy-level-3p { color: #ef4444; } /* Red for 3p */
.config-value#newShorthandConfig .energy-level-3d { color: #06b6d4; } /* Cyan for 3d */
.config-value#newShorthandConfig .energy-level-4s { color: #84cc16; } /* Lime for 4s */
.config-value#newShorthandConfig .energy-level-4p { color: #f97316; } /* Orange-red for 4p */
.config-value#newShorthandConfig .energy-level-4d { color: #ec4899; } /* Pink for 4d */
.config-value#newShorthandConfig .energy-level-4f { color: #a855f7; } /* Violet for 4f */
.config-value#newShorthandConfig .energy-level-5s { color: #22c55e; } /* Green for 5s */
.config-value#newShorthandConfig .energy-level-5p { color: #f43f5e; } /* Rose for 5p */
.config-value#newShorthandConfig .energy-level-5d { color: #14b8a6; } /* Teal for 5d */
.config-value#newShorthandConfig .energy-level-5f { color: #a855f7; } /* Violet for 5f */
.config-value#newShorthandConfig .energy-level-6s { color: #65a30d; } /* Lime for 6s */
.config-value#newShorthandConfig .energy-level-6p { color: #ea580c; } /* Orange for 6p */
.config-value#newShorthandConfig .energy-level-6d { color: #db2777; } /* Pink for 6d */
.config-value#newShorthandConfig .energy-level-6f { color: #9333ea; } /* Purple for 6f */
.config-value#newShorthandConfig .energy-level-7s { color: #4ade80; } /* Green for 7s */
.config-value#newShorthandConfig .energy-level-7p { color: #fb923c; } /* Orange for 7p */
.config-value#newShorthandConfig .energy-level-7d { color: #06b6d4; } /* Cyan for 7d */
.config-value#newShorthandConfig .energy-level-7f { color: #c084fc; } /* Purple for 7f */

/* Noble gas notation in gold */
.config-value#newShorthandConfig .noble-gas {
  color: #fbbf24; /* Gold color */
  font-weight: bold;
}

/* Ion state styling */
.config-value.positive-ion {
  background: rgba(255, 243, 205, 0.9) !important;
  border-color: #ffeaa7 !important;
  color: #856404 !important;
}

.config-value.negative-ion {
  background: rgba(209, 236, 241, 0.9) !important;
  border-color: #bee5eb !important;
  color: #0c5460 !important;
}

/* Ion charge info display */
.ion-info {
  font-size: 11px;
  color: #666;
  margin-left: 8px;
  cursor: pointer;
  padding: 2px 6px;
  border-radius: 3px;
  background: rgba(0,0,0,0.1);
  transition: background 0.2s;
}

.ion-info:hover {
  background: rgba(0,0,0,0.2);
}

/* Congratulations Modal Styles */
.congrats-section{margin-bottom:20px}
.congrats-section h4{color:var(--success);margin-bottom:8px;font-size:16px}
.congrats-section p{margin-bottom:12px;line-height:1.5}

.score-display{display:grid;grid-template-columns:1fr;gap:12px;margin:15px 0}
.score-item{padding:15px;border-radius:8px;text-align:center;font-weight:600;font-size:18px}
.score-item.total{background:rgba(72,187,120,0.2);border:2px solid #48bb78;color:#48bb78}
.score-item.time{background:rgba(66,153,225,0.2);border:2px solid #4299e1;color:#4299e1}
.score-item.streak{background:rgba(237,137,54,0.2);border:2px solid #ed8936;color:#ed8936}

/* Toggle Button Styles */
.toggle-group{display:flex;gap:12px;align-items:center;justify-content:center}
.toggle-btn{display:flex;align-items:center;gap:8px;cursor:pointer;padding:10px 16px;background:rgba(255,255,255,0.1);border:2px solid var(--border);border-radius:15px;color:var(--light);transition:all 0.3s ease;backdrop-filter:blur(10px);min-width:120px;justify-content:center}
.toggle-btn:hover{background:rgba(255,255,255,0.2);transform:translateY(-1px)}
.toggle-btn input[type="checkbox"]{display:none}
/* ===== Enhanced Toggle Controls for Mobile ===== */
.toggle-btn input[type="checkbox"]:checked + .toggle-label{color:var(--success)}
.toggle-btn input[type="checkbox"]:checked{background:rgba(16,185,129,0.2);border-color:var(--success)}
.toggle-label{font-weight:600;font-size:14px;text-align:center}

/* Mobile toggle adjustments */
@media (max-width: 768px) {
  .toggle-btn {
    min-height: 48px;
    padding: 8px 12px;
    border-radius: 12px;
  }
  
  .toggle-label {
    font-size: 14px;
    padding: 8px 12px;
  }
}

@media (max-width: 480px) {
  .toggle-btn {
    min-height: 44px;
    padding: 6px 10px;
    border-radius: 10px;
  }
  
  .toggle-label {
    font-size: 13px;
    padding: 6px 10px;
  }
}

@media (max-width:980px){.below-ptable{grid-template-columns:1fr}.game-area{grid-template-columns:24px 1fr}}

/* Group & Period labels */
.group-label{align-self:end;justify-self:center;font-weight:900;font-size:calc(var(--tile)*.22);color:var(--warning);opacity:.9}
.group-label.small{font-size:12px;opacity:.75}
.period-label{align-self:center;justify-self:center;font-weight:900;font-size:calc(var(--tile)*.28);color:var(--warning);opacity:.9;border:2px solid var(--secondary);border-radius:12px;padding:2px 4px;background:rgba(15,23,42,0.9);backdrop-filter:blur(10px)}

/* === Diagonal Aufbau diagram (dashed, rounded arrowheads) === */
.aufbau-diagram svg{width:100%;height:auto;max-width:720px;display:block;margin:auto}
.aufbau-diagram .cell{fill:rgba(30,41,59,0.9);stroke:var(--secondary);stroke-width:2}
.aufbau-diagram .celltext{fill:#fff;font-weight:900;font-size:16px;letter-spacing:.5px}
.aufbau-diagram .headtext{fill:var(--warning);font-weight:900;font-size:14px}
.aufbau-diagram .arrow{stroke:var(--warning);stroke-width:2.2;opacity:.72;fill:none;stroke-dasharray:8 8;stroke-linecap:round;stroke-linejoin:round}
.aufbau-diagram .badgebox{fill:rgba(139,92,246,0.3);stroke:var(--secondary);stroke-width:1.2}
.aufbau-diagram .badgetext{fill:var(--warning);font-weight:900;font-size:12px}

/* === Enhanced Mobile Optimizations === */
@media (max-width: 1024px){ :root{ --tile:44px; } }
@media (max-width: 820px){ :root{ --tile:40px; } }
@media (max-width: 600px){ :root{ --tile:36px; } }
@media (max-width: 430px){ :root{ --tile:32px; } }

/* Mobile-specific tile sizing for better usability */
@media (max-width: 768px) {
  :root {
    --tile: 56px; /* Even larger tiles on mobile for better touch interaction */
  }
}

@media (max-width: 480px) {
  :root {
    --tile: 52px; /* Larger tiles for small mobile screens */
  }
}

/* Enhanced mobile optimizations */
html, body{ 
  -webkit-text-size-adjust: 100%; 
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

* { 
  -webkit-tap-highlight-color: rgba(0,0,0,0); 
  -webkit-touch-callout: none;
  -webkit-user-select: none;
  -khtml-user-select: none;
  -moz-user-select: none;
  -ms-user-select: none;
  user-select: none;
}

/* Allow text selection in specific areas */
input, textarea, .search, .ptile .sym, .ptile .z {
  -webkit-user-select: text;
  -khtml-user-select: text;
  -moz-user-select: text;
  -ms-user-select: text;
  user-select: text;
}

.ptile { 
  touch-action: manipulation; 
}

/* Enhanced touch feedback for mobile */
@media (max-width: 768px) {
  .btn:active,
  .seg-btn:active,
  .tab:active,
  .ptile:active {
    transform: scale(0.95);
    transition: transform 0.1s ease;
  }
  
  /* Disable hover effects on mobile */
  .btn:hover,
  .seg-btn:hover,
  .tab:hover,
  .ptile:hover {
    transform: none;
  }
}

/* iPad-specific optimizations */
@media (min-width: 768px) and (max-width: 1024px) and (orientation: landscape) {
  .below-ptable {
    grid-template-columns: 320px 1fr;
    gap: 14px;
  }
  
  .unit {
    width: 110px;
    min-height: 70px;
  }
  
  .slot {
    width: 38px;
    height: 38px;
  }
  
  /* Top toolbar optimizations for iPad landscape */
  .toolbar {
    gap: 16px;
    padding: 20px;
  }
  
  .toolbar .group {
    gap: 10px;
  }
  
  .seg-btn {
    min-width: 100px;
    min-height: 44px;
  }
  
  .ion-box {
    min-width: 44px;
    min-height: 44px;
  }
}

@media (min-width: 768px) and (max-width: 1024px) and (orientation: portrait) {
  .below-ptable {
    grid-template-columns: 1fr;
    gap: 16px;
  }
  
  .sidebar {
    order: 2;
  }
  
  .app-header {
    flex-direction: row;
    align-items: center;
    gap: 12px;
  }
  
  .app-header .right {
    order: 0;
    margin-left: auto;
  }
  
  /* Top toolbar optimizations for iPad portrait */
  .toolbar {
    flex-direction: column;
    gap: 14px;
    padding: 18px;
  }
  
  .toolbar .group {
    flex-direction: row;
    justify-content: center;
    gap: 12px;
    padding: 14px;
    background: rgba(15, 23, 42, 0.3);
    border-radius: 14px;
    border: 1px solid var(--border);
  }
  
  .seg-btn {
    min-width: 110px;
    min-height: 46px;
  }
  
  .ion-box {
    min-width: 46px;
    min-height: 46px;
  }
}

/* ======= Enhanced Help Styles ======= */
.help-section {
  margin-bottom: 30px;
}

.help-section h4 {
  color: var(--accent);
  margin-bottom: 20px;
  font-size: 18px;
  display: flex;
  align-items: center;
  gap: 10px;
}

.help-steps {
  display: flex;
  flex-direction: column;
  gap: 20px;
}

.help-step {
  display: flex;
  gap: 15px;
  align-items: flex-start;
  padding: 15px;
  background: rgba(30, 41, 59, 0.3);
  border-radius: 12px;
  border: 1px solid var(--border);
}

.step-number {
  background: var(--accent);
  color: white;
  width: 30px;
  height: 30px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: 800;
  font-size: 16px;
  flex-shrink: 0;
}

.step-content strong {
  color: var(--warning);
  font-size: 16px;
  display: block;
  margin-bottom: 8px;
}

.step-content p {
  margin: 0;
  color: var(--light);
  line-height: 1.5;
}

.concept-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 15px;
}

.concept-card {
  background: rgba(30, 41, 59, 0.4);
  border: 1px solid var(--border);
  border-radius: 10px;
  padding: 15px;
  transition: all 0.3s ease;
}

.concept-card:hover {
  border-color: var(--accent);
  transform: translateY(-2px);
}

.concept-card h5 {
  color: var(--warning);
  margin: 0 0 10px 0;
  font-size: 14px;
}

.concept-card p {
  margin: 0;
  color: var(--light);
  font-size: 13px;
  line-height: 1.4;
}

.scoring-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
  gap: 15px;
}

.score-item {
  display: flex;
  flex-direction: column;
  align-items: center;
  text-align: center;
  padding: 15px;
  border-radius: 10px;
  border: 2px solid transparent;
  transition: all 0.3s ease;
}

.score-item.correct {
  background: rgba(16, 185, 129, 0.1);
  border-color: var(--success);
}

.score-item.hund {
  background: rgba(245, 158, 11, 0.1);
  border-color: var(--warning);
}

.score-item.pauli {
  background: rgba(6, 182, 212, 0.1);
  border-color: var(--accent);
}

.score-item.wrong {
  background: rgba(239, 68, 68, 0.1);
  border-color: var(--danger);
}

.score-item .custom-emoji {
  margin-bottom: 8px;
}

.score-item strong {
  color: var(--light);
  font-size: 14px;
  margin-bottom: 5px;
}

.score-item .score-value {
  font-size: 18px;
  font-weight: 800;
  color: var(--warning);
}
  </style>
</head>
<body>
  <header class="app-header">
    <div class="brand">
      <div class="header-logo">
        <div class="logo-image">
          <!-- Your cartoon scientist logo will be displayed here -->
          <div class="logo-placeholder">
            <div class="logo-scientist">
              <div class="logo-hair-purple"></div>
              <div class="logo-face-skin"></div>
              <div class="logo-eyes-blue"></div>
              <div class="logo-glasses-round"></div>
              <div class="logo-smile-friendly"></div>
              <div class="logo-labcoat-white"></div>
              <div class="logo-tie-purple"></div>
            </div>
            <div class="logo-science-elements">
              <div class="logo-atom-white"></div>
              <div class="logo-atom-white"></div>
              <div class="logo-beaker-purple"></div>
              <div class="logo-beaker-purple"></div>
              <div class="logo-syringe-white"></div>
              <div class="logo-syringe-white"></div>
              <div class="logo-star-white"></div>
              <div class="logo-star-white"></div>
              <div class="logo-star-white"></div>
              <div class="logo-star-white"></div>
            </div>
          </div>
        </div>
      </div>
      <div class="brand-text">
        <h1>Electron Towers</h1>
        <p class="subtitle">v0.17r0 — Mobile Responsive + Testing + diagonal Aufbau + Exceptions + Noble-gas shorthand</p>
      </div>
    </div>
    <div class="right">
      <button id="backBtn" class="btn ghost" style="display: none;"><span class="custom-emoji emoji-atom"></span> Back</button>
      <a href="study.html" class="btn ghost" style="text-decoration: none; margin-right: 10px;"><span class="custom-emoji emoji-study"></span> Study Guide</a>
      <button id="versionBtn" class="btn ghost"><span class="custom-emoji emoji-scientist"></span> Version</button>
      <button id="helpBtn" class="btn ghost"><span class="custom-emoji emoji-atom"></span> Help</button>
    </div>
  </header>

  <main class="main">
    <section class="hero-ptable">
      <div class="toolbar top">
        <div class="group">
          <span class="lbl">Mode</span>
          <div class="seg">
            <button id="modeStudy" class="seg-btn active"><span class="custom-emoji emoji-study"></span> Study</button>
            <button id="modeGame" class="seg-btn"><span class="custom-emoji emoji-game"></span> Game</button>
          </div>
        </div>
        <div class="group">
          <label class="lbl">Ion</label>
          <div class="ion-controls">
            <button id="ionMinus" class="btn">−</button>
            <div id="ionCharge" class="ion-box">0</div>
            <button id="ionPlus" class="btn">+</button>
          </div>
          <div id="ionChargeInfo" class="ion-info" title="Click to see all available charges"></div>
          <label class="toggle small"><input type="checkbox" id="hintToggle" checked/> Hints</label>
        </div>
        <div class="group grow">
          <label class="lbl">Search</label>
          <input id="searchBox" class="search" placeholder="Symbol / Z / name (e.g., Fe, 26, Iron)" />
        </div>
        <div class="group">
          <label class="lbl">Table zoom</label>
          <input id="zoomRange" type="range" min="34" max="72" step="2" value="48"/>
        </div>
        <div class="legend">
          <span class="dot s"></span><span>s</span>
          <span class="dot f"></span><span>f</span>
          <span class="dot d"></span><span>d</span>
          <span class="dot p"></span><span>p</span>
        </div>
      </div>

      <div class="ptable-wrapper">
        <div id="ptable" class="ptable" aria-label="Periodic Table"></div>
      </div>

      <div class="toolbar bottom">
        <div class="left">
        </div>
        <div class="center" id="studyControls">
          <div class="toggle-group">
            <label class="toggle-btn" id="autoPlayToggle">
              <input type="checkbox"/>
              <span class="toggle-label"><span class="custom-emoji emoji-energy"></span> Auto-play</span>
            </label>
            <label class="toggle-btn" id="exceptionsToggle">
              <input type="checkbox" checked/>
              <span class="toggle-label"><span class="custom-emoji emoji-star"></span> Exceptions</span>
            </label>
          </div>
        </div>
        <div class="center hidden" id="gameControls">
          <div class="stat"><span class="lbl">Timer</span> <span id="timer">00:00</span></div>
          <div class="stat"><span class="lbl">Streak</span> <span id="streak">0</span></div>
          <button id="startGameBtn" class="btn primary"><span class="custom-emoji emoji-game"></span> Start Game</button>
        </div>
        <div class="actions" id="actionsBar">
          <div id="studyActions">
            <button id="resetBtnStudy" class="btn">Reset Building</button>
          </div>
          <div id="gameActions" class="hidden">
            <button id="newGameBtn" class="btn primary">New Game</button>
            <button id="resetBtnGame" class="btn">Reset Building</button>
          </div>
        </div>
      </div>
    </section>

    <!-- Configuration Display Area - Between Periodic Table and Energy Levels -->
    <section class="config-section">
      <div class="config-display">
        <div class="config-item">
          <span class="config-label">Selected:</span>
          <span class="config-value" id="newCurrentPick">—</span>
        </div>
        <div class="config-item">
          <span class="config-label">Electrons:</span>
          <span class="config-value" id="newElectronCount">0 / 0</span>
        </div>
        <div class="config-item config-full-width">
          <span class="config-label">Ion State:</span>
          <span class="config-value" id="newIonState">—</span>
        </div>
        <div class="config-item config-full-width">
          <span class="config-label">Config:</span>
          <span class="config-value" id="newCurrentConfig">—</span>
        </div>
        <div class="config-item config-full-width">
          <span class="config-label">Shorthand:</span>
          <span class="config-value" id="newShorthandConfig">—</span>
        </div>
      </div>
    </section>

    <section class="below-ptable">
      <aside class="sidebar">
        <section class="panel score">
          <h2><span class="custom-emoji emoji-energy"></span> Score</h2>
          <div class="score-num" id="score">0</div>
          <div class="mini">Correct +10 • Hund single +5 • Pauli pair +15 • Wrong −5</div>
        </section>
        <section class="panel energy">
          <h2><span class="custom-emoji emoji-atom"></span> Move-in Order (Aufbau)</h2>
          <div id="aufbauDiagram" class="aufbau-diagram">
            <svg viewBox="0 0 576 604" aria-label="Aufbau diagonal diagram">
              <defs>
                <marker id="arrowRounded" markerWidth="16" markerHeight="12" refX="12" refY="6" orient="auto" markerUnits="strokeWidth">
                  <path d="M0,1 Q8,6 0,11 L14,6 Z" fill="#ffe882" stroke="#ffe882" stroke-linejoin="round" stroke-linecap="round" opacity=".8"/>
                </marker>
              </defs>
              <g class="cells">
                <rect x="24" y="30" width="120" height="64" rx="12" ry="12" class="cell"/>
                <rect x="24" y="110" width="120" height="64" rx="12" ry="12" class="cell"/><rect x="160" y="110" width="120" height="64" rx="12" ry="12" class="cell"/>
                <rect x="24" y="190" width="120" height="64" rx="12" ry="12" class="cell"/><rect x="160" y="190" width="120" height="64" rx="12" ry="12" class="cell"/><rect x="296" y="190" width="120" height="64" rx="12" ry="12" class="cell"/>
                <rect x="24" y="270" width="120" height="64" rx="12" ry="12" class="cell"/><rect x="160" y="270" width="120" height="64" rx="12" ry="12" class="cell"/><rect x="296" y="270" width="120" height="64" rx="12" ry="12" class="cell"/><rect x="432" y="270" width="120" height="64" rx="12" ry="12" class="cell"/>
                <rect x="24" y="350" width="120" height="64" rx="12" ry="12" class="cell"/><rect x="160" y="350" width="120" height="64" rx="12" ry="12" class="cell"/><rect x="296" y="350" width="120" height="64" rx="12" ry="12" class="cell"/><rect x="432" y="350" width="120" height="64" rx="12" ry="12" class="cell"/>
                <rect x="24" y="430" width="120" height="64" rx="12" ry="12" class="cell"/><rect x="160" y="430" width="120" height="64" rx="12" ry="12" class="cell"/><rect x="296" y="430" width="120" height="64" rx="12" ry="12" class="cell"/><rect x="432" y="430" width="120" height="64" rx="12" ry="12" class="cell"/>
                <rect x="24" y="510" width="120" height="64" rx="12" ry="12" class="cell"/><rect x="160" y="510" width="120" height="64" rx="12" ry="12" class="cell"/><rect x="296" y="510" width="120" height="64" rx="12" ry="12" class="cell"/><rect x="432" y="510" width="120" height="64" rx="12" ry="12" class="cell"/>
              </g>
              <g class="arrows">
                <line x1="128" y1="46" x2="40" y2="78" class="arrow" marker-end="url(#arrowRounded)"/>
                <line x1="128" y1="126" x2="40" y2="158" class="arrow" marker-end="url(#arrowRounded)"/>
                <line x1="264" y1="126" x2="40" y2="238" class="arrow" marker-end="url(#arrowRounded)"/>
                <line x1="264" y1="206" x2="40" y2="318" class="arrow" marker-end="url(#arrowRounded)"/>
                <line x1="400" y1="206" x2="40" y2="398" class="arrow" marker-end="url(#arrowRounded)"/>
                <line x1="400" y1="286" x2="40" y2="478" class="arrow" marker-end="url(#arrowRounded)"/>
                <line x1="536" y1="286" x2="40" y2="558" class="arrow" marker-end="url(#arrowRounded)"/>
                <line x1="536" y1="366" x2="176" y2="558" class="arrow" marker-end="url(#arrowRounded)"/>
                <line x1="536" y1="446" x2="312" y2="558" class="arrow" marker-end="url(#arrowRounded)"/>
                <line x1="536" y1="526" x2="448" y2="558" class="arrow" marker-end="url(#arrowRounded)"/>
              </g>
              <g class="labels">
                <text x="84.0" y="68.0" text-anchor="middle" class="celltext">1s</text>
                <text x="84.0" y="148.0" text-anchor="middle" class="celltext">2s</text><text x="220.0" y="148.0" text-anchor="middle" class="celltext">2p</text>
                <text x="84.0" y="228.0" text-anchor="middle" class="celltext">3s</text><text x="220.0" y="228.0" text-anchor="middle" class="celltext">3p</text><text x="356.0" y="228.0" text-anchor="middle" class="celltext">3d</text>
                <text x="84.0" y="308.0" text-anchor="middle" class="celltext">4s</text><text x="220.0" y="308.0" text-anchor="middle" class="celltext">4p</text><text x="356.0" y="308.0" text-anchor="middle" class="celltext">4d</text><text x="492.0" y="308.0" text-anchor="middle" class="celltext">4f</text>
                <text x="84.0" y="388.0" text-anchor="middle" class="celltext">5s</text><text x="220.0" y="388.0" text-anchor="middle" class="celltext">5p</text><text x="356.0" y="388.0" text-anchor="middle" class="celltext">5d</text><text x="492.0" y="388.0" text-anchor="middle" class="celltext">5f</text>
                <text x="84.0" y="468.0" text-anchor="middle" class="celltext">6s</text><text x="220.0" y="468.0" text-anchor="middle" class="celltext">6p</text><text x="356.0" y="468.0" text-anchor="middle" class="celltext">6d</text><text x="492.0" y="468.0" text-anchor="middle" class="celltext">6f</text>
                <text x="84.0" y="548.0" text-anchor="middle" class="celltext">7s</text><text x="220.0" y="548.0" text-anchor="middle" class="celltext">7p</text><text x="356.0" y="548.0" text-anchor="middle" class="celltext">7d</text><text x="492.0" y="548.0" text-anchor="middle" class="celltext">7f</text>
                <text x="84.0" y="20" text-anchor="middle" class="headtext">s</text><text x="220.0" y="20" text-anchor="middle" class="headtext">p</text><text x="356.0" y="20" text-anchor="middle" class="headtext">d</text><text x="492.0" y="20" text-anchor="middle" class="headtext">f</text>
                <text x="10" y="68.0" text-anchor="end" class="headtext">1</text><text x="10" y="148.0" text-anchor="end" class="headtext">2</text><text x="10" y="228.0" text-anchor="end" class="headtext">3</text><text x="10" y="308.0" text-anchor="end" class="headtext">4</text><text x="10" y="388.0" text-anchor="end" class="headtext">5</text><text x="10" y="468.0" text-anchor="end" class="headtext">6</text><text x="10" y="548.0" text-anchor="end" class="headtext">7</text>
              </g>
            </svg>
          </div>
          <ol id="aufbauList" style="display:none"></ol>
        </section>
        <section class="panel info">
          <h2><span class="custom-emoji emoji-study"></span> Learn as you play</h2>
          <div id="infoNow" class="info-now"></div>
          <details open><summary>Aufbau principle</summary><p>Electrons occupy the lowest-energy available subshells first.</p></details>
          <details><summary>Hund's rule</summary><p>In a set of degenerate orbitals (p, d, f), place one electron in each with the <b>same spin</b> before pairing.</p></details>
          <details><summary>Pauli exclusion principle</summary><p>Each orbital holds at most two electrons and they must have <b>opposite spins</b> (↑↓).</p></details>
        </section>
      </aside>

      <section class="game-area">
        <div id="toast" class="toast" role="alert" aria-live="assertive"></div>
        <div class="energy-axis"><span>Energy ↑</span></div>
        <div class="game-col">
          <div id="building" class="building"></div>
          <div class="lobby hidden" id="lobbyBox">
            <div class="lobby-title"><span class="custom-emoji emoji-electron"></span> Lobby — Incoming Tenants</div>
            <div id="lobbyArea" class="lobby-area"></div>
            <div class="lobby-actions">
              <button id="flipSpinBtn" class="btn"><span class="custom-emoji emoji-energy"></span> Flip Spin (↑/↓)</button>
              <button id="skipBtn" class="btn" title="Put this electron back in line (no score change)"><span class="custom-emoji emoji-electron"></span> Skip Electron</button>
              <div class="queue-info" id="queueInfo">Queue: 0 / 0</div>
            </div>
          </div>
        </div>
      </section>
    </section>
  </main>

  <footer class="app-footer">
    <span><span class="custom-emoji emoji-scientist"></span> © 2025 Electron Towers APP • Stable + Mr.Sep Educational Services</span>
  </footer>

  <!-- Help Modal -->
  <div id="helpBackdrop" class="modal-backdrop hidden" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="helpTitle">
      <div class="modal-header">
        <h3 id="helpTitle">How to Study & Play</h3>
        <button id="helpClose" class="btn ghost">✕</button>
      </div>
      <div class="tabbar">
        <button id="tabStudy" class="tab active">Study Mode</button>
        <button id="tabGame" class="tab">Game Mode</button>
      </div>
      <div id="helpStudy" class="tabpanel">
        <div class="help-section">
          <h4><span class="custom-emoji emoji-study"></span> Study Mode Guide</h4>
          <div class="help-steps">
            <div class="help-step">
              <div class="step-number">1</div>
              <div class="step-content">
                <strong>Select Your Element</strong>
                <p>Pick any element from the periodic table or use the search bar. You can also explore different ion charges!</p>
              </div>
            </div>
            <div class="help-step">
              <div class="step-number">2</div>
              <div class="step-content">
                <strong>Follow the Glow</strong>
                <p>Click the <span class="custom-emoji emoji-energy"></span> glowing slot to place electrons. The app guides you step-by-step!</p>
              </div>
            </div>
            <div class="help-step">
              <div class="step-number">3</div>
              <div class="step-content">
                <strong>Master the Rules</strong>
                <p>Learn Aufbau, Hund's, and Pauli principles through interactive practice. Toggle <span class="custom-emoji emoji-star"></span> exceptions for advanced elements!</p>
              </div>
            </div>
            <div class="help-step">
              <div class="step-number">4</div>
              <div class="step-content">
                <strong>Auto-Play Learning</strong>
                <p>Enable <span class="custom-emoji emoji-energy"></span> auto-play to see the correct sequence automatically!</p>
              </div>
            </div>
          </div>
        </div>
        
        <div class="help-section">
          <h4><span class="custom-emoji emoji-atom"></span> Key Chemistry Concepts</h4>
          <div class="concept-grid">
            <div class="concept-card">
              <h5>Aufbau Principle</h5>
              <p>Electrons fill the lowest energy orbitals first, following the diagonal pattern.</p>
            </div>
            <div class="concept-card">
              <h5>Hund's Rule</h5>
              <p>Fill degenerate orbitals with parallel spins before pairing electrons.</p>
            </div>
            <div class="concept-card">
              <h5>Pauli Exclusion</h5>
              <p>Each orbital holds max 2 electrons with opposite spins (↑↓).</p>
            </div>
            <div class="concept-card">
              <h5>Exceptions</h5>
              <p>Some elements like Cr, Cu break the rules for stability!</p>
            </div>
          </div>
        </div>
      </div>
      
      <div id="helpGame" class="tabpanel hidden">
        <div class="help-section">
          <h4><span class="custom-emoji emoji-game"></span> Game Mode Challenge</h4>
          <div class="help-steps">
            <div class="help-step">
              <div class="step-number">1</div>
              <div class="step-content">
                <strong>Start the Challenge</strong>
                <p>Click <span class="custom-emoji emoji-game"></span> "Start Game" to get a random element and begin the timer!</p>
              </div>
            </div>
            <div class="help-step">
              <div class="step-number">2</div>
              <div class="step-content">
                <strong>Electron Management</strong>
                <p>Drag electrons from the <span class="custom-emoji emoji-electron"></span> lobby or click to place them strategically!</p>
              </div>
            </div>
            <div class="help-step">
              <div class="step-number">3</div>
              <div class="step-content">
                <strong>Score Big Points</strong>
                <p>Correct placement: <span class="custom-emoji emoji-energy"></span> +10, Hund single: +5, Pauli pair: +15!</p>
              </div>
            </div>
            <div class="help-step">
              <div class="step-number">4</div>
              <div class="step-content">
                <strong>Beat the Clock</strong>
                <p>Complete configurations quickly and accurately to achieve high scores!</p>
              </div>
            </div>
          </div>
        </div>
        
        <div class="help-section">
          <h4><span class="custom-emoji emoji-energy"></span> Scoring System</h4>
          <div class="scoring-grid">
            <div class="score-item correct">
              <span class="custom-emoji emoji-electron"></span>
              <strong>Correct Placement</strong>
              <span class="score-value">+10</span>
            </div>
            <div class="score-item hund">
              <span class="custom-emoji emoji-energy"></span>
              <strong>Hund Single</strong>
              <span class="score-value">+5</span>
            </div>
            <div class="score-item pauli">
              <span class="custom-emoji emoji-atom"></span>
              <strong>Pauli Pair</strong>
              <span class="score-value">+15</span>
            </div>
            <div class="score-item wrong">
              <span class="custom-emoji emoji-nucleus"></span>
              <strong>Wrong Move</strong>
              <span class="score-value">-5</span>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <label class="toggle small"><input id="dontShowHelp" type="checkbox"/> Don't show automatically again</label>
        <div class="modal-actions">
          <button id="helpOk" class="btn primary">Got it</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Game Welcome Modal -->
  <div id="gameWelcomeModal" class="modal-backdrop hidden" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="gameWelcomeTitle">
      <div class="modal-header">
        <h3 id="gameWelcomeTitle">🎮 Welcome to Game Mode!</h3>
        <button id="gameWelcomeClose" class="btn ghost">✕</button>
      </div>
      <div class="modal-body">
        <div class="welcome-section">
          <h4>🚀 What You'll Do:</h4>
          <p>Build electron configurations for random elements as fast and accurately as possible!</p>
        </div>
        
        <div class="welcome-section">
          <h4>🏆 What You'll Achieve:</h4>
          <ul>
            <li><strong>Speed Mastery</strong> - Build configurations quickly</li>
            <li><strong>Rule Expert</strong> - Master Aufbau, Hund's, and Pauli principles</li>
            <li><strong>Element Knowledge</strong> - Learn all 118 elements</li>
            <li><strong>Problem Solving</strong> - Think strategically about electron placement</li>
          </ul>
        </div>
        
        <div class="welcome-section">
          <h4>🎯 Scoring System:</h4>
          <div class="scoring-grid">
            <div class="score-item correct">Correct Placement: <strong>+10</strong></div>
            <div class="score-item hund">Hund Single: <strong>+5</strong></div>
            <div class="score-item pauli">Pauli Pair: <strong>+15</strong></div>
            <div class="score-item wrong">Wrong Move: <strong>-5</strong></div>
          </div>
        </div>
        
        <div class="welcome-section">
          <h4>💡 Pro Tips:</h4>
          <ul>
            <li>Start with the lowest energy orbitals first</li>
            <li>Remember Hund's rule for parallel spins</li>
            <li>Watch your streak for bonus points!</li>
            <li>Practice makes perfect - try different elements</li>
          </ul>
        </div>
      </div>
      <div class="modal-footer">
        <div class="modal-actions">
          <button id="gameWelcomeStart" class="btn primary">🎯 Let's Play!</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Congratulations Modal -->
  <div id="congratulationsModal" class="modal-backdrop hidden" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="congratulationsTitle">
      <div class="modal-header">
        <h3 id="congratulationsTitle">🎉 Congratulations!</h3>
        <button id="congratulationsClose" class="btn ghost">✕</button>
      </div>
      <div class="modal-body">
        <div class="congrats-section">
          <h4>🏆 Element Configuration Complete!</h4>
          <p>You've successfully built the electron configuration for <strong id="completedElement">this element</strong>!</p>
        </div>
        
        <div class="congrats-section">
          <h4>📊 Final Score</h4>
          <div class="score-display">
            <div class="score-item total">Total Score: <strong id="finalScore">0</strong></div>
            <div class="score-item time">Time: <strong id="finalTime">00:00</strong></div>
            <div class="score-item streak">Best Streak: <strong id="bestStreak">0</strong></div>
          </div>
        </div>
        
        <div class="congrats-section">
          <h4>🎯 What's Next?</h4>
          <p>Ready to challenge yourself with another element?</p>
        </div>
      </div>
      <div class="modal-footer">
        <div class="modal-actions">
          <button id="nextElementBtn" class="btn primary">🎮 Next Element</button>
          <button id="sameElementBtn" class="btn">🔄 Same Element</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Version History Modal -->
  <div id="versionModal" class="modal-backdrop hidden" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="versionTitle">
      <div class="modal-header">
        <div class="version-header">
          <div class="app-logo">
            <div class="logo-boy">
              <div class="logo-hair"></div>
              <div class="logo-face">
                <div class="logo-eyes">
                  <div class="logo-eye left"></div>
                  <div class="logo-eye right"></div>
                </div>
                <div class="logo-glasses"></div>
                <div class="logo-smile"></div>
              </div>
              <div class="logo-labcoat"></div>
              <div class="logo-tie"></div>
            </div>
            <div class="logo-atoms">
              <div class="logo-atom top-left"></div>
              <div class="logo-atom top-right"></div>
            </div>
            <div class="logo-beakers">
              <div class="logo-beaker left"></div>
              <div class="logo-beaker right"></div>
            </div>
            <div class="logo-syringes">
              <div class="logo-syringe left"></div>
              <div class="logo-syringe right"></div>
            </div>
            <div class="logo-stars">
              <div class="logo-star"></div>
              <div class="logo-star"></div>
              <div class="logo-star"></div>
              <div class="logo-star"></div>
            </div>
          </div>
          <div class="version-info">
            <h3 id="versionTitle">Electron Towers</h3>
            <p class="current-version">Current Version: <strong>v0.17r0</strong></p>
            <p class="version-tagline">Stable base + Diagonal Aufbau + Exceptions + Noble-gas shorthand</p>
          </div>
        </div>
        <button id="versionClose" class="btn ghost">✕</button>
      </div>
      <div class="modal-body">
        <div id="versionTimeline" class="version-timeline">
          <!-- Version entries will be dynamically generated here -->
        </div>
      </div>
      <div class="modal-footer">
        <div class="modal-actions">
          <button id="versionCloseBtn" class="btn primary">Close</button>
        </div>
      </div>
    </div>
  </div>

  <script>
/* ======= Periodic Table data ======= */
const symbols=["H","He","Li","Be","B","C","N","O","F","Ne","Na","Mg","Al","Si","P","S","Cl","Ar","K","Ca","Sc","Ti","V","Cr","Mn","Fe","Co","Ni","Cu","Zn","Ga","Ge","As","Se","Br","Kr","Rb","Sr","Y","Zr","Nb","Mo","Tc","Ru","Rh","Pd","Ag","Cd","In","Sn","Sb","Te","I","Xe","Cs","Ba","La","Ce","Pr","Nd","Pm","Sm","Eu","Gd","Tb","Dy","Ho","Er","Tm","Yb","Lu","Hf","Ta","W","Re","Os","Ir","Pt","Au","Hg","Tl","Pb","Bi","Po","At","Rn","Fr","Ra","Ac","Th","Pa","U","Np","Pu","Am","Cm","Bk","Cf","Es","Fm","Md","No","Lr","Rf","Db","Sg","Bh","Hs","Mt","Ds","Rg","Cn","Nh","Fl","Mc","Lv","Ts","Og"];
const names=["Hydrogen","Helium","Lithium","Beryllium","Boron","Carbon","Nitrogen","Oxygen","Fluorine","Neon","Sodium","Magnesium","Aluminium","Silicon","Phosphorus","Sulfur","Chlorine","Argon","Potassium","Calcium","Scandium","Titanium","Vanadium","Chromium","Manganese","Iron","Cobalt","Nickel","Copper","Zinc","Gallium","Germanium","Arsenic","Selenium","Bromine","Krypton","Rubidium","Strontium","Yttrium","Zirconium","Niobium","Molybdenum","Technetium","Ruthenium","Rhodium","Palladium","Silver","Cadmium","Indium","Tin","Antimony","Tellurium","Iodine","Xenon","Cesium","Barium","Lanthanum","Cerium","Praseodymium","Neodymium","Promethium","Samarium","Europium","Gadolinium","Terbium","Dysprosium","Holmium","Erbium","Thulium","Ytterbium","Lutetium","Hafnium","Tantalum","Tungsten","Rhenium","Osmium","Iridium","Platinum","Gold","Mercury","Thallium","Lead","Bismuth","Polonium","Astatine","Radon","Francium","Radium","Actinium","Thorium","Protactinium","Uranium","Neptunium","Plutonium","Americium","Curium","Berkelium","Californium","Einsteinium","Fermium","Mendelevium","Nobelium","Lawrencium","Rutherfordium","Dubnium","Seaborgium","Bohrium","Hassium","Meitnerium","Darmstadtium","Roentgenium","Copernicium","Nihonium","Flerovium","Moscovium","Livermorium","Tennessine","Oganesson"];
function sym(Z){ return symbols[Z-1] || "?"; }
function nameOf(Z){ return names[Z-1] || ""; }

/* ======= PT grid (standard, with A/B groups) ======= */
function buildPTGrid(container, onPick, currentZ){
  const ROW_OFFSET=1, COL_OFFSET=1;
  container.innerHTML="";
  // Updated group column mapping to match new layout
  const groupCol = {
    1: 2,   // Group 1 (H, Li, Na, K, Rb, Cs, Fr)
    2: 3,   // Group 2 (Be, Mg, Ca, Sr, Ba, Ra)
    3: 4,   // Group 3 (Sc, Y, La, Ac)
    4: 5,   // Group 4 (Ti, Zr, Hf, Rf)
    5: 6,   // Group 5 (V, Nb, Ta, Db)
    6: 7,   // Group 6 (Cr, Mo, W, Sg)
    7: 8,   // Group 7 (Mn, Tc, Re, Bh)
    8: 9,   // Group 8 (Fe, Ru, Os, Hs)
    9: 10,  // Group 9 (Co, Rh, Ir, Mt)
    10: 11, // Group 10 (Ni, Pd, Pt, Ds)
    11: 12, // Group 11 (Cu, Ag, Au, Rg)
    12: 13, // Group 12 (Zn, Cd, Hg, Cn)
    13: 14, // Group 13 (B, Al, Ga, In, Tl, Nh)
    14: 15, // Group 14 (C, Si, Ge, Sn, Pb, Fl)
    15: 16, // Group 15 (N, P, As, Sb, Bi, Mc)
    16: 17, // Group 16 (O, S, Se, Te, Po, Lv)
    17: 18, // Group 17 (F, Cl, Br, I, At, Ts)
    18: 19  // Group 18 (He, Ne, Ar, Kr, Xe, Rn, Og)
  };
  const groupAB={1:"1A",2:"2A",3:"3B",4:"4B",5:"5B",6:"6B",7:"7B",8:"8B",9:"8B",10:"8B",11:"1B",12:"2B",13:"3A",14:"4A",15:"5A",16:"6A",17:"7A",18:"8A"};
  for(let g=1; g<=18; g++){ const gl=document.createElement("div"); gl.className="group-label"; gl.textContent=groupAB[g]; gl.style.gridColumn=String(groupCol[g]); gl.style.gridRow="1"; container.appendChild(gl); }
  // Removed "Group (A/B) →" text for cleaner look
  for(let p=1;p<=7;p++){ const pl=document.createElement("div"); pl.className="period-label"; pl.textContent=p; pl.style.gridColumn="1"; pl.style.gridRow=String(p+ROW_OFFSET); container.appendChild(pl); }

  function overlay(label, c, w, r, h){ c+=COL_OFFSET; r+=ROW_OFFSET; const ov=document.createElement("div"); ov.className="block-overlay"; ov.style.gridColumn=`${c} / span ${w}`; ov.style.gridRow=`${r} / span ${h}`; const lab=document.createElement("label"); lab.textContent=label; ov.appendChild(lab); container.appendChild(ov); }
  function placeRange(period, colStart, Zstart, Zend, blockClass){
    let c=colStart;
    for(let Z=Zstart; Z<=Zend; Z++, c++){
      const t=document.createElement("div");
      t.className=`ptile ${blockClass}`;
      t.style.gridColumn=`${c+COL_OFFSET}`;
      t.style.gridRow=`${period+ROW_OFFSET}`;
      t.dataset.z=Z;
      t.title=`${sym(Z)} — ${nameOf(Z)} (Z=${Z})`;
      t.innerHTML=`<div class="z">${Z}</div><div class="sym">${sym(Z)}</div>`;
      t.addEventListener("click", ()=> onPick(Z,t));
      if(Z===currentZ) t.classList.add("selected");
      container.appendChild(t);
    }
  }
  // Place elements in correct groups according to standard periodic table
  // Place elements in standard periodic table layout
  // Place elements in standard periodic table layout
  placeRange(1,1,1,1,"s");                     // H (group 1)
  placeRange(1,18,2,2,"p");                    // He (group 18, noble gas, p-block, above Ne)
  placeRange(2,1,3,4,"s");                     // Li, Be
  placeRange(2,13,5,10,"p");                   // B, C, N, O, F, Ne
  placeRange(3,1,11,12,"s");                   // Na, Mg
  placeRange(3,13,13,18,"p");                  // Al, Si, P, S, Cl, Ar
  placeRange(4,1,19,20,"s");                   // K, Ca
  placeRange(4,3,21,30,"d");                   // Sc, Ti, V, Cr, Mn, Fe, Co, Ni, Cu, Zn
  placeRange(4,13,31,36,"p");                  // Ga, Ge, As, Se, Br, Kr
  placeRange(5,1,37,38,"s");                   // Rb, Sr
  placeRange(5,3,39,48,"d");                   // Y, Zr, Nb, Mo, Tc, Ru, Rh, Pd, Ag, Cd
  placeRange(5,13,49,54,"p");                  // In, Sn, Sb, Te, I, Xe
  placeRange(6,1,55,56,"s");                   // Cs, Ba
  placeRange(6,3,71,80,"d");                   // Lu, Hf, Ta, W, Re, Os, Ir, Pt, Au, Hg
  placeRange(6,13,81,86,"p");                  // Tl, Pb, Bi, Po, At, Rn
  placeRange(7,1,87,88,"s");                   // Fr, Ra
  placeRange(7,3,103,112,"d");                 // Lr, Rf, Db, Sg, Bh, Hs, Mt, Ds, Rg, Cn
  placeRange(7,13,113,118,"p");                // Nh, Fl, Mc, Lv, Ts, Og
  
  // Place f-block elements below main table (lanthanides and actinides)
  placeRange(8,3,57,70,"f");                   // Lanthanides (La-Lu)
  placeRange(9,3,89,102,"f");                  // Actinides (Ac-Lr)
  
  // Create block overlays
  overlay("s-block",1,2,1,7);                  // s-block: groups 1-2, periods 1-7
  overlay("d-block",3,10,4,4);                  // d-block: groups 3-12, periods 4-7
  overlay("p-block",13,6,1,7);                  // p-block: groups 13-18, periods 1-7 (includes He in group 18)
  overlay("f-block",3,14,8,2);                 // f-block below main table
}

/* ======= Core state & constants ======= */
const ORDER=["1s","2s","2p","3s","3p","4s","3d","4p","5s","4d","5p","6s","4f","5d","6p","7s","5f","6d","7p"];
const subshellOrbitals={ s:1, p:3, d:5, f:7 };
const NOBLES = [
  {Z:2, sym:"He"}, {Z:10,sym:"Ne"}, {Z:18,sym:"Ar"}, {Z:36,sym:"Kr"},
  {Z:54,sym:"Xe"}, {Z:86,sym:"Rn"}, {Z:118,sym:"Og"}
];

// Comprehensive element charge restrictions based on real chemistry and oxidation states
const ELEMENT_CHARGES = {
  // Period 1
  1: { allowed: [0, 1], name: "Hydrogen", description: "Can lose 1e⁻ (H⁺) or remain neutral. H⁻ exists but is rare" },
  2: { allowed: [0], name: "Helium", description: "Noble gas - no ion formation under normal conditions" },
  
  // Period 2
  3: { allowed: [0, 1], name: "Lithium", description: "Alkali metal - loses 1e⁻ (Li⁺)" },
  4: { allowed: [0, 2], name: "Beryllium", description: "Alkaline earth - loses 2e⁻ (Be²⁺)" },
  5: { allowed: [0, 3], name: "Boron", description: "Metalloid - loses 3e⁻ (B³⁺)" },
  6: { allowed: [-4, -3, -2, -1, 0, 1, 2, 3, 4], name: "Carbon", description: "Multiple oxidation states: C⁴⁻, C³⁻, C²⁻, C⁻, C, C⁺, C²⁺, C³⁺, C⁴⁺" },
  7: { allowed: [-3, -2, -1, 0, 1, 2, 3, 4, 5], name: "Nitrogen", description: "Multiple oxidation states: N³⁻, N²⁻, N⁻, N, N⁺, N²⁺, N³⁺, N⁴⁺, N⁵⁺" },
  8: { allowed: [-2, -1, 0], name: "Oxygen", description: "Non-metal - gains electrons: O²⁻, O⁻, O" },
  9: { allowed: [-1, 0], name: "Fluorine", description: "Halogen - gains 1e⁻ (F⁻), never loses electrons" },
  10: { allowed: [0], name: "Neon", description: "Noble gas - no ion formation" },
  
  // Period 3
  11: { allowed: [0, 1], name: "Sodium", description: "Alkali metal - loses 1e⁻ (Na⁺)" },
  12: { allowed: [0, 2], name: "Magnesium", description: "Alkaline earth - loses 2e⁻ (Mg²⁺)" },
  13: { allowed: [0, 3], name: "Aluminum", description: "Post-transition metal - loses 3e⁻ (Al³⁺)" },
  14: { allowed: [-4, -3, -2, -1, 0, 1, 2, 3, 4], name: "Silicon", description: "Metalloid - multiple oxidation states" },
  15: { allowed: [-3, -2, -1, 0, 1, 2, 3, 4, 5], name: "Phosphorus", description: "Non-metal - multiple oxidation states" },
  16: { allowed: [-2, -1, 0, 1, 2, 4, 6], name: "Sulfur", description: "Non-metal - multiple oxidation states: S²⁻, S⁻, S, S⁺, S²⁺, S⁴⁺, S⁶⁺" },
  17: { allowed: [-1, 0, 1, 3, 5, 7], name: "Chlorine", description: "Halogen - gains 1e⁻ (Cl⁻), can have positive oxidation states" },
  18: { allowed: [0], name: "Argon", description: "Noble gas - no ion formation" },
  
  // Period 4
  19: { allowed: [0, 1], name: "Potassium", description: "Alkali metal - loses 1e⁻ (K⁺)" },
  20: { allowed: [0, 2], name: "Calcium", description: "Alkaline earth - loses 2e⁻ (Ca²⁺)" },
  21: { allowed: [0, 3], name: "Scandium", description: "Transition metal - loses 3e⁻ (Sc³⁺)" },
  22: { allowed: [0, 2, 3, 4], name: "Titanium", description: "Transition metal - Ti²⁺, Ti³⁺, Ti⁴⁺" },
  23: { allowed: [0, 2, 3, 4, 5], name: "Vanadium", description: "Transition metal - V²⁺, V³⁺, V⁴⁺, V⁵⁺" },
  24: { allowed: [0, 2, 3, 6], name: "Chromium", description: "Transition metal - Cr²⁺, Cr³⁺, Cr⁶⁺" },
  25: { allowed: [0, 2, 3, 4, 6, 7], name: "Manganese", description: "Transition metal - Mn²⁺, Mn³⁺, Mn⁴⁺, Mn⁶⁺, Mn⁷⁺" },
  26: { allowed: [0, 2, 3, 6], name: "Iron", description: "Transition metal - Fe²⁺, Fe³⁺, Fe⁶⁺" },
  27: { allowed: [0, 2, 3, 4], name: "Cobalt", description: "Transition metal - Co²⁺, Co³⁺, Co⁴⁺" },
  28: { allowed: [0, 2, 3], name: "Nickel", description: "Transition metal - Ni²⁺, Ni³⁺" },
  29: { allowed: [0, 1, 2], name: "Copper", description: "Transition metal - Cu⁺, Cu²⁺" },
  30: { allowed: [0, 2], name: "Zinc", description: "Transition metal - Zn²⁺" },
  31: { allowed: [0, 1, 3], name: "Gallium", description: "Post-transition metal - Ga⁺, Ga³⁺" },
  32: { allowed: [-4, -3, -2, -1, 0, 1, 2, 3, 4], name: "Germanium", description: "Metalloid - multiple oxidation states" },
  33: { allowed: [-3, -2, -1, 0, 1, 2, 3, 4, 5], name: "Arsenic", description: "Metalloid - multiple oxidation states" },
  34: { allowed: [-2, -1, 0, 1, 2, 4, 6], name: "Selenium", description: "Non-metal - multiple oxidation states" },
  35: { allowed: [-1, 0, 1, 3, 5, 7], name: "Bromine", description: "Halogen - gains 1e⁻ (Br⁻), can have positive oxidation states" },
  36: { allowed: [0], name: "Krypton", description: "Noble gas - no ion formation" },
  
  // Period 5
  37: { allowed: [0, 1], name: "Rubidium", description: "Alkali metal - loses 1e⁻ (Rb⁺)" },
  38: { allowed: [0, 2], name: "Strontium", description: "Alkaline earth - loses 2e⁻ (Sr²⁺)" },
  39: { allowed: [0, 3], name: "Yttrium", description: "Transition metal - loses 3e⁻ (Y³⁺)" },
  40: { allowed: [0, 2, 3, 4], name: "Zirconium", description: "Transition metal - Zr²⁺, Zr³⁺, Zr⁴⁺" },
  41: { allowed: [0, 2, 3, 4, 5], name: "Niobium", description: "Transition metal - Nb²⁺, Nb³⁺, Nb⁴⁺, Nb⁵⁺" },
  42: { allowed: [0, 2, 3, 4, 5, 6], name: "Molybdenum", description: "Transition metal - Mo²⁺, Mo³⁺, Mo⁴⁺, Mo⁵⁺, Mo⁶⁺" },
  43: { allowed: [0, 2, 3, 4, 5, 6, 7], name: "Technetium", description: "Transition metal - multiple oxidation states" },
  44: { allowed: [0, 2, 3, 4, 5, 6, 7, 8], name: "Ruthenium", description: "Transition metal - multiple oxidation states" },
  45: { allowed: [0, 1, 2, 3, 4, 5, 6], name: "Rhodium", description: "Transition metal - multiple oxidation states" },
  46: { allowed: [0, 1, 2, 3, 4], name: "Palladium", description: "Transition metal - Pd⁺, Pd²⁺, Pd³⁺, Pd⁴⁺" },
  47: { allowed: [0, 1, 2, 3], name: "Silver", description: "Transition metal - Ag⁺, Ag²⁺, Ag³⁺" },
  48: { allowed: [0, 2], name: "Cadmium", description: "Transition metal - Cd²⁺" },
  49: { allowed: [0, 1, 3], name: "Indium", description: "Post-transition metal - In⁺, In³⁺" },
  50: { allowed: [-4, -3, -2, -1, 0, 1, 2, 3, 4], name: "Tin", description: "Post-transition metal - multiple oxidation states" },
  51: { allowed: [-3, -2, -1, 0, 1, 2, 3, 4, 5], name: "Antimony", description: "Metalloid - multiple oxidation states" },
  52: { allowed: [-2, -1, 0, 1, 2, 4, 6], name: "Tellurium", description: "Metalloid - multiple oxidation states" },
  53: { allowed: [-1, 0, 1, 3, 5, 7], name: "Iodine", description: "Halogen - gains 1e⁻ (I⁻), can have positive oxidation states" },
  54: { allowed: [0], name: "Xenon", description: "Noble gas - no ion formation" },
  
  // Period 6
  55: { allowed: [0, 1], name: "Cesium", description: "Alkali metal - loses 1e⁻ (Cs⁺)" },
  56: { allowed: [0, 2], name: "Barium", description: "Alkaline earth - loses 2e⁻ (Ba²⁺)" },
  57: { allowed: [0, 3], name: "Lanthanum", description: "Lanthanide - loses 3e⁻ (La³⁺)" },
  58: { allowed: [0, 3, 4], name: "Cerium", description: "Lanthanide - Ce³⁺, Ce⁴⁺" },
  59: { allowed: [0, 3, 4], name: "Praseodymium", description: "Lanthanide - Pr³⁺, Pr⁴⁺" },
  60: { allowed: [0, 2, 3], name: "Neodymium", description: "Lanthanide - Nd²⁺, Nd³⁺" },
  61: { allowed: [0, 3], name: "Promethium", description: "Lanthanide - Pm³⁺" },
  62: { allowed: [0, 2, 3], name: "Samarium", description: "Lanthanide - Sm²⁺, Sm³⁺" },
  63: { allowed: [0, 2, 3], name: "Europium", description: "Lanthanide - Eu²⁺, Eu³⁺" },
  64: { allowed: [0, 3], name: "Gadolinium", description: "Lanthanide - Gd³⁺" },
  65: { allowed: [0, 3, 4], name: "Terbium", description: "Lanthanide - Tb³⁺, Tb⁴⁺" },
  66: { allowed: [0, 3, 4], name: "Dysprosium", description: "Lanthanide - Dy³⁺, Dy⁴⁺" },
  67: { allowed: [0, 3], name: "Holmium", description: "Lanthanide - Ho³⁺" },
  68: { allowed: [0, 3], name: "Erbium", description: "Lanthanide - Er³⁺" },
  69: { allowed: [0, 2, 3], name: "Thulium", description: "Lanthanide - Tm²⁺, Tm³⁺" },
  70: { allowed: [0, 2, 3], name: "Ytterbium", description: "Lanthanide - Yb²⁺, Yb³⁺" },
  71: { allowed: [0, 3], name: "Lutetium", description: "Lanthanide - Lu³⁺" },
  72: { allowed: [0, 2, 3, 4], name: "Hafnium", description: "Transition metal - Hf²⁺, Hf³⁺, Hf⁴⁺" },
  73: { allowed: [0, 2, 3, 4, 5], name: "Tantalum", description: "Transition metal - Ta²⁺, Ta³⁺, Ta⁴⁺, Ta⁵⁺" },
  74: { allowed: [0, 2, 3, 4, 5, 6], name: "Tungsten", description: "Transition metal - W²⁺, W³⁺, W⁴⁺, W⁵⁺, W⁶⁺" },
  75: { allowed: [0, 2, 3, 4, 5, 6, 7], name: "Rhenium", description: "Transition metal - multiple oxidation states" },
  76: { allowed: [0, 2, 3, 4, 5, 6, 7, 8], name: "Osmium", description: "Transition metal - multiple oxidation states" },
  77: { allowed: [0, 1, 2, 3, 4, 5, 6], name: "Iridium", description: "Transition metal - multiple oxidation states" },
  78: { allowed: [0, 1, 2, 3, 4, 5, 6], name: "Platinum", description: "Transition metal - multiple oxidation states" },
  79: { allowed: [0, 1, 3], name: "Gold", description: "Transition metal - Au⁺, Au³⁺" },
  80: { allowed: [0, 1, 2], name: "Mercury", description: "Transition metal - Hg⁺, Hg²⁺" },
  81: { allowed: [0, 1, 3], name: "Thallium", description: "Post-transition metal - Tl⁺, Tl³⁺" },
  82: { allowed: [0, 2, 4], name: "Lead", description: "Post-transition metal - Pb²⁺, Pb⁴⁺" },
  83: { allowed: [0, 1, 3, 5], name: "Bismuth", description: "Post-transition metal - Bi⁺, Bi³⁺, Bi⁵⁺" },
  84: { allowed: [0, 2, 4, 6], name: "Polonium", description: "Post-transition metal - Po²⁺, Po⁴⁺, Po⁶⁺" },
  85: { allowed: [0, 1, 3, 5, 7], name: "Astatine", description: "Halogen - can have multiple oxidation states" },
  86: { allowed: [0], name: "Radon", description: "Noble gas - no ion formation" },
  
  // Period 7
  87: { allowed: [0, 1], name: "Francium", description: "Alkali metal - loses 1e⁻ (Fr⁺)" },
  88: { allowed: [0, 2], name: "Radium", description: "Alkaline earth - loses 2e⁻ (Ra²⁺)" },
  89: { allowed: [0, 3], name: "Actinium", description: "Actinide - loses 3e⁻ (Ac³⁺)" },
  90: { allowed: [0, 3, 4], name: "Thorium", description: "Actinide - Th³⁺, Th⁴⁺" },
  91: { allowed: [0, 3, 4, 5], name: "Protactinium", description: "Actinide - Pa³⁺, Pa⁴⁺, Pa⁵⁺" },
  92: { allowed: [0, 3, 4, 5, 6], name: "Uranium", description: "Actinide - U³⁺, U⁴⁺, U⁵⁺, U⁶⁺" },
  93: { allowed: [0, 3, 4, 5, 6, 7], name: "Neptunium", description: "Actinide - multiple oxidation states" },
  94: { allowed: [0, 3, 4, 5, 6, 7], name: "Plutonium", description: "Actinide - multiple oxidation states" },
  95: { allowed: [0, 2, 3, 4, 5, 6], name: "Americium", description: "Actinide - multiple oxidation states" },
  96: { allowed: [0, 3, 4], name: "Curium", description: "Actinide - Cm³⁺, Cm⁴⁺" },
  97: { allowed: [0, 3, 4], name: "Berkelium", description: "Actinide - Bk³⁺, Bk⁴⁺" },
  98: { allowed: [0, 3, 4], name: "Californium", description: "Actinide - Cf³⁺, Cf⁴⁺" },
  99: { allowed: [0, 3, 4], name: "Einsteinium", description: "Actinide - Es³⁺, Es⁴⁺" },
  100: { allowed: [0, 2, 3], name: "Fermium", description: "Actinide - Fm²⁺, Fm³⁺" },
  101: { allowed: [0, 2, 3], name: "Mendelevium", description: "Actinide - Md²⁺, Md³⁺" },
  102: { allowed: [0, 2, 3], name: "Nobelium", description: "Actinide - No²⁺, No³⁺" },
  103: { allowed: [0, 3], name: "Lawrencium", description: "Actinide - Lr³⁺" },
  
  // Superheavy elements (Periods 8-9)
  104: { allowed: [0, 3, 4], name: "Rutherfordium", description: "Transition metal - Rf³⁺, Rf⁴⁺" },
  105: { allowed: [0, 3, 4, 5], name: "Dubnium", description: "Transition metal - Db³⁺, Db⁴⁺, Db⁵⁺" },
  106: { allowed: [0, 3, 4, 5, 6], name: "Seaborgium", description: "Transition metal - Sg³⁺, Sg⁴⁺, Sg⁵⁺, Sg⁶⁺" },
  107: { allowed: [0, 3, 4, 5, 6, 7], name: "Bohrium", description: "Transition metal - Bh³⁺, Bh⁴⁺, Bh⁵⁺, Bh⁶⁺, Bh⁷⁺" },
  108: { allowed: [0, 2, 3, 4, 5, 6, 7, 8], name: "Hassium", description: "Transition metal - multiple oxidation states" },
  109: { allowed: [0, 1, 2, 3, 4, 5, 6, 7], name: "Meitnerium", description: "Transition metal - multiple oxidation states" },
  110: { allowed: [0, 1, 2, 3, 4, 5, 6], name: "Darmstadtium", description: "Transition metal - multiple oxidation states" },
  111: { allowed: [0, 1, 2, 3, 4, 5], name: "Roentgenium", description: "Transition metal - multiple oxidation states" },
  112: { allowed: [0, 1, 2], name: "Copernicium", description: "Transition metal - Cn⁺, Cn²⁺" },
  113: { allowed: [0, 1, 3], name: "Nihonium", description: "Post-transition metal - Nh⁺, Nh³⁺" },
  114: { allowed: [0, 2, 4], name: "Flerovium", description: "Post-transition metal - Fl²⁺, Fl⁴⁺" },
  115: { allowed: [0, 1, 3, 5], name: "Moscovium", description: "Post-transition metal - Mc⁺, Mc³⁺, Mc⁵⁺" },
  116: { allowed: [0, 2, 4, 6], name: "Livermorium", description: "Post-transition metal - Lv²⁺, Lv⁴⁺, Lv⁶⁺" },
  117: { allowed: [0, 1, 3, 5, 7], name: "Tennessine", description: "Halogen - can have multiple oxidation states" },
  118: { allowed: [0], name: "Oganesson", description: "Noble gas - no ion formation" }
};

// Default charges for elements not explicitly defined (fallback)
const getDefaultCharges = (Z) => {
  // Since we now have comprehensive coverage for all 118 elements,
  // this function should rarely be called, but provides a safe fallback
  if (Z <= 2) return [0]; // H, He
  if (Z <= 10) return [0]; // Li to Ne: typically no ion formation except alkali/alkaline earth
  if (Z <= 18) return [0]; // Na to Ar: typically no ion formation except alkali/alkaline earth
  if (Z <= 36) return [0]; // K to Kr: typically no ion formation except alkali/alkaline earth
  if (Z <= 54) return [0]; // Rb to Xe: typically no ion formation except alkali/alkaline earth
  if (Z <= 86) return [0]; // Cs to Rn: typically no ion formation except alkali/alkaline earth
  return [0]; // Beyond Rn: typically no ion formation
};

// Get allowed charges for a specific element
function getElementAllowedCharges(Z) {
  if (ELEMENT_CHARGES[Z]) {
    return ELEMENT_CHARGES[Z].allowed;
  }
  return getDefaultCharges(Z);
}
const state={
  mode:"study", targetZ:8, ionCharge:0,
  queue:[], nextId:1, score:0, building:{},
  autoTimer:null, timerId:null, startTime:null, streak:0,
  showHints:true, exceptionsEnabled:true
};

function on(el, type, handler){ if (el) el.addEventListener(type, handler); }
function byId(id){ return document.getElementById(id); }
function toast(msg){ const t = byId("toast"); if (!t) return; t.textContent = msg; t.className = "toast show"; setTimeout(()=> t.className = "toast", 1500); }

/* ======= Helpers ======= */
function orbitalLabel(sub, i){
  const l=sub.slice(-1);
  if (l === 's') return `${sub} orbital`;
  if (l === 'p'){ const names=['x','y','z']; return `${sub}_${names[i] ?? '?' } orbital`; }
  if (l === 'd'){ const names=['xy','yz','zx','x^2−y^2','z^2']; return `${sub}_${names[i] ?? '?' } orbital`; }
  if (l === 'f'){ const m=[-3,-2,-1,0,1,2,3]; return `${sub} (mℓ=${m[i] ?? '?'}) orbital`; }
  return `${sub} orbital`;
}
function subInfo(sub){
  const n=parseInt(sub[0],10);
  const letter=sub[1];
  const orbitals=subshellOrbitals[letter] || 1;
  const capacity=orbitals*2;
  const l={ s:0, p:1, d:2, f:3 }[letter];
  return { n, letter, orbitals, capacity, l };
}

/* ======= UI build ======= */
function buildAufbauList(){
  const list = byId("aufbauList"); if (!list) return;
  list.innerHTML = "";
  ORDER.forEach(sub => {
    const info = subInfo(sub);
    const li = document.createElement("li");
    li.dataset.sub = sub;
    li.textContent = `${sub} — n=${info.n}, ℓ=${info.l} (${info.letter}), cap ${info.capacity}`;
    list.appendChild(li);
  });
}

function buildFloors(){
  const elBuilding = byId("building"); 
  if (!elBuilding) {
    console.error("❌ Building element not found!");
    return;
  }
  
  elBuilding.innerHTML = "";
  const byN = {};
  
  ORDER.forEach(sub => { 
    const { n } = subInfo(sub); 
    (byN[n] = byN[n] || []).push(sub); 
  });
  
  Object.keys(byN).sort((a,b)=>parseInt(a)-parseInt(b)).forEach(nStr => {
    const n = parseInt(nStr,10);
    const floor = document.createElement("div");
    floor.className = "floor";
    floor.setAttribute("data-n", String(n));
    floor.innerHTML = `<div class="floor-label">Shell n=${n}</div><div class="wings" id="floor-${n}"></div>`;
    elBuilding.appendChild(floor);
    const wings = floor.querySelector(".wings");
    const orderLetters = ["s","p","d","f"];
    byN[n].sort((a,b)=>orderLetters.indexOf(a[1]) - orderLetters.indexOf(b[1])).forEach(sub => {
      const info = subInfo(sub);
      const wing = document.createElement("div");
      wing.setAttribute("class", `wing wing-${info.letter}`);
      wing.setAttribute("data-sub", sub);
      wing.title = `Subshell: ${sub} (n=${info.n}, ℓ=${info.l}) • Orbitals ${info.orbitals}, capacity ${info.capacity} e⁻`;
      wing.innerHTML = `<div class="wing-title">${sub} wing — <span class="mini">ℓ=${info.l} (${info.letter})</span></div>
        <div class="units" id="wing-${sub}"></div>`;
      wings.appendChild(wing);
      const units = wing.querySelector(".units");
      for (let i=0;i<info.orbitals;i++){
        const unit = document.createElement("div");
        unit.className = "unit";
        unit.dataset.wing = sub;
        unit.dataset.index = i;
        unit.innerHTML = `<div class="unit-label">${orbitalLabel(sub, i)}</div>
          <div class="slots"><div class="slot" data-slot="0"></div><div class="slot" data-slot="1"></div></div>`;
        on(unit, "click", (e)=> onUnitClick(e, unit));
        on(unit, "dragover", e=>e.preventDefault());
        on(unit, "drop", onDropToUnit);
        units.appendChild(unit);
      }
    });
  });
}

function resetBuilding(){
  state.building = {};
  ORDER.forEach(sub => { const info = subInfo(sub); state.building[sub] = Array.from({length:info.orbitals}, ()=>[]); });
  document.querySelectorAll(".unit .slots").forEach(n => n.innerHTML = `<div class="slot" data-slot="0"></div><div class="slot" data-slot="1"></div>`);
  clearGhost(); refreshAufbauFocus(); refreshInfo(); renderReadouts();
  
  // Update the new configuration display
  updateNewConfigurationDisplay();
  
  // Update the electron count display
  updateQueueInfo();
}

function electronsNeeded(){ return Math.max(0, (state.targetZ || 1) - (state.ionCharge || 0)); }
function placedCount(){ let c=0; for (const sub of ORDER){ const arr = state.building[sub]; if (!arr) continue; for (const u of arr){ c += u.length; } } return c; }
function overCap(){ return placedCount() >= electronsNeeded(); }

function addScore(n){ state.score += n; const sc = byId("score"); if (sc) sc.textContent = state.score; }
function findUnitEl(wing,index){ return document.querySelector(`.unit[data-wing="${wing}"][data-index="${index}"]`); }

function placeElectronInto(wing, index, spin){
  state.building[wing][index].push(spin);
  const unit = findUnitEl(wing,index);
  if (unit){
    const slots = unit.querySelectorAll(".slot");
    for (let i=0;i<2;i++){
      const s = state.building[wing][index][i];
      slots[i].textContent = s ? (s==="up"?"↑":"↓") : "";
    }
    
    // Auto-scroll to keep the filled orbital visible with smoother scrolling
    unit.scrollIntoView({ 
      behavior: 'smooth', 
      block: 'center',
      inline: 'center'
    });
  }
  refreshInfo(); 
  
  // Update the new configuration display
  updateNewConfigurationDisplay();
  
  renderReadouts();
  
  // Check if configuration is complete and scroll to config box
  if (placedCount() >= electronsNeeded()) {
    setTimeout(() => {
      const configBox = document.querySelector('.config-section');
      if (configBox) {
        configBox.scrollIntoView({ behavior: 'smooth', block: 'center' });
      }
    }, 500);
  }
  
  // Ensure the new configuration display is updated
  updateQueueInfo();
}

function removeElectronFrom(wing, index){
  const popped = state.building[wing][index].pop();
  const unit = findUnitEl(wing,index);
  if (unit){
    const slots = unit.querySelectorAll(".slot");
    for (let i=0;i<2;i++){
      const s = state.building[wing][index][i];
      slots[i].textContent = s ? (s==="up"?"↓" : "↑") : ""; // (kept original behavior)
    }
    
    // Auto-scroll to keep the modified orbital visible with smoother scrolling
    unit.scrollIntoView({ 
      behavior: 'smooth', 
      block: 'center',
      inline: 'center'
    });
  }
  refreshInfo(); 
  
  // Update the new configuration display
  updateNewConfigurationDisplay();
  
  renderReadouts(); 
  return popped;
}

/* ======= Helper Functions ======= */
function toSuperscript(num) {
  return num.toString().replace(/0/g, '⁰').replace(/1/g, '¹').replace(/2/g, '²').replace(/3/g, '³').replace(/4/g, '⁴').replace(/5/g, '⁵').replace(/6/g, '⁶').replace(/7/g, '⁷').replace(/8/g, '⁸').replace(/9/g, '⁹');
}

function selectRandomElement() {
  try {
    // Select a random element between 1 and 118
    const randomZ = Math.floor(Math.random() * 118) + 1;
    state.targetZ = randomZ;
    
    // Update the periodic table selection
    document.querySelectorAll(".ptile").forEach(t => t.classList.remove("selected"));
    const randomTile = document.querySelector(`.ptile[data-z="${randomZ}"]`);
    if (randomTile) {
      randomTile.classList.add("selected");
      randomTile.scrollIntoView({ block: "center", inline: "center", behavior: "smooth" });
    }
    
    // Update the configuration display
    const currentPickText = `Selected: ${sym(randomZ)} — ${nameOf(randomZ)} (Z=${randomZ})`;
    const newCurrentPick = document.getElementById("newCurrentPick");
    const newElectronCount = document.getElementById("newElectronCount");
    if (newCurrentPick) newCurrentPick.textContent = currentPickText;
    if (newElectronCount) newElectronCount.textContent = `0 / ${electronsNeeded()}`;
    
    // Update the configuration display
    updateNewConfigurationDisplay();
    
    // Reset building for the new element
    resetBuilding();
    
    console.log(`🎲 Randomly selected element: ${sym(randomZ)} (Z=${randomZ})`);
    toast(`🎲 Random element selected: ${sym(randomZ)} — ${nameOf(randomZ)}`);
    
    return randomZ;
  } catch(e) {
    console.error('Select random element error:', e);
    return 1; // Fallback to Hydrogen
  }
}

function updateNewConfigurationDisplay() {
  try {
    // Update the main configuration display
    const newCurrentConfig = document.getElementById("newCurrentConfig");
    if (newCurrentConfig) {
      const parts = []; // Define the parts array
      for (const sub of ORDER) {
        const units = state.building[sub];
        if (units) {
          let n = 0;
          for (const u of units) {
            n += u.length;
          }
          if (n > 0) {
            // Convert numbers to proper superscript characters and add color coding
            const superscript = toSuperscript(n);
            parts.push(`<span class="energy-level-${sub}">${sub}${superscript}</span>`);
          }
        }
      }
      newCurrentConfig.innerHTML = parts.length > 0 ? parts.join('&nbsp;&nbsp;') : '—';
    }
    
    // Update the shorthand configuration display
    const newShorthandConfig = document.getElementById("newShorthandConfig");
    if (newShorthandConfig) {
      const en = placedCount();
      if (en === 0) {
        newShorthandConfig.innerHTML = '—';
      } else {
        let core = NOBLES.filter(x => x.Z <= en).slice(-1)[0];
        if (!core) {
          newShorthandConfig.innerHTML = '—';
        } else {
          // Build theoretical core distribution
          const coreCounts = {};
          let rem = core.Z;
          for (const sub of ORDER) {
            const cap = subInfo(sub).capacity;
            const put = Math.min(cap, rem);
            if (put > 0) coreCounts[sub] = put;
            rem -= put;
            if (rem <= 0) break;
          }
          
          // Build output parts
          const outParts = [];
          for (const sub of ORDER) {
            const obs = state.building[sub].reduce((s, u) => s + u.length, 0);
            const corev = coreCounts[sub] || 0;
            const left = Math.max(0, obs - corev);
            if (left > 0) {
                          // Convert numbers to proper superscript characters and add color coding
            const superscript = toSuperscript(left);
            outParts.push(`<span class="energy-level-${sub}">${sub}${superscript}</span>`);
          }
        }
        
        newShorthandConfig.innerHTML = outParts.length > 0 ? `<span class="noble-gas">[${sym(core.Z)}]</span>&nbsp;&nbsp;${outParts.join('&nbsp;&nbsp;')}` : `<span class="noble-gas">[${sym(core.Z)}]</span>`;
        }
      }
    }
  } catch(e) {
    console.error('Update new configuration display error:', e);
  }
}

/* ======= Rules ======= */
function hasVacancy(sub){ return state.building[sub].some(u => u.length < 2); }
function subshellRank(sub){ return ORDER.indexOf(sub); }
function firstVacantSubshell(){ for (const s of ORDER){ if (hasVacancy(s)) return s; } return null; }
function refreshAufbauFocus(){
  const list = byId("aufbauList"); if (!list) return;
  const target = computeTargetCountsCurrent();
  const focus = firstSubshellNeedingElectrons(target);
  list.querySelectorAll("li").forEach(li => li.classList.toggle("active", li.dataset.sub === focus));
}

/* --- Ion-aware target distribution helpers --- */

// Fill counts along Aufbau (ORDER) for a given number of electrons.
// Optionally apply neutral exceptions for the chosen element Z.
function computeNeutralCountsFor(totalElectrons, applyExceptionsForZ) {
  let rem = totalElectrons;
  const counts = {};
  for (const sub of ORDER) {
    const cap = subInfo(sub).capacity;
    const put = Math.min(cap, rem);
    if (put > 0) counts[sub] = put;
    rem -= put;
    if (rem <= 0) break;
  }

  // If we're showing neutral exceptions for this element (Cr, Cu, …), nudge s→d.
  if (applyExceptionsForZ && EXCEPTIONS[state.targetZ]) {
    const ex = EXCEPTIONS[state.targetZ];
    const sCap = subInfo(ex.s).capacity;
    const dCap = subInfo(ex.d).capacity;

    const sBefore = counts[ex.s] || 0;
    const dBefore = counts[ex.d] || 0;

    // Force exception targets
    const sAfter = Math.min(sCap, ex.s_final);
    let dAfter  = Math.max(dBefore, ex.d_target);

    // Conserve electrons: any s electrons we removed go to d (up to capacity)
    const moved = Math.max(0, sBefore - sAfter);
    dAfter = Math.min(dCap, dAfter + moved);

    counts[ex.s] = sAfter;
    counts[ex.d] = dAfter;

    // If totals drifted, trim/add on the d line to match totalElectrons.
    const tot = Object.values(counts).reduce((a,b)=>a+b,0);
    const diff = totalElectrons - tot;
    if (diff !== 0) counts[ex.d] = Math.max(0, Math.min(dCap, (counts[ex.d]||0) + diff));
  }
  return counts;
}

// Removal priority for cations: highest n first; if tie, higher l (f>d>p>s)
const REMOVAL_ORDER = ORDER.slice().sort((a,b)=>{
  const A = subInfo(a), B = subInfo(b);
  if (A.n !== B.n) return B.n - A.n;   // higher n first
  return B.l - A.l;                     // then f>d>p>s
});

function removeElectronsFrom(counts, q){
  let left = q;
  for (const sub of REMOVAL_ORDER) {
    const have = counts[sub] || 0;
    if (!have) continue;
    const take = Math.min(have, left);
    counts[sub] = have - take;
    left -= take;
    if (left <= 0) break;
  }
  return counts;
}

// Compute the ion-aware target counts for CURRENT element/charge.
function computeTargetCountsCurrent(){
  const q = state.ionCharge || 0;

  if (q > 0) { // cation: build neutral with exceptions, then remove from highest n (e.g., 4s before 3d)
    const neutral = computeNeutralCountsFor(state.targetZ, /*apply exceptions?*/ state.exceptionsEnabled);
    return removeElectronsFrom({ ...neutral }, q);
  }

  if (q < 0) { // anion: just fill to Z - q electrons without applying neutral-exception hacks
    const total = state.targetZ - q; // q is negative
    return computeNeutralCountsFor(total, /*exceptions*/ false);
  }

  // Neutral: normal Aufbau, with optional exceptions toggle
  return computeNeutralCountsFor(state.targetZ, state.exceptionsEnabled);
}

// Find the first subshell that still needs electrons to hit the target.
function firstSubshellNeedingElectrons(target){
  for (const sub of ORDER){
    const have = (state.building[sub]||[]).reduce((s,u)=>s+(u?u.length:0),0);
    const want = target[sub] || 0;
    if (have < want) return sub;
  }
  return null;
}

/* ==== Exceptions set ==== */
const EXCEPTIONS = {
  24: { s:"4s", d:"3d", s_prefill:1, d_target:5,  s_final:1 },  // Cr
  29: { s:"4s", d:"3d", s_prefill:1, d_target:10, s_final:1 },  // Cu
  41: { s:"5s", d:"4d", s_prefill:1, d_target:4,  s_final:1 },  // Nb
  42: { s:"5s", d:"4d", s_prefill:1, d_target:5,  s_final:1 },  // Mo
  44: { s:"5s", d:"4d", s_prefill:1, d_target:7,  s_final:1 },  // Ru
  45: { s:"5s", d:"4d", s_prefill:1, d_target:8,  s_final:1 },  // Rh
  46: { s:"5s", d:"4d", s_prefill:0, d_target:10, s_final:0 },  // Pd
  47: { s:"5s", d:"4d", s_prefill:1, d_target:10, s_final:1 },  // Ag
  78: { s:"6s", d:"5d", s_prefill:1, d_target:9,  s_final:1 },  // Pt
  79: { s:"6s", d:"5d", s_prefill:1, d_target:10, s_final:1 }   // Au
};
function countIn(sub){ return state.building[sub].reduce((sum,u)=> sum + (u ? u.length : 0), 0); }
function hasVac(sub){ return hasVacancy(sub); }
function exceptionPreferredSubshell(){
  if(!state.exceptionsEnabled) return null;
  const rule = EXCEPTIONS[state.targetZ];
  if(!rule) return null;
  const sCount = countIn(rule.s);
  const dCount = countIn(rule.d);
  const dHasVac = hasVac(rule.d);
  if (rule.s_prefill === 0){
    if (dHasVac && dCount < rule.d_target) return rule.d;
  } else {
    if (sCount >= rule.s_prefill && dHasVac && dCount < rule.d_target) return rule.d;
  }
  return null;
}

function legalPlacement(wing, index, spin){
  // Ion-aware target: pick the subshell that still needs electrons
  const target = computeTargetCountsCurrent();
  const must = firstSubshellNeedingElectrons(target);
  if (must && wing !== must){
    return { ok:false, rule:"Aufbau", msg:`Place in ${must} now.` };
  }

  const occ = state.building[wing][index];
  if (occ.length >= 2) return { ok:false, rule:"Pauli", msg:`Max 2 per orbital.` };
  if (occ.length === 1 && occ[0] === spin) return { ok:false, rule:"Pauli", msg:`Pair must be opposite spins.` };
  const info = subInfo(wing);
  if (info.orbitals > 1){
    const units = state.building[wing];
    const emptyUnits = units.map((u,i)=>({u,i})).filter(x => x.u.length === 0);
    const singleUnits = units.map((u,i)=>({u,i})).filter(x => x.u.length === 1);
    if (emptyUnits.length > 0){
      const isEmptyTarget = units[index].length === 0;
      if (!isEmptyTarget) return { ok:false, rule:"Hund", msg:`Spread out: single-occupy all ${wing} orbitals first.` };
      if (singleUnits.length > 0){
        const expected = singleUnits[0].u[0];
        if (spin !== expected) return { ok:false, rule:"Hund", msg:`Use same spin (${expected === 'up' ? '↑' : '↓'}) for singles.` };
      }
    }
  }
  return { ok:true };
}

/* ======= Study mode click-to-place ======= */
function recommendedSpinFor(wing, index){
  try {
    const info = subInfo(wing);
    if (info.orbitals === 1){
      const occ = state.building[wing][0];
      if (occ.length === 0) return { spin:"up", slotIndex:0 };
      if (occ.length === 1) return { spin:(occ[0]==="up"?"down":"up"), slotIndex:1 };
    } else {
      const units = state.building[wing];
      const occ = units[index];
      if (occ.length === 0){
        const singles = units.filter(u => u.length === 1);
        return { spin: singles.length ? singles[0][0] : "up", slotIndex:0 };
      } else if (occ.length === 1){
        return { spin:occ[0]==="up"?"down":"up", slotIndex:1 };
      }
    }
    return { spin:"up", slotIndex:0 };
  } catch(e) {
    console.error('Recommended spin error:', e);
    return { spin:"up", slotIndex:0 };
  }
}

function onUnitClick(e, unit){
  try {
    if (state.mode !== "study") return;
    if (overCap()){ 
      toast("Configuration complete — no more electrons."); 
      clearGhost(); 
      return; 
    } 
    const wing = unit.dataset.wing;
    const index = parseInt(unit.dataset.index,10);
    const rec = recommendedSpinFor(wing, index);
    const res = legalPlacement(wing, index, rec.spin);
    if (!res.ok){
      const sandbox = byId("sandboxToggle")?.checked;
      if (sandbox){
        placeElectronInto(wing, index, rec.spin);
        toast(`Sandbox: would violate ${res.rule} — ${res.msg}`);
      } else {
        unit.classList.add("invalid"); 
        setTimeout(()=> unit.classList.remove("invalid"), 220);
        toast(`${res.rule} violation: ${res.msg}`); 
        return;
      }
    } else {
      placeElectronInto(wing, index, rec.spin);
    }
    refreshAufbauFocus(); 
    planStudyGhost();
  } catch(e) {
    console.error('Unit click error:', e);
    toast('An error occurred. Please try again.');
  }
}

function ghostNextMove(){
  try {
    if (overCap()) return null;
    const target = computeTargetCountsCurrent();
    const focus = firstSubshellNeedingElectrons(target);
    if (!focus) return null;

    const info = subInfo(focus);
    let spin = "up"; 
    let index = 0; 
    let slotIndex = 0;

    if (info.orbitals === 1){
      const occ = state.building[focus][0];
      if (occ.length === 1){ 
        spin = (occ[0]==="up"?"down":"up"); 
        slotIndex = 1; 
      }
    } else {
      const units = state.building[focus];
      const empties = units.map((u,i)=>({u,i})).filter(x=>x.u.length===0);
      const singles = units.map((u,i)=>({u,i})).filter(x=>x.u.length===1);
      if (empties.length>0){ 
        index = empties[0].i; 
        slotIndex=0; 
        spin = singles.length>0 ? singles[0].u[0] : "up"; 
      }
      else if (singles.length>0){ 
        index = singles[0].i; 
        slotIndex=1; 
        spin = singles[0].u[0]==="up" ? "down" : "up"; 
      }
    }
    return { wing:focus, index, spin, slotIndex };
  } catch(e) {
    console.error('Ghost next move error:', e);
    return null;
  }
}

function clearGhost(){
  try {
    document.querySelectorAll(".unit.ghost").forEach(u => u.classList.remove("ghost"));
    document.querySelectorAll(".slot.ghost-slot").forEach(s => s.classList.remove("ghost-slot"));
  } catch(e) {
    console.error('Clear ghost error:', e);
  }
}

function renderGhost(move){
  try {
    clearGhost(); 
    if (!move) return;
    const unit = findUnitEl(move.wing, move.index); 
    if (!unit) return;
    unit.classList.add("ghost");
    const slot = unit.querySelectorAll(".slot")[move.slotIndex || 0];
    if (slot) slot.classList.add("ghost-slot");
  } catch(e) {
    console.error('Render ghost error:', e);
  }
}

function planStudyGhost(){ 
  try {
    renderGhost(ghostNextMove()); 
    refreshInfo(); 
  } catch(e) {
    console.error('Plan study ghost error:', e);
  }
}

/* ======= Game (drag or click) ======= */
function newGame(){
  try {
    // Select a random element for the new game
    selectRandomElement();
    
    clearAutoPlay(); 
    byId("score").textContent = "0"; 
    state.score = 0;
    stopTimer(); 
    state.streak = 0; 
    byId("streak").textContent = "0";
    resetBuilding(); 
    state.queue = []; 
    state.nextId = 1;
    
    // Ensure exceptions are enabled for game mode
    if (state.mode === "game") {
      state.exceptionsEnabled = true;
      const exceptionsToggle = byId("exceptionsToggle");
      if (exceptionsToggle) {
        const input = exceptionsToggle.querySelector("input");
        if (input && !input.checked) {
          input.checked = true;
          toast("Exceptions enabled for Game Mode");
        }
      }
    }
    
    const total = electronsNeeded();
    console.log('🎯 Starting new game with', total, 'electrons');
    for (let i=0;i<total;i++){ 
      // Default to "up" always, unless user has flipped to "down"
      let spin = "up"; // Default to up
      if (state.lastSpinPreference === "down") {
        // Only use down if user explicitly flipped to down
        spin = "down";
        console.log('🔄 Using remembered spin preference: down');
      } else {
        console.log('🔄 Using default spin: up');
      }
      state.queue.push({ id: state.nextId++, spin }); 
    }
    console.log('📋 Queue populated with', state.queue.length, 'electrons');
    spawnNextElectron(); 
    updateQueueInfo(); // Update initial queue display
    // Don't auto-start timer - wait for Start Game button
    // startTimer(); // Removed auto-start
    // Show start button for new game
    byId("startGameBtn").classList.remove("hidden");
  } catch(e) {
    console.error('New game error:', e);
    toast('Failed to start new game. Please try again.');
  }
}

function spawnNextElectron(){
  try {
    const elLobby = byId("lobbyArea"); 
    if (!elLobby) return; 
    elLobby.innerHTML = "";
    if (state.queue.length === 0){ 
      console.log('🎯 Queue is empty - game completed!');
      console.log('🎉 About to call showCongratulations()');
      console.log('🔍 Current state:', {
        targetZ: state.targetZ,
        mode: state.mode,
        score: state.score,
        streak: state.streak
      });
      
      // Check if we actually have all electrons placed
      const totalNeeded = electronsNeeded();
      const totalPlaced = placedCount();
      console.log('📊 Electron count check:', {
        needed: totalNeeded,
        placed: totalPlaced,
        queueLength: state.queue.length
      });
      
      if (totalPlaced === totalNeeded) {
        console.log('✅ All electrons placed, showing congratulations!');
        // Game completed! Show congratulations
        try {
          window.showCongratulations();
          console.log('✅ showCongratulations() called successfully');
        } catch (error) {
          console.error('❌ Error calling showCongratulations:', error);
        }
      } else {
        console.log('⚠️ Queue empty but not all electrons placed:', totalPlaced, '/', totalNeeded);
      }
      return; 
    } 
    const e = state.queue[0];
    const el = document.createElement("div");
    el.className = `electron ${e.spin}`; 
    el.setAttribute("draggable","true"); 
    el.id = `electron-${e.id}`; 
    el.dataset.spin = e.spin;
    el.title = "Drag me into a unit."; 
    el.textContent = e.spin === "up" ? "↑" : "↓";
    on(el, "dragstart", (ev)=>{
      try {
        ev.dataTransfer.setData("text/plain", JSON.stringify({ id:e.id })); 
      } catch(e) {
        console.error('Drag start error:', e);
      }
    });
    elLobby.appendChild(el);
  } catch(e) {
    console.error('Spawn next electron error:', e);
  }
}

function updateQueueInfo(){
  try {
    const total = electronsNeeded(); 
    const placed = placedCount(); // Use actual placed count instead of math
    const qi = byId("queueInfo"); 
    if (qi) qi.textContent = `Queue: ${placed} / ${total}`;
    
    // Also update the new configuration display
    const newElectronCount = document.getElementById("newElectronCount");
    if (newElectronCount) {
      // For ions, show the actual electron count
      if (state.ionCharge !== 0) {
        const actualElectrons = state.targetZ - state.ionCharge;
        newElectronCount.textContent = `${placed} / ${actualElectrons}`;
      } else {
        newElectronCount.textContent = `${placed} / ${total}`;
      }
    }
  } catch(e) {
    console.error('Update queue info error:', e);
  }
}

function onDropToUnit(ev){
  try {
    ev.preventDefault();
    if (state.mode !== "game") return;
    const unitEl = ev.currentTarget;
    const wing = unitEl.dataset.wing; 
    const idx = parseInt(unitEl.dataset.index,10);
    const lobbyElectron = state.queue[0]; 
    if (!lobbyElectron) return;
    const res = legalPlacement(wing, idx, lobbyElectron.spin);
    if (!res.ok){
      unitEl.classList.add("invalid"); 
      setTimeout(()=>unitEl.classList.remove("invalid"), 220);
      addScore(-5); 
      toast(`${res.rule} violation: ${res.msg}`);
      state.streak = 0; 
      byId("streak").textContent = "0"; 
      return;
    }
    state.queue.shift();
    console.log('📤 Electron placed, queue now has', state.queue.length, 'electrons');
    placeElectronInto(wing, idx, lobbyElectron.spin);
    addScore(10);
    const info = subInfo(wing);
    if (info.orbitals > 1){
      const singles = state.building[wing].filter(u => u.length === 1).length;
      if (singles <= info.orbitals) addScore(5);
    }
    if (state.building[wing][idx].length === 2) addScore(15);
    state.streak += 1; 
    byId("streak").textContent = String(state.streak);
    updateQueueInfo(); // Update queue info after electron is placed
    spawnNextElectron(); 
    refreshAufbauFocus();
  } catch(e) {
    console.error('Drop to unit error:', e);
    toast('An error occurred. Please try again.');
  }
}

/* click-to-place also works in Game */
document.addEventListener("click", function(ev){
  try {
    if (state.mode !== "game") return;
    const unit = ev.target.closest && ev.target.closest(".unit");
    if (!unit) return;
    ev.preventDefault();
    const e0 = state.queue[0]; 
    if (!e0){ 
      toast("No electron in the lobby."); 
      return; 
    } 
    const wing = unit.dataset.wing; 
    const idx = parseInt(unit.dataset.index,10);
    const res = legalPlacement(wing, idx, e0.spin);
    if (!res.ok){
      unit.classList.add("invalid"); 
      setTimeout(()=> unit.classList.remove("invalid"), 220);
      addScore(-5); 
      toast(`${res.rule} violation: ${res.msg}`);
      state.streak = 0; 
      byId("streak").textContent = "0"; 
      return;
    }
    state.queue.shift();
    console.log('📤 Electron placed (click), queue now has', state.queue.length, 'electrons');
    placeElectronInto(wing, idx, e0.spin);
    addScore(10);
    const info = subInfo(wing);
    if (info.orbitals > 1){
      const singles = state.building[wing].filter(u => u.length === 1).length;
      if (singles <= info.orbitals) addScore(5);
    }
    if (state.building[wing][idx].length === 2) addScore(15);
    state.streak += 1; 
    byId("streak").textContent = String(state.streak);
    updateQueueInfo(); // Update queue info after electron is placed
    spawnNextElectron(); 
    refreshAufbauFocus();
  } catch(e) {
    console.error('Game click handler error:', e);
    toast('An error occurred. Please try again.');
  }
}, false);

/* ======= Readouts (full + noble shorthand) ======= */
function renderReadouts(){
  try {
    // Full spectroscopic from current building
    const el = document.getElementById("spectro"); 
    if (el){
      try {
        const parts=[];
        for (const sub of ORDER){
          try {
            const units=state.building[sub]; 
            let n=0; 
            for (const u of units) n+=u.length;
            if (n>0) parts.push(sub + '<sup>'+n+'</sup>');
          } catch(e) {
            console.error('Render readouts error for sub:', sub, e);
          }
        }
        el.innerHTML = parts.join(' ');
        
                  // Also update the new configuration display area
          const configEl = document.getElementById("newCurrentConfig");
          if (configEl) {
            configEl.innerHTML = parts.join(' ');
          }
          
          // Update the new shorthand configuration display
          const shorthandEl = document.getElementById("newShorthandConfig");
          if (shorthandEl) {
            // Get the noble gas shorthand from the existing logic
            const nobleEl = document.getElementById("noble");
            if (nobleEl && nobleEl.textContent !== "—") {
              shorthandEl.innerHTML = nobleEl.textContent;
            } else {
              shorthandEl.innerHTML = "—";
            }
          }
      } catch(e) {
        console.error('Spectro render error:', e);
      }
    }
    
    // Noble shorthand (live) from current building
    try {
      const en = placedCount();
      const ns = document.getElementById("noble"); 
      if (!ns) return; 
      if (en === 0){ 
        ns.textContent = "—"; 
        return; 
      } 
      let core = NOBLES.filter(x=>x.Z <= en).slice(-1)[0];
      if (!core){ 
        ns.textContent = "—"; 
        return; 
      } 
      // build theoretical core distribution (to subtract from observed)
      const coreCounts = {}; 
      let rem = core.Z;
      for (const sub of ORDER){
        try {
          const cap = subInfo(sub).capacity;
          const put = Math.min(cap, rem); 
          if (put>0) coreCounts[sub]=put; 
          rem -= put; 
          if (rem<=0) break;
        } catch(e) {
          console.error('Core counts error for sub:', sub, e);
        }
      }
      const outParts=[];
      for (const sub of ORDER){
        try {
          const obs = state.building[sub].reduce((s,u)=>s+u.length,0);
          const corev = coreCounts[sub]||0;
          const left = Math.max(0, obs - corev);
          if (left>0) outParts.push(sub + '<sup>'+left+'</sup>');
        } catch(e) {
          console.error('Out parts error for sub:', sub, e);
        }
      }
      const shorthandText = `[${core.sym}] ` + (outParts.join(' ') || '');
      ns.innerHTML = shorthandText;
      
      // Also update the new shorthand configuration display
      const shorthandEl = document.getElementById("newShorthandConfig");
      if (shorthandEl) {
        shorthandEl.innerHTML = shorthandText;
      }
    } catch(e) {
      console.error('Noble shorthand error:', e);
    }
  } catch(e) {
    console.error('Render readouts error:', e);
  }
}

/* ======= Info box ======= */
function refreshInfo(){
  try {
    const ex = state.exceptionsEnabled && EXCEPTIONS[state.targetZ];
    const exPick = exceptionPreferredSubshell();
    const focus = exPick || firstVacantSubshell() || ORDER[ORDER.length-1];
    const info = subInfo(focus);
    const electrons = electronsNeeded(); 
    const placed = placedCount();
    const Z = state.targetZ || 1;
    const hundNote = (info.orbitals > 1) ? `<li><b>Hund:</b> single-occupy ${info.orbitals} orbitals with the <b>same spin</b> before pairing.</li>` : "";
    const crossover = (focus === "4s") ? `<li>Cross-over: <b>4s</b> slightly before <b>3d</b>.</li>` :
                      (focus === "3d") ? `<li>Now filling <b>3d</b> after <b>4s</b>.</li>` : "";
    const exNote = ex ? `<li><b>Exceptions:</b> ${sym(Z)} follows a stability detour (d<sup>${ex.d_target}</sup>, s→${ex.s_final}).</li>` : "";
    const modeText = state.mode==="study" ? "Study: click the glowing slot." : "Game: drag or click-to-place from the lobby.";
    const infoNow = byId("infoNow"); 
    if (!infoNow) return; 
    infoNow.innerHTML = `
      <div><b>Now filling:</b> <code>${focus}</code> — n=${info.n}, ℓ=${info.l} (${info.letter}), Orbitals: ${info.orbitals}, Capacity: ${info.capacity} e⁻.</div>
      <ul class="mini">
        <li><b>Element:</b> ${sym(Z)} (Z=${Z}) • <b>Electrons:</b> ${placed} / ${electrons}${state.ionCharge!==0 ? ` (charge ${state.ionCharge>0?"+":""}${state.ionCharge})`:""}</li>
        <li><b>Aufbau:</b> lowest-energy subshell first.</li>
        ${hundNote}
        <li><b>Pauli:</b> opposite spins in a pair (↑↓).</li>
        ${crossover}
        ${exNote}
        <li>${modeText}</li>
      </ul>`;
    const ec = byId("electronCount"); 
    if (ec) ec.textContent = electrons;
    const pc = byId("placedCount"); 
    if (pc) pc.textContent = placed;
  } catch(e) {
    console.error('Refresh info error:', e);
  }
}

/* ======= Auto-play & timer ======= */
function clearAutoPlay(){ 
  try {
    if (state.autoTimer){ 
      clearInterval(state.autoTimer); 
      state.autoTimer=null; 
    } 
    const ap = byId("autoPlayToggle"); 
    if (ap) {
      const input = ap.querySelector("input");
      if (input) input.checked = false;
    }
  } catch(e) {
    console.error('Clear auto play error:', e);
  }
}

function startTimer(){ 
  try {
    stopTimer(); 
    state.startTime = Date.now(); 
    const t = byId("timer"); 
    if (t) t.textContent = "00:00";
    state.timerId = setInterval(()=>{ 
      try {
        const s = Math.floor((Date.now()-state.startTime)/1000); 
        const m = Math.floor(s/60); 
        const ss = s%60; 
        const t = byId("timer"); 
        if (t) t.textContent = `${String(m).padStart(2,"0")}:${String(ss).padStart(2,"0")}`; 
      } catch(e) {
        console.error('Timer interval error:', e);
        stopTimer();
      }
    }, 1000);
  } catch(e) {
    console.error('Start timer error:', e);
  }
}

function stopTimer(){ 
  try {
    if (state.timerId){ 
      clearInterval(state.timerId); 
      state.timerId = null; 
    } 
  } catch(e) {
    console.error('Stop timer error:', e);
  }
}

/* ======= PT wiring ======= */
function buildPT(){
  try {
    const elPT = byId("ptable"); 
    if (!elPT) return; 
    buildPTGrid(elPT, (Z, tile)=>{
      try {
        // In game mode, don't allow element selection - just show a message
        if (state.mode === "game") {
          toast("Element selection disabled in Game Mode. Use 'New Game' to get a random element.");
          return;
        }
        
        state.targetZ = Z;
        state.ionCharge = 0; // Reset ion charge when selecting new element
        const ic = byId("ionCharge"); if (ic) ic.textContent = "0";
        
        document.querySelectorAll(".ptile").forEach(t=>t.classList.remove("selected"));
        tile.classList.add("selected");
        
        // Update the new configuration display area
        const currentPickText = `${sym(Z)} — ${nameOf(Z)} (Z=${Z})`;
        const newCurrentPick = document.getElementById("newCurrentPick");
        const newElectronCount = document.getElementById("newElectronCount");
        if (newCurrentPick) newCurrentPick.textContent = currentPickText;
        if (newElectronCount) newElectronCount.textContent = `0 / ${electronsNeeded()}`;
        
        // Update ion state display
        updateIonStateDisplay();
        
        // Update the configuration display
        updateNewConfigurationDisplay();
        
        if (state.mode === "study"){ 
          resetBuilding(); 
          planStudyGhost(); 
        }
      } catch(e) {
        console.error('PT tile click error:', e);
      }
    }, state.targetZ);
  } catch(e) {
    console.error('Build PT error:', e);
  }
}

/* ======= Ion & Search ======= */
function setIonCharge(delta){
  // In game mode, don't allow ion charge changes
  if (state.mode === "game") {
    toast("Ion charge changes disabled in Game Mode. Focus on completing the electron configuration.");
    return;
  }
  
  // Check if element is selected
  if (!state.targetZ || state.targetZ < 1) {
    toast("Please select an element first");
    return;
  }
  
  // Get allowed charges for current element
  const allowedCharges = getElementAllowedCharges(state.targetZ);
  const currentCharge = state.ionCharge || 0;
  
  // Find the next/previous allowed charge
  let newCharge;
  if (delta > 0) {
    // Going up: find next higher allowed charge
    const higherCharges = allowedCharges.filter(c => c > currentCharge).sort((a, b) => a - b);
    newCharge = higherCharges.length > 0 ? higherCharges[0] : currentCharge;
  } else {
    // Going down: find next lower allowed charge
    const lowerCharges = allowedCharges.filter(c => c < currentCharge).sort((a, b) => b - a);
    newCharge = lowerCharges.length > 0 ? lowerCharges[0] : currentCharge;
  }
  
  // If no change possible, show message
  if (newCharge === currentCharge) {
    const elementName = names[state.targetZ - 1];
    if (delta > 0) {
      toast(`${elementName} is already at its highest allowed charge (${currentCharge > 0 ? '+' : ''}${currentCharge})`);
    } else {
      toast(`${elementName} is already at its lowest allowed charge (${currentCharge > 0 ? '+' : ''}${currentCharge})`);
    }
    return;
  }
  
  state.ionCharge = newCharge;
  
  const ic = byId("ionCharge"); 
  if (ic) {
    const displayText = state.ionCharge > 0 ? `+${state.ionCharge}` : `${state.ionCharge}`;
    ic.textContent = displayText;
  }
  
  // Update ion state display
  updateIonStateDisplay();
  
  if (state.mode==="study"){ resetBuilding(); planStudyGhost(); }
}

function updateIonStateDisplay() {
  const ionStateElement = byId("newIonState");
  if (!ionStateElement) return;
  
  if (state.ionCharge === 0) {
    ionStateElement.textContent = "Neutral atom";
    ionStateElement.className = "config-value";
  } else {
    const elementName = names[state.targetZ - 1];
    const elementSymbol = symbols[state.targetZ - 1];
    
    if (state.ionCharge > 0) {
      // For positive charges, show the actual charge number
      const chargeSymbol = state.ionCharge === 1 ? '⁺' : 
                          state.ionCharge === 2 ? '²⁺' : 
                          state.ionCharge === 3 ? '³⁺' : 
                          state.ionCharge === 4 ? '⁴⁺' : 
                          state.ionCharge === 5 ? '⁵⁺' : 
                          state.ionCharge === 6 ? '⁶⁺' : 
                          state.ionCharge === 7 ? '⁷⁺' : 
                          state.ionCharge === 8 ? '⁸⁺' : 
                          `+${state.ionCharge}`;
      ionStateElement.textContent = `${elementSymbol}${chargeSymbol} (lost ${state.ionCharge} electron${state.ionCharge > 1 ? 's' : ''})`;
      ionStateElement.className = "config-value positive-ion";
    } else {
      // For negative charges, show the actual charge number
      const chargeSymbol = state.ionCharge === -1 ? '⁻' : 
                          state.ionCharge === -2 ? '²⁻' : 
                          state.ionCharge === -3 ? '³⁻' : 
                          state.ionCharge === -4 ? '⁴⁻' : 
                          state.ionCharge === -5 ? '⁵⁻' : 
                          state.ionCharge === -6 ? '⁶⁻' : 
                          state.ionCharge === -7 ? '⁷⁻' : 
                          state.ionCharge === -8 ? '⁸⁻' : 
                          `${state.ionCharge}`;
      ionStateElement.textContent = `${elementSymbol}${chargeSymbol} (gained ${Math.abs(state.ionCharge)} electron${Math.abs(state.ionCharge) > 1 ? 's' : ''})`;
      ionStateElement.className = "config-value negative-ion";
    }
  }
  
  // Update ion charge info display
  updateIonChargeInfo();
}

function updateIonChargeInfo() {
  const ionInfoElement = byId("ionChargeInfo");
  if (!ionInfoElement) return;
  
  if (!state.targetZ || state.targetZ < 1) {
    ionInfoElement.textContent = "";
    return;
  }
  
  const allowedCharges = getElementAllowedCharges(state.targetZ);
  const currentCharge = state.ionCharge || 0;
  
  // Format the allowed charges for display
  const formattedCharges = allowedCharges.map(c => {
    if (c === 0) return "0";
    if (c > 0) return `+${c}`;
    return `${c}`;
  });
  
  // Highlight current charge
  const chargeText = formattedCharges.map(c => {
    if (c === (currentCharge > 0 ? `+${currentCharge}` : currentCharge < 0 ? `${currentCharge}` : "0")) {
      return `[${c}]`; // Highlight current charge
    }
    return c;
  }).join(" ");
  
  ionInfoElement.textContent = chargeText;
  ionInfoElement.title = `Available charges: ${formattedCharges.join(", ")}`;
}
function searchPick(q){
  q = (q||"").trim().toLowerCase(); if (!q) return;
  
  // In game mode, don't allow element selection via search
  if (state.mode === "game") {
    toast("Element search disabled in Game Mode. Use 'New Game' to get a random element.");
    return;
  }
  
  const asNum = parseInt(q,10); let Z = null;
  if (!isNaN(asNum) && asNum>=1 && asNum<=118) Z = asNum;
  if (!Z){ Z = symbols.findIndex(s=>s.toLowerCase()===q)+1;
    if (!Z){ Z = names.findIndex(n=>n.toLowerCase().startsWith(q))+1; if (Z===0) Z = null; }
  }
  if (Z){
    const tile = Array.from(document.querySelectorAll(".ptile")).find(t=>parseInt(t.dataset.z,10)===Z);
    if (tile){ tile.click(); tile.scrollIntoView({block:"center", inline:"center", behavior:"smooth"}); }
  }
}

/* ======= Help modal ======= */
function openHelp(which="study"){
  const bd = byId("helpBackdrop"); bd.classList.remove("hidden"); bd.setAttribute("aria-hidden","false");
  const tabStudy = byId("tabStudy"), tabGame = byId("tabGame"), helpStudy = byId("helpStudy"), helpGame = byId("helpGame");
  if (which === "game"){ tabGame.classList.add("active"); tabStudy.classList.remove("active"); helpGame.classList.remove("hidden"); helpStudy.classList.add("hidden"); }
  else { tabStudy.classList.add("active"); tabGame.classList.remove("active"); helpStudy.classList.remove("hidden"); helpGame.classList.add("hidden"); }
}

// Back button functionality
function showBackButton() {
  const backBtn = byId("backBtn");
  if (backBtn) backBtn.style.display = "inline-flex";
}

function hideBackButton() {
  const backBtn = byId("backBtn");
  if (backBtn) backBtn.style.display = "none";
}

function goBack() {
  // Add back navigation logic here
  console.log("Back button clicked");
}

function closeHelp(){ const bd = byId("helpBackdrop"); bd.classList.add("hidden"); bd.setAttribute("aria-hidden","true"); }

/* ======= Version modal ======= */
function openVersion(){
  const bd = byId("versionModal"); 
  bd.classList.remove("hidden"); 
  bd.setAttribute("aria-hidden","false");
}

function closeVersion(){ 
  const bd = byId("versionModal"); 
  bd.classList.add("hidden"); 
  bd.setAttribute("aria-hidden","true"); 
}

// Version management system
// 
// HOW TO ADD A NEW VERSION:
// 1. Call addNewVersion() with version data
// 2. Example:
//    addNewVersion(createVersionEntry("v0.16r9", "New Feature Release", {
//      new: ["Feature 1 - Description", "Feature 2 - Description"],
//      improvements: ["Improvement 1", "Improvement 2"],
//      fixes: ["Fix 1", "Fix 2"]
//    }));
//
// 3. The version page will automatically update with the new entry
// 4. The header version will also update automatically
//
const VERSION_HISTORY = [
  {
            version: "v0.17r0",
    title: "Current Stable Release",
    date: "August 2025",
    isCurrent: true,
    features: {
      new: [
        "Smart Ion Charge System - Chemically accurate charge restrictions",
        "Enhanced Ion Display - Clear charge indicators (Cr⁺, Cr²⁺, Cr³⁺, etc.)",
        "Comprehensive Charge Database - All 118 elements with accurate oxidation states",
        "Improved Electron Configuration - Correct ion formation (4s before 3d)",
        "Default Exceptions - Always enabled for realistic learning"
      ],
      improvements: [
        "Fixed electron configuration for all ions",
        "Enhanced UI with ion state display",
        "Smart charge navigation (jump to valid charges)",
        "Better error messages and user feedback"
      ]
    }
  },
  {
    version: "v0.16r7",
    title: "Ion System Foundation",
    date: "August 2025",
    isCurrent: false,
    features: {
      new: [
        "Ion Charge System - Basic +/- buttons for element charges",
        "Ion State Display - Shows current ion configuration",
        "Charge Info Display - Available charges for each element"
      ]
    }
  },
  {
    version: "v0.16r6",
    title: "Study Page & UX Improvements",
    date: "August 2025",
    isCurrent: false,
    features: {
      new: [
        "Comprehensive Study Page - Interactive learning modules",
        "UX Audit Implementation - Improved user experience",
        "Color Scheme Updates - Consistent design language"
      ]
    }
  },
  {
    version: "v0.16r5",
    title: "Periodic Table Corrections",
    date: "August 2025",
    isCurrent: false,
    features: {
      fixes: [
        "Corrected Helium position (Group 18)",
        "Fixed f-block element placement",
        "Removed gaps between s, d, and p blocks",
        "Centered periodic table layout"
      ]
    }
  },
  {
    version: "v0.16r4",
    title: "Core Stability & Testing",
    date: "August 2025",
    isCurrent: false,
    features: {
      improvements: [
        "Memory leak fixes",
        "Enhanced error handling",
        "Comprehensive test suite",
        "Performance optimizations"
      ]
    }
  },
  {
    version: "v0.16r3",
    title: "Initial Release",
    date: "August 2025",
    isCurrent: false,
    features: {
      new: [
        "Electron Configuration Builder - Visual electron placement",
        "Periodic Table Integration - All 118 elements",
        "Study Mode - Interactive learning environment",
        "Game Mode - Timed challenges with scoring",
        "Exceptions Support - Cr, Cu, and other special cases"
      ]
    }
  }
];

// Function to add a new version (call this after each update)
function addNewVersion(versionData) {
  // Add to the beginning of the array (newest first)
  VERSION_HISTORY.unshift(versionData);
  
  // Update the current version indicator
  VERSION_HISTORY.forEach(v => v.isCurrent = false);
  VERSION_HISTORY[0].isCurrent = true;
  
  // Update the version display
  updateVersionDisplay();
  
  // Update the header version
  updateHeaderVersion();
}

// Function to update the version display
function updateVersionDisplay() {
  const timelineContainer = byId("versionTimeline");
  if (!timelineContainer) return;
  
  timelineContainer.innerHTML = VERSION_HISTORY.map(version => `
    <div class="version-entry ${version.isCurrent ? 'current' : ''}">
      <div class="version-badge">${version.version}</div>
      <div class="version-content">
        <h4>${version.title}</h4>
        <p class="version-date">${version.date}</p>
        <div class="version-features">
          ${version.features.new ? `
            <h5>✨ New Features:</h5>
            <ul>
              ${version.features.new.map(feature => `<li><strong>${feature.split(' - ')[0]}</strong> - ${feature.split(' - ')[1] || feature}</li>`).join('')}
            </ul>
          ` : ''}
          ${version.features.improvements ? `
            <h5>🔧 Improvements:</h5>
            <ul>
              ${version.features.improvements.map(feature => `<li>${feature}</li>`).join('')}
            </ul>
          ` : ''}
          ${version.features.fixes ? `
            <h5>🔧 Fixes:</h5>
            <ul>
              ${version.features.fixes.map(feature => `<li>${feature}</li>`).join('')}
            </ul>
          ` : ''}
        </div>
      </div>
    </div>
  `).join('');
}

// Function to update the header version
function updateHeaderVersion() {
  const currentVersion = VERSION_HISTORY[0];
  const subtitle = document.querySelector('.subtitle');
  if (subtitle && currentVersion) {
    subtitle.textContent = `${currentVersion.version} — ${currentVersion.title}`;
  }
}

// Function to get current version info
function getCurrentVersion() {
  return VERSION_HISTORY[0];
}

// Function to create a new version entry (helper function)
function createVersionEntry(version, title, features) {
  const currentDate = new Date().toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
  
  return {
    version: version,
    title: title,
    date: currentDate,
    isCurrent: true,
    features: features
  };
}

/* ======= Exceptions toggles (both modes, synced) ======= */
function attachExceptionsToggles(){
  // Set up the exceptions toggle in study mode
  const exceptionsToggle = byId("exceptionsToggle");
  if (exceptionsToggle) {
    const input = exceptionsToggle.querySelector("input");
    if (input) {
      console.log("Setting up exceptions toggle");
      input.checked = !!state.exceptionsEnabled;
      input.addEventListener("change", (e) => {
        console.log("Exceptions toggle changed:", e.target.checked);
        state.exceptionsEnabled = !!e.target.checked;
        toast(state.exceptionsEnabled ? "Exceptions ON" : "Exceptions OFF");
        planStudyGhost();
      });
    } else {
      console.error("Could not find input in exceptions toggle");
    }
  } else {
    console.error("Could not find exceptions toggle");
  }
}

/* ======= Init ======= */
function init(){
  buildAufbauList(); 
  buildFloors(); 
  buildPT(); 
  attachExceptionsToggles();
  
  // Initialize version display
  updateVersionDisplay();
  updateHeaderVersion();

  const zr = byId("zoomRange"); if (zr){ document.documentElement.style.setProperty("--tile", zr.value+"px"); zr.addEventListener("input", ()=> document.documentElement.style.setProperty("--tile", zr.value+"px")); }
  const sb = byId("searchBox"); if (sb) addEventListener("keydown", (e)=>{ if (e.key === "Enter"){ searchPick(sb.value); } });

  on(byId("hintToggle"), "change", e=> state.showHints = !!e.target.checked);
  on(byId("ionMinus"), "click", ()=> setIonCharge(-1));
  on(byId("ionPlus"), "click", ()=> setIonCharge(+1));
  
  // Add click handler for ion charge info
  const ionInfo = byId("ionChargeInfo");
  if (ionInfo) {
    ionInfo.addEventListener("click", () => {
      if (state.targetZ && state.targetZ > 0) {
        const allowedCharges = getElementAllowedCharges(state.targetZ);
        const elementName = names[state.targetZ - 1];
        const formattedCharges = allowedCharges.map(c => {
          if (c === 0) return "0";
          if (c > 0) return `+${c}`;
          return `${c}`;
        });
        toast(`${elementName} available charges: ${formattedCharges.join(", ")}`);
      }
    });
  }

  on(byId("newGameBtn"), "click", (ev)=>{
    const tiles = Array.from(document.querySelectorAll(".ptile"));
    if (tiles.length){
      const rnd = tiles[Math.floor(Math.random()*tiles.length)];
      rnd && rnd.click();
    }
    newGame();
    // Don't show welcome modal again - just start the game directly
  });

  on(byId("resetBtnStudy"), "click", resetBuilding);
  on(byId("resetBtnGame"), "click", resetBuilding);

  // Game Welcome Modal Functions
  function showGameWelcome() {
    const modal = byId("gameWelcomeModal");
    if (modal) {
      modal.classList.remove("hidden");
    } else {
      console.error('Game welcome modal not found!');
    }
  }

  function hideGameWelcome() {
    const modal = byId("gameWelcomeModal");
    if (modal) {
      modal.classList.add("hidden");
    } else {
      console.error('Game welcome modal not found!');
    }
  }

  function startGame() {
    hideGameWelcome();
    newGame();
    // Start the timer when game actually begins
    startTimer();
    // Add element reveal animation
    const currentElement = byId("currentPick");
    if (currentElement) {
      currentElement.classList.add("element-reveal");
      setTimeout(() => currentElement.classList.remove("element-reveal"), 1500);
    }
    // Hide start button and show game in progress
    byId("startGameBtn").classList.add("hidden");
  }

  // Game Control Functions
  function skipCurrentElectron() {
    if (state.queue.length > 0) {
      // Get the current electron from the front of the queue
      const currentElectron = state.queue[0];
      
      // Move it to the back of the queue
      state.queue.push(state.queue.shift());
      
      // Update the lobby display to show the new current electron
      spawnNextElectron();
      
      // Show feedback
      toast("Electron skipped - back in queue");
      
      console.log("Electron skipped, queue length:", state.queue.length);
    } else {
      toast("No electrons in queue to skip");
    }
  }

  function flipCurrentElectronSpin() {
    if (state.queue.length > 0) {
      // Get the current electron from the front of the queue
      const currentElectron = state.queue[0];
      
      // Flip the spin direction
      currentElectron.spin = currentElectron.spin === "up" ? "down" : "up";
      
      // Remember this spin preference for future electrons
      state.lastSpinPreference = currentElectron.spin;
      
      // Update the lobby display to show the flipped electron
      spawnNextElectron();
      
      // Show feedback
      toast(`Spin flipped to ${currentElectron.spin === "up" ? "↑" : "↓"}`);
      
      console.log("Spin flipped to:", currentElectron.spin);
    } else {
      toast("No electrons in queue to flip");
    }
  }

  // Game Welcome Modal Event Handlers
  on(byId("gameWelcomeClose"), "click", hideGameWelcome);
  on(byId("gameWelcomeStart"), "click", startGame);
  on(byId("startGameBtn"), "click", startGame);
  
  // Add backdrop click handler for welcome modal
  on(byId("gameWelcomeModal"), "click", (e) => {
    if (e.target.id === "gameWelcomeModal") {
      hideGameWelcome();
    }
  });

  // Game Control Button Event Handlers
  on(byId("skipBtn"), "click", skipCurrentElectron);
  on(byId("flipSpinBtn"), "click", flipCurrentElectronSpin);

  // Congratulations Modal Functions
  window.showCongratulations = function() {
    console.log('🎉 showCongratulations called!');
    
    try {
      stopTimer();
      console.log('Timer stopped');
      
      // Get current element info
      const currentPick = byId("currentPick");
      const elementName = currentPick ? currentPick.textContent : "this element";
      console.log('Element name:', elementName);
      
      // Update modal content
      const completedElement = byId("completedElement");
      const finalScore = byId("finalScore");
      const finalTime = byId("finalTime");
      const bestStreak = byId("bestStreak");
      
      if (completedElement) completedElement.textContent = elementName;
      if (finalScore) finalScore.textContent = state.score || 0;
      if (finalTime) finalTime.textContent = byId("timer").textContent || "00:00";
      if (bestStreak) bestStreak.textContent = state.streak || 0;
      
      console.log('Modal content updated');
      
      // Show the modal
      const modal = byId("congratulationsModal");
      if (modal) {
        console.log('Modal found, removing hidden class');
        modal.classList.remove("hidden");
        console.log('Modal should now be visible');
      } else {
        console.error('❌ Congratulations modal not found!');
        console.error('Available modals:', document.querySelectorAll('[id*="modal"]'));
      }
      
      // Hide start button since game is complete
      const startBtn = byId("startGameBtn");
      if (startBtn) {
        startBtn.classList.add("hidden");
        console.log('✅ Start button hidden');
      } else {
        console.log('⚠️ Start button not found');
      }
      

      
    } catch (error) {
      console.error('❌ Error in showCongratulations:', error);
      console.error('Error stack:', error.stack);
    }
  }

  function hideCongratulations() {
    byId("congratulationsModal").classList.add("hidden");
  }

  function startNextElement() {
    hideCongratulations();
    
    // Pick a random element for the next game
    const tiles = Array.from(document.querySelectorAll(".ptile"));
    if (tiles.length) {
      const rnd = tiles[Math.floor(Math.random() * tiles.length)];
      if (rnd) {
        rnd.click(); // This will trigger element selection
        newGame(); // Start new game with the new element
        showGameWelcome(); // Show welcome modal for new game
      }
    }
  }

  function restartSameElement() {
    hideCongratulations();
    newGame(); // Restart with the same element
    showGameWelcome(); // Show welcome modal
  }

  // Congratulations Modal Event Handlers
  on(byId("congratulationsClose"), "click", hideCongratulations);
  on(byId("nextElementBtn"), "click", startNextElement);
  on(byId("sameElementBtn"), "click", restartSameElement);
  
  // Add backdrop click handler for congratulations modal
  on(byId("congratulationsModal"), "click", (e) => {
    if (e.target.id === "congratulationsModal") {
      hideCongratulations();
    }
  });

  on(byId("helpBtn"), "click", ()=> openHelp(state.mode));
on(byId("helpClose"), "click", closeHelp);
on(byId("helpOk"), "click", closeHelp);
on(byId("tabStudy"), "click", ()=> openHelp("study"));
on(byId("tabGame"), "click", ()=> openHelp("game"));
on(byId("helpBackdrop"), "click", (e)=>{ if (e.target.id==="helpBackdrop") closeHelp(); });

// Version modal event listeners
on(byId("versionBtn"), "click", openVersion);
on(byId("versionClose"), "click", closeVersion);
on(byId("versionCloseBtn"), "click", closeVersion);
on(byId("versionModal"), "click", (e)=>{ if (e.target.id==="versionModal") closeVersion(); });
on(byId("backBtn"), "click", goBack);




  // Set up autoplay toggle functionality
  const autoPlayToggle = byId("autoPlayToggle");
  if (autoPlayToggle) {
    const input = autoPlayToggle.querySelector("input");
    if (input) {
      console.log("Setting up autoplay toggle");
      input.addEventListener("change", (e) => {
        console.log("Autoplay toggle changed:", e.target.checked);
        if (e.target.checked) {
          // Start autoplay
          if (state.autoTimer) clearAutoPlay();
          state.autoTimer = setInterval(() => {
            if (overCap()) {
              input.checked = false;
              clearAutoPlay();
              toast("Auto-play: configuration complete.");
              clearGhost();
              return;
            }
            const mv = ghostNextMove();
            if (!mv) {
              input.checked = false;
              clearAutoPlay();
              return;
            }
            const res = legalPlacement(mv.wing, mv.index, mv.spin);
            if (!res.ok) {
              input.checked = false;
              clearAutoPlay();
              toast(`${res.rule} prevented.`);
              return;
            }
            placeElectronInto(mv.wing, mv.index, mv.spin);
            refreshAufbauFocus();
            planStudyGhost();
          }, 800);
        } else {
          clearAutoPlay();
        }
      });
    } else {
      console.error("Could not find input in autoplay toggle");
    }
  } else {
    console.error("Could not find autoplay toggle");
  }

  on(byId("modeStudy"), "click", ()=>{ state.mode="study";
    byId("modeStudy").classList.add("active"); byId("modeGame").classList.remove("active");
    byId("studyControls").classList.remove("hidden"); byId("gameControls").classList.add("hidden");
    byId("studyActions").classList.remove("hidden"); byId("gameActions").classList.add("hidden");
    byId("lobbyBox").classList.add("hidden");
    byId("score").parentElement.classList.add("hidden"); // Hide scoreboard in study mode
    stopTimer(); clearAutoPlay(); resetBuilding(); planStudyGhost();
  });
  on(byId("modeGame"), "click", ()=>{ 
    state.mode="game";
    byId("modeGame").classList.add("active"); byId("modeStudy").classList.remove("active");
    byId("gameControls").classList.remove("hidden"); byId("studyControls").classList.add("hidden");
    byId("gameActions").classList.remove("hidden"); byId("studyActions").classList.add("hidden");
    byId("lobbyBox").classList.remove("hidden");
    byId("score").parentElement.classList.remove("hidden"); // Show scoreboard in game mode
    clearAutoPlay(); 
    
    // Automatically enable exceptions in game mode
    state.exceptionsEnabled = true;
    const exceptionsToggle = byId("exceptionsToggle");
    if (exceptionsToggle) {
      const input = exceptionsToggle.querySelector("input");
      if (input) {
        input.checked = true;
        toast("Exceptions automatically enabled for Game Mode");
      }
    }
    
    // Automatically select a random element when switching to game mode
    selectRandomElement();
    
    // Show welcome modal only on first switch to game mode
    if (!state.hasSeenGameWelcome) {
      showGameWelcome();
      state.hasSeenGameWelcome = true;
    } else {
      // If not first time, just start a new game directly
      newGame();
    }
  });

  // Initial element = Oxygen
  const initialTile = Array.from(document.querySelectorAll(".ptile")).find(t=>parseInt(t.dataset.z,10)===8);
  if (initialTile) initialTile.click();
  stopTimer(); clearAutoPlay();
  
  // Set initial scoreboard visibility (hidden in study mode by default)
  byId("score").parentElement.classList.add("hidden");

  // Readouts live via mutations
  const building = document.getElementById("building");
  if (building){
    const mo = new MutationObserver(()=> renderReadouts());
    mo.observe(building, {subtree:true, childList:true, characterData:true, attributes:true});
  }
  renderReadouts();
}

// Manual test function for congratulations modal
window.testCongratulations = () => {
  console.log('🧪 Manually testing congratulations modal...');
  if (typeof window.showCongratulations === 'function') {
    window.showCongratulations();
  } else {
    console.error('showCongratulations function not found');
  }
};

// Force show congratulations modal
window.forceShowCongratulations = () => {
  console.log('🚀 Force showing congratulations modal...');
  const modal = document.getElementById('congratulationsModal');
  if (modal) {
    // Remove all hidden states
    modal.classList.remove('hidden');
    modal.style.display = 'flex';
    modal.style.visibility = 'visible';
    modal.style.opacity = '1';
    modal.style.position = 'fixed';
    modal.style.zIndex = '2000';
    
    // Force reflow
    modal.offsetHeight;
    
    console.log('✅ Modal forced to be visible');
    console.log('Modal classes:', modal.className);
    console.log('Modal styles:', {
      display: modal.style.display,
      visibility: modal.style.visibility,
      opacity: modal.style.opacity,
      position: modal.style.position,
      zIndex: modal.style.zIndex
    });
  } else {
    console.error('❌ Modal not found');
  }
};

window.addEventListener("DOMContentLoaded", init);
  </script>

  <!-- Ionization removal fix: remove from highest n first (within same n: f>d>p>s) -->
  <script src="ion-fix-addon.js"></script>
</body>
</html>
